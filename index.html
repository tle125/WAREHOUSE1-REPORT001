

<!DOCTYPE html>
<html lang="th">
<head>
<link rel="icon" type="image/png" href="https://img.icons8.com/?size=64&id=xVnReHOxsQVt&format=png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Material handling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .pagination-btn { transition: background-color: 0.2s; }
        .pagination-btn-active { background-color: #2563eb; color: white; }
        .pagination-btn-inactive { background-color: white; color: #374151; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Refresh Button */
        .refresh-button {
          color: white;
          background-color: #222;
          font-weight: 500;
          border-radius: 0.5rem;
          font-size: 1rem;
          line-height: 2rem;
          padding-left: 2rem;
          padding-right: 2rem;
          padding-top: 0.7rem;
          padding-bottom: 0.7rem;
          cursor: pointer;
          text-align: center;
          margin-right: 0.5rem;
          display: inline-flex;
          align-items: center;
          border: none;
        }

        .refresh-button:hover {
          background-color: #333;
        }

        .refresh-button svg {
          display: inline;
          width: 1.3rem;
          height: 1.3rem;
          margin-right: 0.75rem;
          color: white;
        }

        .refresh-button:focus svg {
          animation: spin_357 0.5s linear;
        }
        
        /* Main Nav */
        .button-container {
          display: flex;
          background-color: rgb(27, 133, 219);
          width: 540px; /* Increased width for new button */
          height: 60px;
          align-items: center;
          justify-content: space-around;
          border-radius: 10px;
          box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px,
            rgba(27, 133, 219, 0.5) 5px 10px 15px;
        }

        .nav-button {
          outline: 0 !important;
          border: 0 !important;
          width: 80px;
          height: 100%;
          border-radius: 10px;
          background-color: transparent;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          color: #fff;
          transition: all ease-in-out 0.3s;
          cursor: pointer;
          padding: 4px 0;
        }

        .nav-button:hover {
          transform: translateY(-3px);
        }
        
        .nav-button.active {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .nav-text {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        @keyframes spin_357 {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }
        
        /* New Radio Tabs for RepairApp */
        .radio-input {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          background-color: #e2e8f0;
          padding: 4px;
          border-radius: 10px;
        }

        .radio-input input {
          display: none;
        }

        .radio-input .label {
          flex: 1 1 auto;
          min-width: 120px;
          height: 50px;
          background-color: #ffffff;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          transition: all 0.15s ease-in-out;
          cursor: pointer;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .radio-input .label:has(input[type="radio"]:checked) {
          background-color: #2563eb;
          box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        .radio-input .label .text {
          color: #334155;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.15s ease-in-out;
        }

        .radio-input .label:has(input[type="radio"]:checked) .text {
          color: white;
        }


        /* Mobile adjustments */
        @media (max-width: 768px) {
            body {
                padding-bottom: 80px; /* Space for bottom nav */
            }
            .header-container {
                position: relative;
                padding-top: 50px; /* Space for refresh button */
            }
            .refresh-button {
                position: absolute;
                top: 0;
                right: 0;
                padding: 0.5rem;
                width: 40px;
                height: 40px;
                border-radius: 50%;
            }
            .refresh-button .refresh-text {
                display: none;
            }
            .refresh-button svg {
                margin: 0;
                width: 1.5rem;
                height: 1.5rem;
            }
            .main-nav-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                padding: 10px 0;
                background-color: #f1f5f9; /* Match body background */
                display: flex;
                justify-content: center;
                border-top: 1px solid #e2e8f0;
            }
            .button-container {
                width: 100%;
                max-width: 540px;
            }
        }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
    
    <!-- Lottie Animation Player -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        window.firebase = { initializeApp, getFirestore, collection, getDocs, query, orderBy, getAuth, signInAnonymously };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';

        // ##################################################################
        // ### CONFIGURATIONS ###
        // ##################################################################
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwp0yu3ryGYYaaSIkTkOs64BFI3CYllPcQPJe3HcpldhPqHnggmmjTC1uSOV_xHLpUh/exec'; 
        
        const firebaseConfig = {
          apiKey: "AIzaSyAtlLnWd2Rkbx48Gt2LSrqLrtFr1a7A46w",
          authDomain: "tmtev-2025.firebaseapp.com",
          projectId: "tmtev-2025",
          storageBucket: "tmtev-2025.firebasestorage.app",
          messagingSenderId: "224826852272",
          appId: "1:224826852272:web:fd9c9805ea55747edc0c75",
          measurementId: "G-KYW1JLVFHX"
        };

        // ##################################################################
        // ### UTILITY FUNCTIONS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ###
        // ##################################################################
        const parseDate = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null;
            if (date.getFullYear() > 2200) { date.setFullYear(date.getFullYear() - 543); }
            return date;
        };
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'Invalid Date';
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        const formatSimpleDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'Invalid Date';
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const formatTime = (timeValue) => {
            if (!timeValue) return 'N/A';
            const date = new Date(timeValue);
            if (isNaN(date.getTime())) {
                return 'Invalid Time';
            }
            return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        };
        const formatNumber = (num, digits = 2) => {
            const number = Number(num);
            if (isNaN(number)) return '0.00';
            return number.toLocaleString('th-TH', { minimumFractionDigits: digits, maximumFractionDigits: digits });
        };
        const formatPrice = (price) => formatNumber(price, 2);
        const getThaiMonthName = (monthIndex) => ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'][monthIndex];
        const calculateTotalSparePartsPrice = (priceString) => {
            if (!priceString) return 0;
            return String(priceString).split(/[,;|+]/).map(p => parseFloat(p.trim())).filter(p => !isNaN(p)).reduce((sum, current) => sum + current, 0);
        };
        const calculateTotalCost = (item) => {
            const sparePartsPrice = calculateTotalSparePartsPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']);
            const servicePrice = parseFloat(String(item['‡∏£‡∏≤‡∏Ñ‡∏≤'])) || 0;
            return sparePartsPrice + servicePrice;
        };
        const sumDurations = (durations) => {
            if (!durations || durations.length === 0) return '00:00';
            const totalMinutes = durations.reduce((acc, duration) => {
                const minutes = parseInt(duration, 10) || 0;
                return acc + minutes;
            }, 0);

            if (totalMinutes === 0) return '00:00';

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };
        const processTypeData = (data) => {
            const stats = {};
            data.forEach(item => {
                const type = item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const cost = calculateTotalCost(item);
                const vehicleNumber = item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                if (!stats[type]) {
                    stats[type] = { count: 0, totalCost: 0, regNumbers: new Set(), vehicleDetails: {} };
                }

                stats[type].count++;
                stats[type].totalCost += cost;

                if (vehicleNumber !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    stats[type].regNumbers.add(vehicleNumber);

                    if (!stats[type].vehicleDetails[vehicleNumber]) {
                        stats[type].vehicleDetails[vehicleNumber] = { count: 0, totalCost: 0 };
                    }
                    stats[type].vehicleDetails[vehicleNumber].count++;
                    stats[type].vehicleDetails[vehicleNumber].totalCost += cost;
                }
            });

            Object.keys(stats).forEach(type => {
                stats[type].avgCost = stats[type].count > 0 ? stats[type].totalCost / stats[type].count : 0;
            });
            return stats;
        };
        const processVehicleData = (data) => {
            const stats = {};
            data.forEach(item => {
                const vehicleNumber = item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (vehicleNumber === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') return;
                const cost = calculateTotalCost(item);
                if (!stats[vehicleNumber]) {
                    stats[vehicleNumber] = { count: 0, totalCost: 0, items: [], types: {} };
                }
                stats[vehicleNumber].count++;
                stats[vehicleNumber].totalCost += cost;
                stats[vehicleNumber].items.push(item);
                const type = item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                stats[vehicleNumber].types[type] = (stats[vehicleNumber].types[type] || 0) + 1;
            });
            Object.keys(stats).forEach(vehicle => {
                stats[vehicle].avgCost = stats[vehicle].count > 0 ? stats[vehicle].totalCost / stats[vehicle].count : 0;
                let maxTypeCount = 0;
                let mostCommonType = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                Object.entries(stats[vehicle].types).forEach(([type, count]) => {
                    if (count > maxTypeCount) {
                        mostCommonType = type;
                        maxTypeCount = count;
                    }
                });
                stats[vehicle].mostCommonType = mostCommonType;
            });
            return stats;
        };
        
        // ##################################################################
        // ### SHARED COMPONENTS (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô) ###
        // ##################################################################
        const Icons = ({ name, className = "w-6 h-6" }) => {
            const iconPaths = {
                toolbox: <path strokeLinecap="round" strokeLinejoin="round" d="M21.75 9.75v2.25-2.25H2.25v2.25-2.25H21.75zM2.25 9.75v9.75a2.25 2.25 0 0 0 2.25 2.25h15a2.25 2.25 0 0 0 2.25-2.25V9.75m-19.5 0v-2.25a2.25 2.25 0 0 1 2.25-2.25h15a2.25 2.25 0 0 1 2.25 2.25v2.25m-15-4.5-3 3m15 0-3-3" />,
                bolt: <path strokeLinecap="round" strokeLinejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />,
                chevronDown: <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />,
                up: <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 10.5L12 3l7.5 7.5" />,
                down: <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 13.5L12 21l-7.5-7.5" />,
                balance: <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />,
                impact: <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1-8.414 1.414M2.25 18 18 2.25M12 21V9M15.75 21v-5.25M8.25 21v-5.25" />,
                calculator: <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm3-6h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm3-6h.008v.008H14.25v-.008zm0 3h.008v.008H14.25v-.008zM4.5 3.75v16.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V3.75m-15 0h15M4.5 3.75a2.25 2.25 0 012.25-2.25h10.5a2.25 2.25 0 012.25 2.25" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>{iconPaths[name]}</svg>;
        };
        const Loader = ({text}) => (
            <div className="flex flex-col justify-center items-center h-80 text-center">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600"></div>
                <p className="mt-4 text-lg text-gray-600">{text}</p>
            </div>
        );
        const SummaryCard = ({ title, value, unit, icon, color, footerText }) => (
            <div className={`bg-white p-5 rounded-xl shadow-md flex flex-col justify-between ${color.border} border-l-4`}>
                <div className="flex items-start space-x-4">
                    <div className={`p-3 rounded-full ${color.bg}`}>
                        <div className={color.icon}>{icon}</div>
                    </div>
                    <div>
                        <p className="text-sm font-medium text-gray-500">{title}</p>
                        <p className="text-2xl font-bold text-gray-800">{value} <span className="text-base font-medium">{unit}</span></p>
                    </div>
                </div>
                {footerText && <p className="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">{footerText}</p>}
            </div>
        );
        const BarChart = ({ data, color, title }) => {
            const maxValue = Math.max(...data.map(d => d.value), 0);
            return (
                <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                    <h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">{title}</h3>
                    <div className="mt-4 space-y-3">
                        {data.map((item, index) => (
                            <div key={index} className="chart-container flex items-center text-sm">
                                <div className="w-1/3 sm:w-1/4 font-medium truncate pr-2 text-slate-700">{item.label}</div>
                                <div className="w-2/3 sm:w-3/4 flex items-center">
                                    <div className={`chart-bar rounded-sm ${color}`} style={{ width: maxValue > 0 ? `${(item.value / maxValue) * 100}%` : '0%', height: '24px' }}></div>
                                    <span className="ml-2 whitespace-nowrap font-medium text-slate-700">{item.displayValue}</span>
                                </div>
                            </div>
                        ))}
                    </div>


                </div>
            );
        };
        const PaginatedDataTable = ({ title, data, columns }) => {
            const ITEMS_PER_PAGE = 10;
            const [currentPage, setCurrentPage] = useState(1);
            useEffect(() => { setCurrentPage(1); }, [data]);
            const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const currentData = data.slice(startIndex, endIndex);
            const goToPage = (page) => { setCurrentPage(Math.max(1, Math.min(page, totalPages))); };
            return (
                <div className="bg-white p-4 sm:p-6 rounded-xl shadow-md mt-6">
                    <h2 className="text-lg font-semibold text-gray-700 mb-4">{title}</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>{columns.map(col => <th key={col.key} scope="col" className="px-6 py-3">{col.label}</th>)}</tr>
                            </thead>
                            <tbody>
                                {currentData.map((row, index) => (
                                    <tr key={startIndex + index} className="bg-white border-b hover:bg-gray-50">
                                        {columns.map(col => (
                                            <td key={col.key} className="px-6 py-4 whitespace-nowrap">
                                                {col.render ? col.render(row[col.key], row, startIndex + index) : row[col.key]}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center mt-4 text-sm">
                            <span className="text-gray-600">‡∏´‡∏ô‡πâ‡∏≤ {currentPage} ‡∏à‡∏≤‡∏Å {totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                            <div className="flex items-center space-x-1">
                                <button onClick={() => goToPage(1)} disabled={currentPage === 1} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">¬´ ‡πÅ‡∏£‡∏Å</button>
                                <button onClick={() => goToPage(currentPage - 1)} disabled={currentPage === 1} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">‚Äπ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                                <button onClick={() => goToPage(currentPage + 1)} disabled={currentPage === totalPages} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Ä∫</button>
                                <button onClick={() => goToPage(totalPages)} disabled={currentPage === totalPages} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ¬ª</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ##################################################################
        // ### REPAIR APP SUB-COMPONENTS (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°) ###
        // ##################################################################
        const RepairTableRow = ({ item, index }) => {
            const totalCost = calculateTotalCost(item);
            return (
                <tr className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 text-sm">
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-600">{index}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-800 font-medium">{item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à(APP)'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right text-slate-700">{formatPrice(calculateTotalSparePartsPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']))}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right text-slate-700">{formatPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right font-bold text-emerald-600">{formatPrice(totalCost)}</td>
                </tr>
            );
        };
        const RepairCard = ({ item, index }) => {
            const totalCost = calculateTotalCost(item);
            const sparePartsPrice = calculateTotalSparePartsPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']);
            const servicePrice = parseFloat(String(item['‡∏£‡∏≤‡∏Ñ‡∏≤'])) || 0;
            return (
                <div className="mobile-card border border-gray-200 rounded-lg mb-4 p-4 bg-white shadow">
                    <div className="flex justify-between items-center mb-2">
                        <div className="font-semibold text-slate-800">#{index} - {item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']}</div>
                        <div className="text-right"><div className="font-bold text-emerald-600">{formatPrice(totalCost)}</div><div className="text-xs text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div></div>
                    </div>
                    <div className="mb-2 text-sm"><div className="font-medium text-slate-700">{item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°']}</div><div className="text-blue-600 font-medium">{item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</div></div>
                    <div className="grid grid-cols-2 gap-1 text-xs text-gray-600 mb-2"><div>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°: {formatDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'])}</div><div>‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à: {formatDate(item['‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à(APP)'])}</div></div>
                    <div className="bg-gray-50 p-2 rounded text-xs"><div className="flex justify-between"><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà:</span> <span>{formatPrice(sparePartsPrice)}</span></div><div className="flex justify-between"><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡πà‡∏≠‡∏°:</span> <span>{formatPrice(servicePrice)}</span></div></div>
                </div>
            );
        };
        const MonthGroupSection = ({ group, isMobile, onToggle, isExpanded }) => {
            const monthName = getThaiMonthName(group.month) + ' ' + group.year;
            return (
                <div className="mb-4 bg-white rounded-lg shadow-md overflow-hidden">
                    <div onClick={onToggle} className="month-header bg-blue-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-blue-100 transition-colors duration-200">
                        <div className="flex items-center">
                            <span className={`transform transition-transform duration-200 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 mr-2 text-blue-600" /></span>
                            <h3 className="font-semibold text-blue-800">{monthName}</h3>
                        </div>
                        <div className="text-sm text-slate-700"><span className="font-semibold text-slate-800">{group.items.length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | <span className="font-semibold text-slate-800">{formatPrice(group.totalPrice)}</span> ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div className={`month-content transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                        <div className="p-0 sm:p-0">
                            {isMobile ? (<div className="p-2">{group.items.map((item, idx) => <RepairCard key={item['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà']} item={item} index={idx + 1}/>)}</div>) 
                            : (<div className="overflow-x-auto"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡πà‡∏≠‡∏°</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead><tbody>{group.items.map((item, idx) => <RepairTableRow key={item['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà']} item={item} index={idx + 1}/>)}</tbody></table></div>)}
                        </div>
                    </div>
                </div>
            );
        };
        const AllDataTab = ({ data, isMobile }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('');
            const [filterYear, setFilterYear] = useState('');
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const { uniqueTypes, uniqueYears } = useMemo(() => {
                const types = new Set(); const years = new Set();
                data.forEach(item => { if (item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) types.add(item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó); const date = new Date(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); });
                return { uniqueTypes: Array.from(types).sort(), uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);
            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const date = new Date(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']);
                    const itemYear = !isNaN(date.getTime()) ? date.getFullYear().toString() : '';
                    const matchesSearch = searchTerm === '' || Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesType = filterType === '' || item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó === filterType;
                    const matchesYear = filterYear === '' || itemYear === filterYear;
                    return matchesSearch && matchesType && matchesYear;
                });
            }, [data, searchTerm, filterType, filterYear]);
            const groupDataByMonth = (data) => {
                const grouped = {};
                const sortedData = [...data].sort((a, b) => (parseDate(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']) || 0) - (parseDate(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']) || 0));
                sortedData.forEach(item => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!date) return;
                    const year = date.getFullYear(); const month = date.getMonth(); const key = `${year}-${month}`;
                    if (!grouped[key]) { grouped[key] = { items: [], totalPrice: 0, year, month }; }
                    grouped[key].items.push(item); grouped[key].totalPrice += calculateTotalCost(item);
                });
                return grouped;
            };
            const groupedData = useMemo(() => Object.entries(groupDataByMonth(filteredData)).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1])), [filteredData]);
            const toggleMonth = (monthKey) => setExpandedMonths(prev => { const newSet = new Set(prev); if (newSet.has(monthKey)) newSet.delete(monthKey); else newSet.add(monthKey); return newSet; });
            const totalCost = useMemo(() => filteredData.reduce((sum, item) => sum + calculateTotalCost(item), 0), [filteredData]);

            // Calculate yearly totals for summary cards
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            const currentYearTotal = useMemo(() => {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    return 0;
                }
                
                const currentYearData = data.filter(item => {
                    const dateStr = item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'];
                    if (!dateStr) return false;
                    
                    const parsedDate = parseDate(dateStr);
                    if (!parsedDate) return false;
                    
                    const itemYear = parsedDate.getFullYear();
                    return itemYear === currentYear;
                });
                
                return currentYearData.reduce((sum, item) => {
                    return sum + calculateTotalCost(item);
                }, 0);
            }, [data, currentYear]);
            
            const lastYearTotal = useMemo(() => {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    return 0;
                }
                
                const lastYearData = data.filter(item => {
                    const dateStr = item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'];
                    if (!dateStr) return false;
                    
                    const parsedDate = parseDate(dateStr);
                    if (!parsedDate) return false;
                    
                    const itemYear = parsedDate.getFullYear();
                    return itemYear === lastYear;
                });
                
                return lastYearData.reduce((sum, item) => {
                    return sum + calculateTotalCost(item);
                }, 0);
            }, [data, lastYear]);
            
            const yearlyDifference = currentYearTotal - lastYearTotal;
            const yearlyPercentChange = lastYearTotal > 0 ? ((yearlyDifference / lastYearTotal) * 100) : 0;

            const searchColumns = [
                { key: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà', label: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà', render: (val, row, index) => index + 1 },
                { key: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ' },
                { key: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', label: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°' },
                { key: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' },
                { key: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)', label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°', render: (val) => formatDate(val) },
                { key: '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à(APP)', label: '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à', render: (val) => formatDate(val) },
                { key: '‡∏£‡∏≤‡∏Ñ‡∏≤', label: '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°', render: (val) => formatPrice(val) },
                { key: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', label: '‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', render: (val) => formatPrice(calculateTotalSparePartsPrice(val)) },
                { key: 'total', label: '‡∏£‡∏ß‡∏°', render: (val, row) => formatPrice(calculateTotalCost(row)) },
            ];

            return (
                <div>
                    {/* Yearly Summary Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <SummaryCard
                            title={`‡∏¢‡∏≠‡∏î‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏µ ${currentYear}`}
                            value={formatPrice(currentYearTotal)}
                            unit="‡∏ö‡∏≤‡∏ó"
                            icon="üìä"
                            color="blue"
                        />
                        <SummaryCard
                            title={`‡∏¢‡∏≠‡∏î‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏µ ${lastYear}`}
                            value={formatPrice(lastYearTotal)}
                            unit="‡∏ö‡∏≤‡∏ó"
                            icon="üìà"
                            color="gray"
                        />
                        <SummaryCard
                            title="‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á"
                            value={formatPrice(Math.abs(yearlyDifference))}
                            unit="‡∏ö‡∏≤‡∏ó"
                            icon={yearlyDifference >= 0 ? "üìà" : "üìâ"}
                            color={yearlyDifference >= 0 ? "red" : "green"}
                            subtitle={yearlyDifference >= 0 ? "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô" : "‡∏•‡∏î‡∏•‡∏á"}
                        />
                        <SummaryCard
                            title="% ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"
                            value={Math.abs(yearlyPercentChange).toFixed(1)}
                            unit="%"
                            icon={yearlyPercentChange >= 0 ? "üìà" : "üìâ"}
                            color={yearlyPercentChange >= 0 ? "red" : "green"}
                            subtitle={yearlyPercentChange >= 0 ? "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô" : "‡∏•‡∏î‡∏•‡∏á"}
                        />
                    </div>
                    
                    <div className="mb-4 sm:mb-6">
                        <div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
                            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto" />
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"><option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>{uniqueTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                            <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"><option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                        </div>
                    </div>
                    
                    {searchTerm ? (
                        <PaginatedDataTable
                            title={`‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${searchTerm}"`}
                            data={filteredData}
                            columns={searchColumns}
                        />
                    ) : (
                        <div id="monthlyDataContainer">
                            {groupedData.length > 0 ? groupedData.map(([key, group]) => (<MonthGroupSection key={key} group={group} isMobile={isMobile} isExpanded={expandedMonths.has(key)} onToggle={() => toggleMonth(key)} />)) : <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>}
                        </div>
                    )}

                    <div className="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 text-sm sm:text-base">
                        <div><span className="font-semibold">{filteredData.length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <span className="font-semibold">{formatPrice(totalCost)}</span> ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                </div>
            );
        };
        const WeeklyTab = ({ data, isMobile }) => {
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [selectedWeek, setSelectedWeek] = useState(null);
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            const groupDataByWeek = (data, year, month) => {
                const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const weeks = [];
                let currentWeekStart = new Date(firstDay); currentWeekStart.setDate(currentWeekStart.getDate() - firstDay.getDay());
                while (currentWeekStart <= lastDay) { const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); weeks.push({ start: new Date(currentWeekStart), end: new Date(weekEnd), items: [] }); currentWeekStart.setDate(currentWeekStart.getDate() + 7); }
                data.forEach(item => { const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!date) return; for (const week of weeks) { const weekEndMidnight = new Date(week.end); weekEndMidnight.setHours(23, 59, 59, 999); if (date >= week.start && date <= weekEndMidnight) { week.items.push(item); break; } } });
                return weeks.filter(w => w.items.length > 0);
            };
            const { weeklyReport, monthData } = useMemo(() => {
                const filtered = data.filter(item => { const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); return date && date.getFullYear() === year && date.getMonth() === month; });
                return { weeklyReport: groupDataByWeek(filtered, year, month), monthData: filtered };
            }, [data, year, month]);
            const monthlyTotalCount = monthData.length;
            const monthlyTotalPrice = monthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
            const weeklyAvgCount = weeklyReport.length > 0 ? (monthlyTotalCount / weeklyReport.length) : 0;
            const weeklyAvgPrice = weeklyReport.length > 0 ? (monthlyTotalPrice / weeklyReport.length) : 0;
            if (selectedWeek) {
                const typeDataForWeek = processTypeData(selectedWeek.items);
                const sortedTypesByCount = Object.entries(typeDataForWeek).sort(([, a], [, b]) => b.count - a.count);
                const sortedTypesByPrice = Object.entries(typeDataForWeek).sort(([, a], [, b]) => b.totalCost - a.totalCost);
                const countChartData = sortedTypesByCount.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.count, displayValue: `${stats.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á` }));
                const priceChartData = sortedTypesByPrice.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
                return (<div><h3 className="font-semibold text-lg mb-2 text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà {weeklyReport.findIndex(w => w.start.getTime() === selectedWeek.start.getTime()) + 1}<span className="text-sm font-normal text-gray-600 ml-2">({formatDate(selectedWeek.start.toISOString())} - {formatDate(selectedWeek.end.toISOString())})</span></h3><div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6"><BarChart data={countChartData} color="bg-blue-500" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Top 10)" /><BarChart data={priceChartData} color="bg-green-500" title="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Top 10)" /></div><h3 className="font-semibold text-lg mb-3 text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>{isMobile ? (<div>{selectedWeek.items.map((item, idx) => <RepairCard key={item['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà']} item={item} index={idx+1} />)}</div>) : (<div className="overflow-x-auto bg-white rounded-lg shadow-md p-4"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead><tbody>{selectedWeek.items.map((item, idx) => (<tr key={item['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà']} className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 text-sm"><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{idx + 1}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-800 font-medium">{item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'])}</td><td className="border-b border-gray-200 px-4 py-3 text-right font-bold text-emerald-600">{formatPrice(calculateTotalCost(item))}</td></tr>))}</tbody></table></div>)}<button onClick={() => setSelectedWeek(null)} className="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button></div>)
            }
            return (<div><div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2"><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select><select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6"><SummaryCard title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={monthlyTotalCount} color={{bg: 'bg-blue-100', text: 'text-blue-800'}} /><SummaryCard title="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={formatPrice(monthlyTotalPrice)} unit="‡∏ö‡∏≤‡∏ó" color={{bg: 'bg-green-100', text: 'text-green-800'}} /><SummaryCard title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" value={weeklyAvgCount.toFixed(1)} color={{bg: 'bg-purple-100', text: 'text-purple-800'}} /><SummaryCard title="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" value={formatPrice(weeklyAvgPrice)} unit="‡∏ö‡∏≤‡∏ó" color={{bg: 'bg-amber-100', text: 'text-amber-800'}} /></div>{weeklyReport.length === 0 ? <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div> : (<div className="bg-white rounded-lg shadow-md p-3 sm:p-4"><h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>{isMobile ? (<div className="space-y-3">{weeklyReport.map((week, index) => { const totalCost = week.items.reduce((sum, item) => sum + calculateTotalCost(item), 0); return (<div key={index} onClick={() => setSelectedWeek(week)} className="mobile-card border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-100/80 shadow-sm"><div className="flex justify-between items-center mb-1"><div className="font-semibold text-slate-800">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà {index + 1}</div><div className="text-right font-bold text-blue-800">{formatPrice(totalCost)}</div></div><div className="text-xs text-slate-500 mb-2">{formatDate(week.start.toISOString())} - {formatDate(week.end.toISOString())}</div><div className="text-sm text-slate-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span className="font-semibold text-slate-900">{week.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div></div>)})}</div>) : (<div className="overflow-x-auto"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-center text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th className="border-b-2 border-gray-200 px-4 py-3 text-center text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th></tr></thead><tbody>{weeklyReport.map((week, index) => { const totalCost = week.items.reduce((sum, item) => sum + calculateTotalCost(item), 0); return (<tr key={index} onClick={() => setSelectedWeek(week)} className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 cursor-pointer text-sm"><td className="border-b border-gray-200 px-4 py-3 text-center font-medium text-slate-700">{index + 1}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-800">{formatDate(week.start.toISOString())} - {formatDate(week.end.toISOString())}</td><td className="border-b border-gray-200 px-4 py-3 text-center text-slate-800 font-bold">{week.items.length}</td><td className="border-b border-gray-200 px-4 py-3 text-right font-semibold text-blue-800">{formatPrice(totalCost)}</td></tr>)})}</tbody></table></div>)}</div>)}</div>);
        };
        const TypeTab = ({ data, isMobile }) => {
            const [period, setPeriod] = useState('all');
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [expandedTypes, setExpandedTypes] = useState(new Set());
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            
            const typeData = useMemo(() => {
                let filteredData = data;
                if (period === 'year') { filteredData = data.filter(item => { const d = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); return d && d.getFullYear() === year; }); } 
                else if (period === 'month') { filteredData = data.filter(item => { const d = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); return d && d.getFullYear() === year && d.getMonth() === month; }); }
                return processTypeData(filteredData);
            }, [data, period, year, month]);

            const sortedTypes = useMemo(() => Object.entries(typeData).sort(([, a], [, b]) => b.count - a.count), [typeData]);
            const totalItems = useMemo(() => sortedTypes.reduce((sum, [, stats]) => sum + stats.count, 0), [sortedTypes]);
            const totalPrice = useMemo(() => sortedTypes.reduce((sum, [, stats]) => sum + stats.totalCost, 0), [sortedTypes]);
            const countChartData = sortedTypes.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.count, displayValue: `${stats.count}` }));
            const priceChartData = [...sortedTypes].sort(([,a], [,b]) => b.totalCost - a.totalCost).slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
            const toggleType = (type) => setExpandedTypes(prev => { const newSet = new Set(prev); if (newSet.has(type)) newSet.delete(type); else newSet.add(type); return newSet; });

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={period} onChange={e => setPeriod(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option><option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option></select>
                        {period === 'year' && (<select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>)}
                        {period === 'month' && (<><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select><select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select></>)}
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                        <SummaryCard title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°" value={sortedTypes.length} color={{bg: 'bg-blue-100', text: 'text-blue-800'}} />
                        <SummaryCard title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={totalItems} color={{bg: 'bg-green-100', text: 'text-green-800'}} />
                        <SummaryCard title="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={formatPrice(totalPrice)} unit="‡∏ö‡∏≤‡∏ó" color={{bg: 'bg-purple-100', text: 'text-purple-800'}} />
                        <SummaryCard title="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" value={formatPrice(totalItems > 0 ? totalPrice / totalItems : 0)} unit="‡∏ö‡∏≤‡∏ó" color={{bg: 'bg-amber-100', text: 'text-amber-800'}} />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                        <BarChart data={countChartData} color="bg-blue-500" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Top 10)" />
                        <BarChart data={priceChartData} color="bg-green-500" title="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Top 10)" />
                    </div>
                    <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                        <h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>
                        <div className="space-y-2">
                             {sortedTypes.map(([type, stats]) => {
                                const isExpanded = expandedTypes.has(type);
                                const sortedVehicles = Object.entries(stats.vehicleDetails).sort(([,a],[,b]) => b.totalCost - a.totalCost);
                                return (
                                    <div key={type} className="border rounded-lg overflow-hidden bg-white">
                                        <div onClick={() => toggleType(type)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                            <div className="flex items-center">
                                                <span className={`transform transition-transform duration-200 mr-2 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-slate-500" /></span>
                                                <h4 className="font-semibold text-blue-800">{type}</h4>
                                            </div>
                                            <div className="text-sm text-right">
                                                <div><span className="font-semibold">{stats.count}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / <span className="font-semibold">{stats.regNumbers.size}</span> ‡∏Ñ‡∏±‡∏ô</div>
                                                <div className="font-bold text-emerald-600">{formatPrice(stats.totalCost)} ‡∏ö‡∏≤‡∏ó</div>
                                            </div>
                                        </div>
                                        <div className={`transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                            <div className="p-4 bg-slate-50/70 border-t">
                                                <h5 className="font-medium mb-2 text-slate-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏ñ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ:</h5>
                                                <div className="overflow-x-auto border rounded-md">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-200">
                                                            <tr>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {sortedVehicles.map(([vehicle, details]) => (
                                                                <tr key={vehicle} className="border-t bg-white">
                                                                    <td className="px-3 py-2 font-medium text-slate-700">{vehicle}</td>
                                                                    <td className="px-3 py-2 text-right text-slate-600">{details.count}</td>
                                                                    <td className="px-3 py-2 text-right text-slate-600">{formatPrice(details.totalCost)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        const VehicleTab = ({ data, isMobile }) => {
            const [period, setPeriod] = useState('all');
            const [sortBy, setSortBy] = useState('plate_asc');
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [expandedVehicles, setExpandedVehicles] = useState(new Set());
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            
            const vehicleData = useMemo(() => {
                let filteredData = data;
                if (period === 'year') { filteredData = data.filter(item => { const d = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); return d && d.getFullYear() === year; }); } 
                else if (period === 'month') { filteredData = data.filter(item => { const d = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']); return d && d.getFullYear() === year && d.getMonth() === month; }); }
                return processVehicleData(filteredData);
            }, [data, period, year, month]);

            const sortedVehicles = useMemo(() => Object.entries(vehicleData).sort(([keyA, statsA], [keyB, statsB]) => {
                const customPlateSort = (a, b) => {
                    const partsA = a.split(/[- ]/);
                    const partsB = b.split(/[- ]/);
                    const prefixA = partsA[0];
                    const prefixB = partsB[0];
                    const numA = parseInt(partsA[1], 10) || 0;
                    const numB = parseInt(partsB[1], 10) || 0;

                    const getPrefixPriority = (prefix) => {
                        if (prefix === 'FL') return 1;
                        if (prefix === 'TT') return 2;
                        if (prefix === 'TTL') return 3;
                        return 4;
                    };

                    const priorityA = getPrefixPriority(prefixA);
                    const priorityB = getPrefixPriority(prefixB);

                    if (priorityA !== priorityB) {
                        return priorityA - priorityB;
                    }
                    
                    if (prefixA !== prefixB) {
                        return prefixA.localeCompare(prefixB);
                    }

                    return numA - numB;
                };

                switch (sortBy) {
                    case 'count_desc':
                        return statsB.count - statsA.count;
                    case 'count_asc':
                        return statsA.count - statsB.count;
                    case 'price_desc':
                        return statsB.totalCost - statsA.totalCost;
                    case 'price_asc':
                        return statsA.totalCost - statsB.totalCost;
                    case 'plate_asc':
                    default:
                        return customPlateSort(keyA, keyB);
                }
            }), [vehicleData, sortBy]);

            const countChartData = [...sortedVehicles].sort(([,a],[,b])=>b.count - a.count).slice(0, 10).map(([vehicle, stats]) => ({ label: vehicle, value: stats.count, displayValue: `${stats.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á` }));
            const priceChartData = [...sortedVehicles].sort(([,a],[,b])=>b.totalCost - a.totalCost).slice(0, 10).map(([vehicle, stats]) => ({ label: vehicle, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
            const toggleVehicle = (vehicle) => setExpandedVehicles(prev => { const newSet = new Set(prev); if (newSet.has(vehicle)) newSet.delete(vehicle); else newSet.add(vehicle); return newSet; });

            const SparePartsList = ({ item }) => {
                const parts = item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô']?.split(/[+,]/).map(p => p.trim()).filter(Boolean) || [];
                const prices = String(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] || '').split(/[,;|+]/).map(p => p.trim()).filter(Boolean);

                if (parts.length === 0 && prices.length === 0) {
                    return <span className="text-slate-500">-</span>;
                }

                return (
                    <div className="space-y-1 text-xs">
                        {parts.map((part, index) => (
                            <div key={index} className="flex justify-between items-center">
                                <span className="text-slate-700">{part}</span>
                                <span className="font-medium text-slate-800">{formatPrice(prices[index] || 0)}</span>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={period} onChange={e => setPeriod(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option><option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option></select>
                        {period !== 'all' && (<><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>{period === 'month' && (<select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select>)}</>)}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                        <BarChart data={countChartData} color="bg-blue-500" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (Top 10)" />
                        <BarChart data={priceChartData} color="bg-green-500" title="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Top 10)" />
                    </div>
                    <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                        <div className="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 className="font-semibold text-base sm:text-lg text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ñ</h3>
                            <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="plate_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)</option>
                                <option value="count_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                <option value="count_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)</option>
                                <option value="price_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                <option value="price_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)</option>
                            </select>
                        </div>
                        <div className="space-y-2">
                            {sortedVehicles.map(([vehicle, stats]) => {
                                const isExpanded = expandedVehicles.has(vehicle);
                                return (
                                    <div key={vehicle} className="border rounded-lg overflow-hidden bg-white">
                                        <div onClick={() => toggleVehicle(vehicle)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                            <div>
                                                <h4 className="font-semibold text-blue-800">{vehicle}</h4>
                                                <div className="text-xs text-slate-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡∏ö‡πà‡∏≠‡∏¢: {stats.mostCommonType}</div>
                                            </div>
                                            <div className="text-sm text-right">
                                                <div><span className="font-semibold">{stats.count}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                                                <div className="font-bold text-emerald-600">{formatPrice(stats.totalCost)} ‡∏ö‡∏≤‡∏ó</div>
                                            </div>
                                        </div>
                                        <div className={`transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                            <div className="p-4 bg-slate-50/70 border-t">
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-200">
                                                            <tr>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</th>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {stats.items.map((item, index) => (
                                                                <tr key={index} className="border-t bg-white">
                                                                    <td className="px-3 py-2 align-top text-slate-600 whitespace-nowrap">{formatDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'])}</td>
                                                                    <td className="px-3 py-2 align-top">
                                                                        <div className="font-medium text-slate-800">{item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°']}</div>
                                                                        <div className="text-xs text-blue-600">{item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</div>
                                                                    </td>
                                                                    <td className="px-3 py-2 align-top w-1/3">
                                                                        <SparePartsList item={item} />
                                                                    </td>
                                                                    <td className="px-3 py-2 align-top text-right font-semibold text-emerald-700">{formatPrice(calculateTotalCost(item))}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        const ComparisonTab = ({ data }) => {
            const today = new Date();
            const [selectedVehicle, setSelectedVehicle] = useState('');
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(today.getMonth());

            const { uniqueVehicles, uniqueYears } = useMemo(() => {
                const vehicles = new Set();
                const years = new Set();
                data.forEach(item => {
                    if (item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']) vehicles.add(item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']);
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']);
                    if (date) years.add(date.getFullYear());
                });
                return {
                    uniqueVehicles: Array.from(vehicles).sort(),
                    uniqueYears: Array.from(years).sort((a, b) => b - a)
                };
            }, [data]);

            const comparisonData = useMemo(() => {
                if (!selectedVehicle) return null;

                const vehicleData = data.filter(item => item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] === selectedVehicle);

                const currentMonthData = vehicleData.filter(item => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']);
                    return date && date.getFullYear() === selectedYear && date.getMonth() === selectedMonth;
                });
                const currentMonthTotal = currentMonthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);

                const prevMonthDate = new Date(selectedYear, selectedMonth, 1);
                prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
                const prevMonth = prevMonthDate.getMonth();
                const prevYear = prevMonthDate.getFullYear();

                const previousMonthData = vehicleData.filter(item => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']);
                    return date && date.getFullYear() === prevYear && date.getMonth() === prevMonth;
                });
                const previousMonthTotal = previousMonthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                
                const difference = currentMonthTotal - previousMonthTotal;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                const percentageChange = previousMonthTotal > 0 
                    ? ((currentMonthTotal - previousMonthTotal) / previousMonthTotal) * 100 
                    : 0;

                return {
                    currentMonthData,
                    previousMonthData,
                    currentMonthTotal,
                    previousMonthTotal,
                    difference,
                    percentageChange,
                    prevMonth,
                    prevYear
                };
            }, [data, selectedVehicle, selectedYear, selectedMonth]);

            const RepairDetailTable = ({ title, items }) => (
                <div>
                    <h3 className="text-md font-semibold text-slate-700 mb-2">{title}</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.length > 0 ? items.map((item, index) => (
                                    <tr key={index} className="border-t">
                                        <td className="px-4 py-2 text-slate-600 whitespace-nowrap">{formatDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)'])}</td>
                                        <td className="px-4 py-2 text-slate-700">{item['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°']}</td>
                                        <td className="px-4 py-2 text-slate-600">{item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</td>
                                        <td className="px-4 py-2 text-right font-semibold text-emerald-700">{formatPrice(calculateTotalCost(item))}</td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="4" className="text-center py-4 text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedVehicle} onChange={e => setSelectedVehicle(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ --</option>
                            {uniqueVehicles.map(v => <option key={v} value={v}>{v}</option>)}
                        </select>
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][i]}</option>)}
                        </select>
                    </div>

                    {!selectedVehicle ? (
                        <div className="text-center py-12 text-gray-500 bg-white rounded-lg shadow">
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                        </div>
                    ) : (
                        <div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <SummaryCard 
                                    title={`‡∏¢‡∏≠‡∏î‡∏ã‡πà‡∏≠‡∏° ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][selectedMonth]} ${selectedYear + 543}`}
                                    value={formatPrice(comparisonData.currentMonthTotal)}
                                    unit="‡∏ö‡∏≤‡∏ó"
                                    icon={<Icons name="balance" />}
                                    color={{ bg: 'bg-blue-100', icon: 'text-blue-600', border: 'border-blue-500' }}
                                />
                                <SummaryCard 
                                    title={`‡∏¢‡∏≠‡∏î‡∏ã‡πà‡∏≠‡∏° ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][comparisonData.prevMonth]} ${comparisonData.prevYear + 543}`}
                                    value={formatPrice(comparisonData.previousMonthTotal)}
                                    unit="‡∏ö‡∏≤‡∏ó"
                                    icon={<Icons name="balance" />}
                                    color={{ bg: 'bg-gray-100', icon: 'text-gray-600', border: 'border-gray-400' }}
                                />
                                <SummaryCard 
                                    title="‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á"
                                    value={formatPrice(comparisonData.difference)}
                                    unit="‡∏ö‡∏≤‡∏ó"
                                    icon={comparisonData.difference >= 0 ? <Icons name="up"/> : <Icons name="down"/>}
                                    color={comparisonData.difference >= 0 ? 
                                        { bg: 'bg-red-100', icon: 'text-red-600', border: 'border-red-500' } : 
                                        { bg: 'bg-green-100', icon: 'text-green-600', border: 'border-green-500' }}
                                />
                                <SummaryCard 
                                    title="% ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"
                                    value={Math.abs(comparisonData.percentageChange).toFixed(1)}
                                    unit="%"
                                    icon={comparisonData.percentageChange >= 0 ? <Icons name="up"/> : <Icons name="down"/>}
                                    color={comparisonData.percentageChange >= 0 ? 
                                        { bg: 'bg-red-100', icon: 'text-red-600', border: 'border-red-500' } : 
                                        { bg: 'bg-green-100', icon: 'text-green-600', border: 'border-green-500' }}
                                    footer={`‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][comparisonData.prevMonth]} ${comparisonData.prevYear + 543}`}
                                />
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <RepairDetailTable title={`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][selectedMonth]}`} items={comparisonData.currentMonthData} />
                                <RepairDetailTable title={`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][comparisonData.prevMonth]}`} items={comparisonData.previousMonthData} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // ##################################################################
        // ### REPAIR APP MAIN COMPONENT (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°) ###
        // ##################################################################
        const RepairApp = ({ data, isMobile }) => {
            const [activeTab, setActiveTab] = useState('all');
            const tabConfig = [ 
                { id: 'all', label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' }, 
                { id: 'weekly', label: '‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' }, 
                { id: 'type', label: '‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' }, 
                { id: 'vehicle', label: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ñ' },
                { id: 'comparison', label: '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô' }
            ];
            const renderContent = () => {
                if (!data || data.length === 0) return <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</div>;
                switch (activeTab) {
                    case 'all': return <AllDataTab data={data} isMobile={isMobile} />;
                    case 'weekly': return <WeeklyTab data={data} isMobile={isMobile} />;
                    case 'type': return <TypeTab data={data} isMobile={isMobile} />;
                    case 'vehicle': return <VehicleTab data={data} isMobile={isMobile} />;
                    case 'comparison': return <ComparisonTab data={data} />;
                    default: return null;
                }
            };
            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <div className="radio-input mb-4 sm:mb-6">
                        {tabConfig.map(tab => (
                            <label className="label" key={tab.id}>
                                <input
                                    value={tab.id}
                                    name="repair-tab-radio"
                                    id={`tab-${tab.id}`}
                                    type="radio"
                                    checked={activeTab === tab.id}
                                    onChange={() => setActiveTab(tab.id)}
                                />
                                <span className="text">{tab.label}</span>
                            </label>
                        ))}
                    </div>
                    {renderContent()}
                </div>
            );
        };
        
        // ##################################################################
        // ### FUEL APP COMPONENTS (START) ###
        // ##################################################################
        const FuelLast7DaysTab = ({ fuelOutData, fuelInData }) => {
            const [expandedDates, setExpandedDates] = useState(new Set());

            const { groupedByDate, chartData } = useMemo(() => {
                const today = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(today.getDate() - 7);

                const filterAndSortData = (data, type) =>
                    (data || [])
                        .filter(item => {
                            const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                            return date && date >= sevenDaysAgo && date <= today;
                        })
                        .map(item => ({ ...item, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: type }));

                const filteredOut = filterAndSortData(fuelOutData, '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å');
                const filteredIn = filterAndSortData(fuelInData, '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
                const allData = [...filteredOut, ...filteredIn];

                const grouped = allData.reduce((acc, item) => {
                    const dateKey = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).toLocaleString('sv-SE', { timeZone: 'Asia/Bangkok' }).split(' ')[0];
                    if (!acc[dateKey]) {
                        acc[dateKey] = { items: [], totalOut: 0, totalIn: 0 };
                    }
                    acc[dateKey].items.push(item);
                    if(item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å') {
                        acc[dateKey].totalOut += parseFloat(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    } else {
                        acc[dateKey].totalIn += parseFloat(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    }
                    return acc;
                }, {});

                const sortedGrouped = Object.entries(grouped).sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA));

                const vehicleStats = {};
                filteredOut.forEach(item => {
                    const plate = item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const cost = parseFloat(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    if (!vehicleStats[plate]) vehicleStats[plate] = { total: 0, count: 0 };
                    vehicleStats[plate].total += cost;
                    vehicleStats[plate].count++;
                });

                const finalChartData = Object.entries(vehicleStats).map(([plate, stats]) => ({
                    label: plate,
                    value: stats.total,
                    displayValue: formatPrice(stats.total)
                })).sort((a, b) => b.value - a.value);

                return { groupedByDate: sortedGrouped, chartData: finalChartData };
            }, [fuelOutData, fuelInData]);

            useEffect(() => {
                if (groupedByDate.length > 0) {
                    const latestDateKey = groupedByDate[0][0];
                    setExpandedDates(new Set([latestDateKey]));
                }
            }, [groupedByDate]);

            const toggleDate = (dateKey) => {
                setExpandedDates(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(dateKey)) {
                        newSet.delete(dateKey);
                    } else {
                        newSet.add(dateKey);
                    }
                    return newSet;
                });
            };

            return (
                <div>
                    <h2 className="text-lg font-semibold mb-4 text-slate-800">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </h2>

                    <div className="overflow-x-auto bg-white rounded-lg shadow-md p-4 mb-6">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏•‡∏¥‡∏ï‡∏£)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {groupedByDate.map(([dateKey, data]) => {
                                    const isExpanded = expandedDates.has(dateKey);
                                    return (
                                        <React.Fragment key={dateKey}>
                                            <tr className="bg-slate-50 border-t-2 border-slate-200 cursor-pointer hover:bg-slate-100" onClick={() => toggleDate(dateKey)}>
                                                <td className="px-3 py-2 font-semibold text-slate-700" colSpan="3">
                                                    <div className="flex items-center">
                                                        <span className={`transform transition-transform duration-200 mr-2 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-4 w-4" /></span>
                                                        {formatDate(dateKey)}
                                                    </div>
                                                </td>
                                                <td className="px-3 py-2 text-right font-semibold text-green-600">+{formatPrice(data.totalIn)}</td>
                                                <td className="px-3 py-2 text-right font-semibold text-red-600">-{formatPrice(data.totalOut)}</td>
                                            </tr>
                                            {isExpanded && data.items.map((row, idx) => (
                                                <tr key={idx} className="border-t">
                                                    <td className="px-3 py-2 pl-8 text-slate-500 text-xs">{formatTime(row['‡πÄ‡∏ß‡∏•‡∏≤'])}</td>
                                                    <td className="px-3 py-2">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${row['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                            {row['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}
                                                        </span>
                                                    </td>
                                                    <td className="px-3 py-2 text-slate-700">{row['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '-'}</td>
                                                    <td className="px-3 py-2 text-right text-slate-600">
                                                        {row['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å'
                                                            ? formatNumber(row['‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£'])
                                                            : formatNumber(row['‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'])}
                                                    </td>
                                                    <td className="px-3 py-2 text-right font-semibold text-emerald-600">
                                                        {formatPrice(row['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'])}
                                                    </td>
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    <BarChart
                        data={chartData}
                        color="bg-indigo-500"
                        title="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ (‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å - 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)"
                    />
                </div>
            );
        };
        const FuelCharts = ({ supplyData }) => {
            const { dieselPriceChart, dieselLiterChart, benzenePriceChart, benzeneLiterChart } = useMemo(() => {
                if (!supplyData || supplyData.length === 0) {
                    return { dieselPriceChart: [], dieselLiterChart: [], benzenePriceChart: [], benzeneLiterChart: [] };
                }

                const processFuelData = (data, valueField, unit) => {
                    const vehicleSummary = data.reduce((acc, item) => {
                        const vehicle = item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const value = parseFloat(item[valueField]) || 0;
                        if (!acc[vehicle]) acc[vehicle] = 0;
                        acc[vehicle] += value;
                        return acc;
                    }, {});

                    return Object.entries(vehicleSummary)
                        .map(([label, value]) => ({ label, value, displayValue: `${formatNumber(value)} ${unit}` }))
                        .sort((a, b) => b.value - a.value)
                        .slice(0, 10);
                };
                
                const dieselData = supplyData.filter(item => {
                    const fuelType = item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'] ? item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'].toLowerCase() : '';
                    return fuelType.includes('‡∏î‡∏µ‡πÄ‡∏ã‡∏•');
                });
                const benzeneData = supplyData.filter(item => {
                    const fuelType = item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'] ? item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'].toLowerCase() : '';
                    return fuelType.includes('‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô') || fuelType.includes('‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå') || fuelType.includes('91') || fuelType.includes('95');
                });

                const dieselPriceChart = processFuelData(dieselData, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', '‡∏ö‡∏≤‡∏ó');
                const dieselLiterChart = processFuelData(dieselData, '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£', '‡∏•‡∏¥‡∏ï‡∏£');
                const benzenePriceChart = processFuelData(benzeneData, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', '‡∏ö‡∏≤‡∏ó');
                const benzeneLiterChart = processFuelData(benzeneData, '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£', '‡∏•‡∏¥‡∏ï‡∏£');

                return { dieselPriceChart, dieselLiterChart, benzenePriceChart, benzeneLiterChart };

            }, [supplyData]);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <BarChart data={dieselLiterChart} color="bg-sky-600" title="10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏î‡∏µ‡πÄ‡∏ã‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏•‡∏¥‡∏ï‡∏£)" />
                    <BarChart data={dieselPriceChart} color="bg-sky-500" title="10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏î‡∏µ‡πÄ‡∏ã‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)" />
                    <BarChart data={benzeneLiterChart} color="bg-amber-600" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏•‡∏¥‡∏ï‡∏£)" />
                    <BarChart data={benzenePriceChart} color="bg-amber-500" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)" />
                    

                </div>
            );
        };

        const FuelSupplyTab = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const [expandedVehicles, setExpandedVehicles] = useState(new Set());

            const groupedByMonth = useMemo(() => {
                if (!data) return [];
                const grouped = data.reduce((acc, item) => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                    if (!date) return acc;
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!acc[monthKey]) {
                        acc[monthKey] = { year: date.getFullYear(), month: date.getMonth(), items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[monthKey].items.push(item);
                    acc[monthKey].totalLiters += Number(item['‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£']) || 0;
                    acc[monthKey].totalPrice += Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    return acc;
                }, {});
                return Object.entries(grouped).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));
            }, [data]);
            
            const groupVehicles = (items) => {
                 if (!items) return [];
                 const grouped = items.reduce((acc, item) => {
                    const vehicle = item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!acc[vehicle]) {
                        acc[vehicle] = { items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[vehicle].items.push(item);
                    acc[vehicle].totalLiters += Number(item['‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£']) || 0;
                    acc[vehicle].totalPrice += Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    return acc;
                }, {});
                return Object.entries(grouped).sort(([, a], [, b]) => b.totalPrice - a.totalPrice);
            };

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            const toggleVehicle = (vehicleKey) => {
                setExpandedVehicles(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(vehicleKey)) newSet.delete(vehicleKey);
                    else newSet.add(vehicleKey);
                    return newSet;
                });
            };

            return (
                <div className="space-y-2">
                    {groupedByMonth.length === 0 && <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>}
                    {groupedByMonth.map(([monthKey, monthData]) => {
                        const isMonthExpanded = expandedMonths.has(monthKey);
                        const vehiclesInMonth = groupVehicles(monthData.items);
                        return (
                             <div key={monthKey} className="border rounded-lg overflow-hidden bg-white">
                                <div onClick={() => toggleMonth(monthKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50 bg-blue-50">
                                    <div className="flex items-center">
                                        <span className={`transform transition-transform duration-200 mr-2 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-blue-600" /></span>
                                        <h4 className="font-semibold text-blue-800">{getThaiMonthName(monthData.month)} {monthData.year}</h4>
                                    </div>
                                     <div className="text-sm text-right">
                                        <div className="font-semibold text-red-600">{formatPrice(monthData.totalPrice)} ‡∏ö‡∏≤‡∏ó</div>
                                        <div className="text-xs text-slate-500">{formatNumber(monthData.totalLiters)} ‡∏•‡∏¥‡∏ï‡∏£</div>
                                    </div>
                                </div>
                                <div className={`transition-all duration-300 ease-in-out ${isMonthExpanded ? 'max-h-[5000px] opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                    <div className="p-4 bg-blue-50/30 border-t space-y-2">
                                        {vehiclesInMonth.map(([vehicle, stats]) => {
                                            const vehicleKey = `${monthKey}-${vehicle}`;
                                            const isVehicleExpanded = expandedVehicles.has(vehicleKey);
                                            return (
                                                <div key={vehicleKey} className="border rounded-lg overflow-hidden bg-white">
                                                    <div onClick={() => toggleVehicle(vehicleKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                                        <div className="flex items-center">
                                                            <span className={`transform transition-transform duration-200 mr-2 ${isVehicleExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-slate-500" /></span>
                                                            <h5 className="font-medium text-slate-700">{vehicle}</h5>
                                                        </div>
                                                        <div className="text-sm text-right">
                                                            <div className="font-semibold text-red-600">{formatPrice(stats.totalPrice)} ‡∏ö‡∏≤‡∏ó</div>
                                                            <div className="text-xs text-slate-500">{formatNumber(stats.totalLiters)} ‡∏•‡∏¥‡∏ï‡∏£</div>
                                                        </div>
                                                    </div>
                                                    <div className={`transition-all duration-300 ease-in-out ${isVehicleExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                                        <div className="p-4 bg-slate-50/70 border-t">
                                                            <table className="w-full text-sm">
                                                                <thead className="bg-slate-200">
                                                                    <tr>
                                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</th>
                                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏•‡∏¥‡∏ï‡∏£)</th>
                                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {stats.items.map((item, index) => (
                                                                        <tr key={index} className="border-t">
                                                                            <td className="px-3 py-2 text-slate-600">{formatSimpleDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])}</td>
                                                                            <td className="px-3 py-2 text-slate-700">{item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']}</td>
                                                                            <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item['‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£'])}</td>
                                                                            <td className="px-3 py-2 text-right text-red-600">{formatPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'])}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const FuelReceivingTab = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());

            const groupedByMonth = useMemo(() => {
                if (!data) return [];
                const grouped = data.reduce((acc, item) => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                    if (!date) return acc;
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!acc[monthKey]) {
                        acc[monthKey] = { year: date.getFullYear(), month: date.getMonth(), items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[monthKey].items.push(item);
                    acc[monthKey].totalLiters += Number(item['‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤']) || 0;
                    acc[monthKey].totalPrice += Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                    return acc;
                }, {});

                return Object.entries(grouped).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));
            }, [data]);

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            return (
                <div className="space-y-2">
                    {groupedByMonth.length === 0 && <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>}
                    {groupedByMonth.map(([monthKey, monthData]) => {
                        const isMonthExpanded = expandedMonths.has(monthKey);
                        return (
                             <div key={monthKey} className="border rounded-lg overflow-hidden bg-white">
                                <div onClick={() => toggleMonth(monthKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50 bg-blue-50">
                                    <div className="flex items-center">
                                        <span className={`transform transition-transform duration-200 mr-2 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-blue-600" /></span>
                                        <h4 className="font-semibold text-blue-800">{getThaiMonthName(monthData.month)} {monthData.year}</h4>
                                    </div>
                                    <div className="text-sm text-right">
                                        <div className="font-semibold text-green-600">{formatPrice(monthData.totalPrice)} ‡∏ö‡∏≤‡∏ó</div>
                                        <div className="text-xs text-slate-500">{formatNumber(monthData.totalLiters)} ‡∏•‡∏¥‡∏ï‡∏£</div>
                                    </div>
                                </div>
                                <div className={`transition-all duration-300 ease-in-out ${isMonthExpanded ? 'max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                    <div className="p-4 bg-blue-50/30 border-t">
                                        <table className="w-full text-sm bg-white rounded-lg overflow-hidden">
                                            <thead className="bg-slate-200">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏•‡∏¥‡∏ï‡∏£)</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {monthData.items.map((item, index) => (
                                                    <tr key={index} className="border-t">
                                                        <td className="px-3 py-2 text-slate-600">{formatSimpleDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])}</td>
                                                        <td className="px-3 py-2 text-slate-700">{item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']}</td>
                                                        <td className="px-3 py-2 text-right text-green-600">{formatNumber(item['‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'])}</td>
                                                        <td className="px-3 py-2 text-right text-green-600">{formatPrice(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'])}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )
        };

        const FuelApp = ({ data }) => {
            const [activeTab, setActiveTab] = useState('last7days');
            const [selectedYear, setSelectedYear] = useState('all');
            const [selectedMonth, setSelectedMonth] = useState('all');

            const { uniqueYears } = useMemo(() => {
                const allFuelData = [...(data.receiving || []), ...(data.supply || [])];
                const years = new Set(allFuelData.map(item => parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])?.getFullYear()).filter(Boolean));
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);

            const filteredData = useMemo(() => {
                const filterByDate = (d) => {
                    if (!d) return [];
                    const dataWithoutCarryOver = d.filter(item => item['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å SAP'] !== '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤');

                    if (selectedYear === 'all') return dataWithoutCarryOver;
                    
                    return dataWithoutCarryOver.filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        if (!date) return false;
                        const yearMatch = date.getFullYear() === parseInt(selectedYear, 10);
                        const monthMatch = selectedMonth === 'all' || date.getMonth() === parseInt(selectedMonth, 10);
                        return yearMatch && monthMatch;
                    });
                };
                return {
                    receiving: filterByDate(data.receiving),
                    supply: filterByDate(data.supply)
                };
            }, [data, selectedYear, selectedMonth]);

            const { summary } = useMemo(() => {
                const receivingInPeriod = filteredData.receiving;
                const supplyInPeriod = filteredData.supply;

                const aggregateFuelData = (data, valueField) => {
                    const summary = { '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': 0, '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': 0 };
                    (data || []).forEach(item => {
                        const type = item['‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const value = Number(item[valueField]) || 0;
                        const fuelTypeStr = type.toLowerCase();
                        if (fuelTypeStr.includes('‡∏î‡∏µ‡πÄ‡∏ã‡∏•')) {
                            summary['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] += value;
                        } else if (fuelTypeStr.includes('‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô') || fuelTypeStr.includes('‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå') || fuelTypeStr.includes('91') || fuelTypeStr.includes('95')) {
                            summary['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] += value;
                        }
                    });
                    return summary;
                };

                const receivedBahtByType = aggregateFuelData(receivingInPeriod, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
                const receivedLitersByType = aggregateFuelData(receivingInPeriod, '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
                const suppliedBahtByType = aggregateFuelData(supplyInPeriod, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
                const suppliedLitersByType = aggregateFuelData(supplyInPeriod, '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£');

                // Helper function to get cumulative balance up to a certain date
                const getCumulativeBalanceByDate = (endDate) => {
                    const receiving = (data.receiving || []).filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        return date && date <= endDate;
                    });
                    const supply = (data.supply || []).filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        return date && date <= endDate;
                    });

                    const totalReceivedLiters = aggregateFuelData(receiving, '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
                    const totalSuppliedLiters = aggregateFuelData(supply, '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£');

                    return {
                        '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': (totalReceivedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] || 0) - (totalSuppliedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] || 0),
                        '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': (totalReceivedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] || 0) - (totalSuppliedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] || 0),
                    };
                };

                let fuelBalanceByType = {};
                
                if (selectedYear === 'all') {
                    // If 'all years' is selected, show the total cumulative balance as before.
                    const allReceiving = data.receiving || [];
                    const allSupply = data.supply || [];
                    const totalReceivedLiters = aggregateFuelData(allReceiving, '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
                    const totalSuppliedLiters = aggregateFuelData(allSupply, '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å /‡∏•‡∏¥‡∏ï‡∏£');
                    fuelBalanceByType = {
                        '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': (totalReceivedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] || 0) - (totalSuppliedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] || 0),
                        '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': (totalReceivedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] || 0) - (totalSuppliedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] || 0),
                    };
                } else {
                    // If a specific year/month is selected, calculate the change from the previous period.
                    let endOfCurrentPeriod, endOfPreviousPeriod;
                    const year = parseInt(selectedYear, 10);

                    if (selectedMonth === 'all') { // Yearly view
                        endOfCurrentPeriod = new Date(year, 12, 0); // Last day of the year
                        endOfPreviousPeriod = new Date(year - 1, 12, 0); // Last day of the previous year
                    } else { // Monthly view
                        const month = parseInt(selectedMonth, 10);
                        endOfCurrentPeriod = new Date(year, month + 1, 0); // Last day of the selected month
                        endOfPreviousPeriod = new Date(year, month, 0); // Last day of the previous month
                    }
                    
                    endOfCurrentPeriod.setHours(23, 59, 59, 999);
                    endOfPreviousPeriod.setHours(23, 59, 59, 999);

                    const currentBalance = getCumulativeBalanceByDate(endOfCurrentPeriod);
                    const previousBalance = getCumulativeBalanceByDate(endOfPreviousPeriod);

                    fuelBalanceByType = {
                        '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': currentBalance['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] - previousBalance['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'],
                        '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': currentBalance['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] - previousBalance['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'],
                    };
                }

                // Value calculation remains based on cumulative average price for stability
                const allDataBeforeEndDate = (d) => {
                    if (!d) return [];
                    if (selectedYear === 'all') return d;
                    
                    const endOfMonth = new Date(parseInt(selectedYear, 10), selectedMonth === 'all' ? 12 : parseInt(selectedMonth, 10) + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    
                    return d.filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        return date && date <= endOfMonth;
                    });
                };
                
                const receivingBefore = allDataBeforeEndDate(data.receiving);
                const totalReceivedLiters = aggregateFuelData(receivingBefore, '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
                const totalReceivedValue = aggregateFuelData(receivingBefore, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
                
                const avgPriceByType = {
                    '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': totalReceivedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] > 0 ? totalReceivedValue['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] / totalReceivedLiters['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] : 0,
                    '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': totalReceivedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] > 0 ? totalReceivedValue['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] / totalReceivedLiters['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] : 0,
                };
                const fuelBalanceValueByType = {
                    '‡∏î‡∏µ‡πÄ‡∏ã‡∏•': fuelBalanceByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] * avgPriceByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'],
                    '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô': fuelBalanceByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] * avgPriceByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'],
                };

                return { 
                    summary: {
                        receivedBahtByType,
                        suppliedBahtByType,
                        receivedLitersByType,
                        suppliedLitersByType,
                        fuelBalanceByType,
                        fuelBalanceValueByType
                    }
                };
            }, [filteredData, data, selectedYear, selectedMonth]); 

            return (
                 <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => { setSelectedYear(e.target.value); setSelectedMonth('all'); }} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md" disabled={selectedYear === 'all'}>
                            <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][i]}</option>)}
                        </select>
                    </div>

                    <div className="space-y-6">
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <SummaryCard key="r-liter-diesel" title="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.receivedLitersByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-liter-benzene" title="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.receivedLitersByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-baht-diesel" title="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.receivedBahtByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-baht-benzene" title="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.receivedBahtByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                             </div>
                        </div>
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <SummaryCard key="s-liter-diesel" title="‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.suppliedLitersByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-liter-benzene" title="‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.suppliedLitersByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-baht-diesel" title="‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.suppliedBahtByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-baht-benzene" title="‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.suppliedBahtByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                             </div>
                        </div>
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ì ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                {summary.fuelBalanceByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] !== undefined && <SummaryCard key="b-liter-diesel" title="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.fuelBalanceByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] !== undefined && <SummaryCard key="b-liter-benzene" title="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏•‡∏¥‡∏ï‡∏£)" value={formatNumber(summary.fuelBalanceByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏•‡∏¥‡∏ï‡∏£" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceValueByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'] !== undefined && <SummaryCard key="b-baht-diesel" title="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏î‡∏µ‡πÄ‡∏ã‡∏• (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.fuelBalanceValueByType['‡∏î‡∏µ‡πÄ‡∏ã‡∏•'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceValueByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'] !== undefined && <SummaryCard key="b-baht-benzene" title="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" value={formatPrice(summary.fuelBalanceValueByType['‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô'])} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                             </div>
                        </div>
                    </div>
                    
                    <div className="mt-8">
                        <FuelCharts supplyData={filteredData.supply} />
                    </div>

                    <div className="flex border-b border-gray-200 mt-8 mb-4 sm:mb-6 overflow-x-auto">
                        <button onClick={() => setActiveTab('last7days')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'last7days' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                            7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        </button>
                        <button onClick={() => setActiveTab('supply')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'supply' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                        </button>
                        <button onClick={() => setActiveTab('receiving')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'receiving' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                           ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                        </button>
                    </div>
                    
                    {activeTab === 'last7days' && <FuelLast7DaysTab fuelOutData={data.supply} fuelInData={data.receiving} />}
                    {activeTab === 'supply' && <FuelSupplyTab data={filteredData.supply} />}
                    {activeTab === 'receiving' && <FuelReceivingTab data={filteredData.receiving} />}
                </div>
            );
        };
        // ### FUEL APP COMPONENTS (END) ###
        
        // ##################################################################
        // ### EV CHARGING APP COMPONENTS (START) ###
        // ##################################################################

        const EVChargingCharts = ({ chartData }) => {
            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <BarChart data={chartData.vehicleCost} color="bg-amber-500" title="10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î" />
                    <BarChart data={chartData.chargerKwh} color="bg-sky-500" title="10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡∏π‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (kWh) ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î" />
                </div>
            );
        };

        const VehicleChargeDetailsModal = ({ vehiclePlate, chargeData, onClose }) => {
            const vehicleHistory = chargeData.filter(item => item.licensePlate === vehiclePlate);
            return (
                <div className="modal-backdrop">
                    <div className="modal-content">
                        <h3 className="text-lg font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à: {vehiclePlate}</h3>
                        <div className="overflow-y-auto max-h-[60vh]">
                             <table className="w-full text-sm">
                                <thead className="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ï‡∏π‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                        <th className="px-3 py-2 text-right font-medium text-slate-600">kWh</th>
                                        <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ö‡∏≤‡∏ó)</th>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {vehicleHistory.map((item, index) => (
                                        <tr key={item.id || index} className="border-t">
                                            <td className="px-3 py-2 text-slate-600">{formatDate(item.date)}</td>
                                            <td className="px-3 py-2 text-slate-700">{item.chargerName}</td>
                                            <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.units)}</td>
                                            <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.electricityCost)}</td>
                                            <td className="px-3 py-2 text-slate-600">{item.duration}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={onClose} className="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            );
        };

        const BatteryPerformanceAnalysis = ({ vehicleData, evConfig }) => {
            const batteryAnalysis = useMemo(() => {
                if (!vehicleData || vehicleData.length === 0) return [];

                const analysis = vehicleData.map(vehicle => {
                    const config = evConfig[vehicle.licensePlate];
                    if (!config) return null;

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                    const avgKwhPerCharge = vehicle.totalKwh / vehicle.count;
                    const avgCostPerKwh = vehicle.totalCost / vehicle.totalKwh;
                    const chargingFrequency = vehicle.count; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à
                    
                    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢ SOC, DoD ‡πÅ‡∏•‡∏∞ Cycle Efficiency
                    const standardKwhPerCharge = 16; // kWh ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
                    
                    // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡πà‡∏≤ SOC ‡πÅ‡∏•‡∏∞ DoD ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    const usageRatio = avgKwhPerCharge / standardKwhPerCharge;
                    const estimatedSOC = Math.max(20, Math.min(90, 100 - (usageRatio - 1) * 50)); // SOC 20-90%
                    const estimatedDoD = Math.min(80, usageRatio * 60); // DoD 0-80%
                    const cycleEfficiency = 0.92; // ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à 92%
                    
                    // ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏° SOC ‡πÅ‡∏•‡∏∞ DoD
                    const socFactor = estimatedSOC > 80 ? 0.95 : (estimatedSOC < 30 ? 0.85 : 1.0);
                    const dodFactor = estimatedDoD > 70 ? 0.90 : (estimatedDoD < 20 ? 0.95 : 1.0);
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                    const baseEfficiency = (avgKwhPerCharge / standardKwhPerCharge) * 100;
                    const efficiency = (baseEfficiency * socFactor * dodFactor * cycleEfficiency).toFixed(1);
                    
                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ 100% ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)
                    let batteryStatus = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
                    let statusColor = 'text-green-600';
                    if (efficiency > 120 || efficiency < 60) {
                        batteryStatus = '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                        statusColor = 'text-red-600';
                    } else if (efficiency > 110 || efficiency < 80) {
                        batteryStatus = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                        statusColor = 'text-yellow-600';
                    } else if (efficiency > 105 || efficiency < 95) {
                        batteryStatus = '‡∏î‡∏µ';
                        statusColor = 'text-blue-600';
                    }

                    return {
                        licensePlate: vehicle.licensePlate,
                        totalKwh: vehicle.totalKwh,
                        totalCost: vehicle.totalCost,
                        count: vehicle.count,
                        avgKwhPerCharge,
                        avgCostPerKwh,
                        efficiency: parseFloat(efficiency),
                        batteryStatus,
                        statusColor,
                        chargingFrequency,
                        estimatedSOC: estimatedSOC.toFixed(1),
                        estimatedDoD: estimatedDoD.toFixed(1),
                        cycleEfficiency: (cycleEfficiency * 100).toFixed(1),
                        socFactor: socFactor.toFixed(2),
                        dodFactor: dodFactor.toFixed(2)
                    };
                }).filter(Boolean);

                return analysis.sort((a, b) => b.efficiency - a.efficiency);
            }, [vehicleData, evConfig]);

            if (batteryAnalysis.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏ñ EV</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (%)</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">SOC (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">DoD (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">Cycle Eff (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ kWh/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü/kWh</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody>
                                {batteryAnalysis.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-50">
                                        <td className="px-3 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-3 py-2 text-right font-semibold">
                                            <span className={item.efficiency >= 95 ? 'text-green-600' : item.efficiency >= 85 ? 'text-blue-600' : item.efficiency >= 70 ? 'text-yellow-600' : 'text-red-600'}>
                                                {item.efficiency}%
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.statusColor} bg-opacity-10`}>
                                                {item.batteryStatus}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.estimatedSOC}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.estimatedDoD}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.cycleEfficiency}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.avgKwhPerCharge)} kWh</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.avgCostPerKwh)} ‡∏ö‡∏≤‡∏ó</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.chargingFrequency} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
                                        <td className="px-3 py-2 text-right font-semibold text-sky-700">{formatPrice(item.totalCost)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-3 text-xs text-slate-500">
                        <p>* ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 16 kWh ‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à (100% = ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</p>
                        <p>* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà: ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (95-105%), ‡∏î‡∏µ (80-94% ‡∏´‡∏£‡∏∑‡∏≠ 106-110%), ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (60-79% ‡∏´‡∏£‡∏∑‡∏≠ 111-120%), ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (&lt;60% ‡∏´‡∏£‡∏∑‡∏≠ &gt;120%)</p>
                    </div>
                </div>
            );
        };

        const AdvancedBatteryMetrics = ({ vehicleData, evConfig }) => {
            const advancedMetrics = useMemo(() => {
                if (!vehicleData || vehicleData.length === 0) return [];

                return vehicleData.map(vehicle => {
                    const config = evConfig[vehicle.licensePlate];
                    if (!config) return null;

                    const avgKwhPerCharge = vehicle.totalKwh / vehicle.count;
                    const chargingFrequency = vehicle.count;
                    
                    // Battery Health Score (0-100)
                    const usageRatio = avgKwhPerCharge / 16;
                    const frequencyFactor = Math.min(1, chargingFrequency / 30); // ‡∏õ‡∏Å‡∏ï‡∏¥ 30 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    const healthScore = Math.max(0, Math.min(100, 100 - (Math.abs(usageRatio - 1) * 20) - (frequencyFactor > 0.8 ? (frequencyFactor - 0.8) * 50 : 0)));
                    
                    // Temperature Impact Estimation (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
                    const tempImpact = usageRatio > 1.2 ? '‡∏™‡∏π‡∏á' : usageRatio > 0.8 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πà‡∏≥';
                    const tempColor = tempImpact === '‡∏™‡∏π‡∏á' ? 'text-red-600' : tempImpact === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'text-yellow-600' : 'text-green-600';
                    
                    // Charging Pattern Analysis
                    const avgChargePerDay = chargingFrequency / 30; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ 30 ‡∏ß‡∏±‡∏ô
                    let chargingPattern = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    let patternColor = 'text-blue-600';
                    if (avgChargePerDay > 2) {
                        chargingPattern = '‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
                        patternColor = 'text-red-600';
                    } else if (avgChargePerDay < 0.5) {
                        chargingPattern = '‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
                        patternColor = 'text-orange-600';
                    } else if (avgChargePerDay > 1.5) {
                        chargingPattern = '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠‡∏¢';
                        patternColor = 'text-yellow-600';
                    }
                    
                    // Battery Degradation Estimate (% per year)
                    const degradationRate = Math.max(1, Math.min(8, 2 + (Math.abs(usageRatio - 1) * 3) + (frequencyFactor > 0.8 ? 2 : 0)));
                    
                    // Optimal Charging Recommendation
                    let recommendation = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥';
                    if (healthScore < 70) {
                        recommendation = '‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà';
                    } else if (avgChargePerDay > 2) {
                        recommendation = '‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à';
                    } else if (usageRatio > 1.3) {
                        recommendation = '‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å';
                    }

                    return {
                        licensePlate: vehicle.licensePlate,
                        healthScore: healthScore.toFixed(1),
                        tempImpact,
                        tempColor,
                        chargingPattern,
                        patternColor,
                        avgChargePerDay: avgChargePerDay.toFixed(1),
                        degradationRate: degradationRate.toFixed(1),
                        recommendation
                    };
                }).filter(Boolean);
            }, [vehicleData, evConfig]);

            if (advancedMetrics.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">‡πÄ‡∏°‡∏ï‡∏£‡∏¥‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà EV</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">Health Score</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏Å‡∏£‡∏∞‡∏ó‡∏ö</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏ä‡∏≤‡∏£‡πå‡∏à/‡∏ß‡∏±‡∏ô</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°/‡∏õ‡∏µ (%)</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th>
                                </tr>
                            </thead>
                            <tbody>
                                {advancedMetrics.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-50">
                                        <td className="px-3 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-3 py-2 text-right font-semibold">
                                            <span className={item.healthScore >= 80 ? 'text-green-600' : item.healthScore >= 60 ? 'text-yellow-600' : 'text-red-600'}>
                                                {item.healthScore}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.tempColor} bg-opacity-10`}>
                                                {item.tempImpact}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.patternColor} bg-opacity-10`}>
                                                {item.chargingPattern}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.avgChargePerDay}</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.degradationRate}%</td>
                                        <td className="px-3 py-2 text-slate-600 text-xs">{item.recommendation}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-3 text-xs text-slate-500">
                        <p>* Health Score: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà (100 = ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î, 0 = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</p>
                        <p>* ‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°/‡∏õ‡∏µ: ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏õ‡∏µ</p>
                        <p>* ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà</p>
                    </div>
                </div>
            );
        };

        const VehicleCostSummaryTable = ({ summaryData, onVehicleSelect }) => {
            if (!summaryData || summaryData.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {summaryData.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-100 cursor-pointer" onClick={() => onVehicleSelect(item.licensePlate)}>
                                        <td className="px-4 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-4 py-2 text-right text-slate-600">{item.count}</td>
                                        <td className="px-4 py-2 text-right font-semibold text-sky-700">{formatPrice(item.totalCost)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const WeeklyAccordion = ({ weekData, isExpanded, onToggle, weekNumber }) => {
            const { chargerSummary, vehicleSummary, items, startDate, endDate } = weekData;

            const groupedWeeklyItems = useMemo(() => {
                if (!items) return {};
                return items.reduce((acc, item) => {
                    const plate = item.licensePlate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!acc[plate]) {
                        acc[plate] = { items: [], totalKwh: 0, totalCost: 0, durations: [] };
                    }
                    acc[plate].items.push(item);
                    acc[plate].totalKwh += parseFloat(item.units) || 0;
                    acc[plate].totalCost += parseFloat(item.electricityCost) || 0;
                    if(item.duration) acc[plate].durations.push(item.duration);
                    return acc;
                }, {});
            }, [items]);

            return (
                <div className="mb-2 border border-slate-200 rounded-lg overflow-hidden">
                    <div onClick={onToggle} className="bg-slate-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors duration-200">
                        <div className="flex items-center">
                             <span className={`transform transition-transform duration-200 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}>
                                <Icons name="chevronDown" className="h-5 w-5 mr-2 text-slate-500" />
                            </span>
                            <h4 className="font-semibold text-slate-700">
                                ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà {weekNumber}
                                <span className="font-normal text-slate-500 text-sm ml-2">
                                    ({formatDate(startDate)} - {formatDate(endDate)})
                                </span>
                            </h4>
                        </div>
                        <div className="text-sm text-slate-600">
                            <span className="font-semibold">{items.length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | <span className="font-semibold text-sky-700">{formatPrice(weekData.totalCost)}</span> ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>
                    <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                        <div className="p-4 bg-white">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                {/* Charger Summary Table */}
                                <div>
                                    <h5 className="font-semibold text-slate-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏π‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à</h5>
                                    <div className="overflow-x-auto border rounded-md">
                                        <table className="w-full text-sm">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ï‡∏π‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {Object.entries(chargerSummary).sort(([,a],[,b]) => b.count - a.count).map(([charger, data]) => (
                                                    <tr key={charger} className="border-t">
                                                        <td className="px-3 py-2 font-medium text-slate-700">{charger}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{data.count}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(data.totalCost)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                 {/* Vehicle Summary Table */}
                                <div>
                                    <h5 className="font-semibold text-slate-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ</h5>
                                    <div className="overflow-x-auto border rounded-md">
                                        <table className="w-full text-sm">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                 {Object.entries(vehicleSummary).sort(([,a],[,b]) => b.count - a.count).map(([vehicle, data]) => (
                                                    <tr key={vehicle} className="border-t">
                                                        <td className="px-3 py-2 font-medium text-slate-700">{vehicle}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{data.count}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {/* Detailed Charging List */}
                            <h5 className="font-semibold text-slate-800 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</h5>
                             <div className="overflow-x-auto border rounded-md">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏ï‡∏π‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                            <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (kWh)</th>
                                            <th className="px-3 py-2 text-right font-medium text-slate-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(groupedWeeklyItems).map(([plate, summary]) => (
                                            <React.Fragment key={plate}>
                                                <tr className="bg-slate-200/60 border-t border-b border-slate-300">
                                                    <td colSpan="5" className="px-3 py-2 font-semibold text-slate-800">
                                                        ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: {plate}
                                                    </td>
                                                </tr>
                                                {summary.items.map((item, index) => (
                                                    <tr key={item.id || index} className="border-t hover:bg-slate-50">
                                                        <td className="px-3 py-2 text-slate-600 pl-6">{formatDate(item.date)}</td>
                                                        <td className="px-3 py-2 text-slate-700">{item.chargerName}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.units)}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.electricityCost)}</td>
                                                        <td className="px-3 py-2 text-slate-600">{item.duration}</td>
                                                    </tr>
                                                ))}
                                                <tr className="bg-green-100 border-t-2 border-green-300 font-semibold">
                                                    <td colSpan="2" className="px-3 py-2 text-right text-green-800">‡∏£‡∏ß‡∏°</td>
                                                    <td className="px-3 py-2 text-right text-green-800">{formatNumber(summary.totalKwh)}</td>
                                                    <td className="px-3 py-2 text-right text-green-800">{formatPrice(summary.totalCost)}</td>
                                                    <td className="px-3 py-2 text-green-800">{sumDurations(summary.durations)}</td>
                                                </tr>
                                            </React.Fragment>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EVChargingApp = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const [expandedWeeks, setExpandedWeeks] = useState(new Set());
            const [selectedYear, setSelectedYear] = useState('all');
            const [selectedMonth, setSelectedMonth] = useState('all');
            const [selectedVehicleDetails, setSelectedVehicleDetails] = useState(null);

            // EV Configuration for battery analysis
            const EV_CONFIG = {
                'TT-19': { name: 'TT-19', price: 533930 },
                'TT-20': { name: 'TT-20', price: 1660000 },
                'TT-21': { name: 'TT-21', price: 1660000 },
                'TT-22': { name: 'TT-22', price: 1660000 },
                'TT-23': { name: 'TT-23', price: 1660000 },
            };

            const { uniqueYears } = useMemo(() => {
                const years = new Set(data.map(item => parseDate(item.date)?.getFullYear()).filter(Boolean));
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);

            const filteredData = useMemo(() => {
                if (selectedYear === 'all') return data;
                return data.filter(item => {
                    const date = parseDate(item.date);
                    if (!date) return false;
                    const yearMatch = date.getFullYear() === parseInt(selectedYear, 10);
                    const monthMatch = selectedMonth === 'all' || date.getMonth() === parseInt(selectedMonth, 10);
                    return yearMatch && monthMatch;
                });
            }, [data, selectedYear, selectedMonth]);

            const dateRange = useMemo(() => {
                if(filteredData.length === 0) return { startDate: null, endDate: null };
                const dates = filteredData.map(item => parseDate(item.date).getTime()).filter(t => !isNaN(t));
                if(dates.length === 0) return { startDate: null, endDate: null };
                const startDate = new Date(Math.min(...dates));
                const endDate = new Date(Math.max(...dates));
                return { startDate, endDate };
            }, [filteredData]);

            const groupedData = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return [];

                const getWeekInfo = (d) => {
                    const date = new Date(d.getTime());
                    date.setHours(0, 0, 0, 0);
                    date.setDate(date.getDate() + 4 - (date.getDay() || 7));
                    const yearStart = new Date(date.getFullYear(), 0, 1);
                    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
                    return `${date.getFullYear()}-W${weekNo}`;
                };

                const processed = filteredData.reduce((acc, item) => {
                    const date = parseDate(item.date);
                    if (!date) return acc;

                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const monthKey = `${year}-${month}`;
                    const weekKey = getWeekInfo(date);

                    if (!acc[monthKey]) {
                        acc[monthKey] = { year, month, weeks: {}, totalKwh: 0, totalCost: 0, count: 0 };
                    }

                    if (!acc[monthKey].weeks[weekKey]) {
                        const firstDayOfWeek = new Date(date);
                        const day = firstDayOfWeek.getDay();
                        const diff = firstDayOfWeek.getDate() - day + (day === 0 ? -6 : 1); 
                        firstDayOfWeek.setDate(diff);
                        
                        const lastDayOfWeek = new Date(firstDayOfWeek);
                        lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                        acc[monthKey].weeks[weekKey] = { 
                            items: [], 
                            chargerSummary: {}, 
                            vehicleSummary: {},
                            totalKwh: 0,
                            totalCost: 0,
                            startDate: firstDayOfWeek.toISOString(),
                            endDate: lastDayOfWeek.toISOString()
                        };
                    }
                    
                    const week = acc[monthKey].weeks[weekKey];
                    week.items.push(item);
                    
                    const cost = parseFloat(item.electricityCost) || 0;
                    const kwh = parseFloat(item.units) || 0;
                    const charger = item.chargerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const vehicle = item.licensePlate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                    week.totalCost += cost;
                    week.totalKwh += kwh;
                    
                    if (!week.chargerSummary[charger]) week.chargerSummary[charger] = { count: 0, totalCost: 0 };
                    week.chargerSummary[charger].count++;
                    week.chargerSummary[charger].totalCost += cost;

                    if (!week.vehicleSummary[vehicle]) week.vehicleSummary[vehicle] = { count: 0 };
                    week.vehicleSummary[vehicle].count++;
                    
                    acc[monthKey].totalCost += cost;
                    acc[monthKey].totalKwh += kwh;
                    acc[monthKey].count++;

                    return acc;
                }, {});
                
                return Object.entries(processed).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));

            }, [filteredData]);

            const vehicleCostSummary = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return [];

                const summary = filteredData.reduce((acc, item) => {
                    const vehicle = item.licensePlate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const cost = parseFloat(item.electricityCost) || 0;
                    const kwh = parseFloat(item.units) || 0;

                    if (!acc[vehicle]) {
                        acc[vehicle] = { totalCost: 0, totalKwh: 0, count: 0 };
                    }
                    acc[vehicle].totalCost += cost;
                    acc[vehicle].totalKwh += kwh;
                    acc[vehicle].count++;
                    return acc;
                }, {});

                return Object.entries(summary)
                    .map(([licensePlate, data]) => ({
                        licensePlate,
                        totalCost: data.totalCost,
                        totalKwh: data.totalKwh,
                        count: data.count,
                    }))
                    .sort((a, b) => b.totalCost - a.totalCost);

            }, [filteredData]);

            const chartData = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return { vehicleCost: [], chargerKwh: [] };

                const vehicleSummary = filteredData.reduce((acc, item) => {
                    const vehicle = item.licensePlate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const cost = parseFloat(item.electricityCost) || 0;
                    if (!acc[vehicle]) acc[vehicle] = 0;
                    acc[vehicle] += cost;
                    return acc;
                }, {});

                const chargerSummary = filteredData.reduce((acc, item) => {
                    const charger = item.chargerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const kwh = parseFloat(item.units) || 0;
                    if (!acc[charger]) acc[charger] = { totalKwh: 0, count: 0 };
                    acc[charger].totalKwh += kwh;
                    acc[charger].count++;
                    return acc;
                }, {});

                const vehicleCost = Object.entries(vehicleSummary)
                    .map(([label, value]) => ({ label, value, displayValue: formatPrice(value) }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                const chargerKwh = Object.entries(chargerSummary)
                    .map(([label, data]) => ({ label, value: data.totalKwh, displayValue: `${formatNumber(data.totalKwh)} kWh` }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return { vehicleCost, chargerKwh };
            }, [filteredData]);

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            const toggleWeek = (weekKey) => {
                setExpandedWeeks(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(weekKey)) newSet.delete(weekKey);
                    else newSet.add(weekKey);
                    return newSet;
                });
            };
            
            const { totalKwh, totalCost, avgKwhPerDay, avgCostPerDay } = useMemo(() => {
                if (filteredData.length === 0) {
                    return { totalKwh: 0, totalCost: 0, avgKwhPerDay: 0, avgCostPerDay: 0 };
                }
                const kwh = filteredData.reduce((sum, item) => sum + (parseFloat(item.units) || 0), 0);
                const cost = filteredData.reduce((sum, item) => sum + (parseFloat(item.electricityCost) || 0), 0);

                let numberOfDays = 0;
                if (dateRange.startDate && dateRange.endDate) {
                    const diffTime = Math.abs(dateRange.endDate.getTime() - dateRange.startDate.getTime());
                    numberOfDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                } else if (filteredData.length > 0) {
                     numberOfDays = 1;
                }

                const avgKwhPerDay = numberOfDays > 0 ? kwh / numberOfDays : 0;
                const avgCostPerDay = numberOfDays > 0 ? cost / numberOfDays : 0;

                return { totalKwh: kwh, totalCost: cost, avgKwhPerDay, avgCostPerDay };
            }, [filteredData, dateRange]);

            const summaryFooterText = dateRange.startDate && dateRange.endDate 
                ? `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ${formatDate(dateRange.startDate)} - ${formatDate(dateRange.endDate)}`
                : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ç‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";

            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ñ EV</h2>
                    
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => { setSelectedYear(e.target.value); setSelectedMonth('all'); }} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md" disabled={selectedYear === 'all'}>
                            <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][i]}</option>)}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <SummaryCard title="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={formatNumber(totalKwh)} unit="kWh" icon={<Icons name="bolt" />} color={{ bg: 'bg-sky-100', icon: 'text-sky-600', border: 'border-sky-500' }} footerText={summaryFooterText} />
                        <SummaryCard title="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={formatPrice(totalCost)} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance" />} color={{ bg: 'bg-amber-100', icon: 'text-amber-600', border: 'border-amber-500' }} footerText={summaryFooterText}/>
                        <SummaryCard title="‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô" value={formatNumber(avgKwhPerDay)} unit="kWh" icon={<Icons name="bolt" />} color={{ bg: 'bg-teal-100', icon: 'text-teal-600', border: 'border-teal-500' }} footerText="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" />
                        <SummaryCard title="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô" value={formatPrice(avgCostPerDay)} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance" />} color={{ bg: 'bg-indigo-100', icon: 'text-indigo-600', border: 'border-indigo-500' }} footerText="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" />
                    </div>
                    
                    <EVChargingCharts chartData={chartData} />
                    <BatteryPerformanceAnalysis vehicleData={vehicleCostSummary} evConfig={EV_CONFIG} />
                    <AdvancedBatteryMetrics vehicleData={vehicleCostSummary} evConfig={EV_CONFIG} />
                    <VehicleCostSummaryTable summaryData={vehicleCostSummary} onVehicleSelect={setSelectedVehicleDetails} />

                    <h3 className="text-lg font-semibold text-slate-800 mb-3 mt-8">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                    <div className="space-y-4">
                        {groupedData.length > 0 ? groupedData.map(([monthKey, monthData]) => {
                             const monthName = getThaiMonthName(monthData.month) + ' ' + monthData.year;
                             const isMonthExpanded = expandedMonths.has(monthKey);
                             const sortedWeeks = Object.entries(monthData.weeks).sort(([, a], [, b]) => new Date(a.startDate) - new Date(b.startDate));

                             return (
                                <div key={monthKey} className="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                                     <div onClick={() => toggleMonth(monthKey)} className="month-header bg-blue-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-blue-100 transition-colors duration-200">
                                        <div className="flex items-center">
                                            <span className={`transform transition-transform duration-200 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}>
                                                <Icons name="chevronDown" className="h-5 w-5 mr-2 text-blue-600" />
                                            </span>
                                            <h3 className="font-semibold text-blue-800 text-lg">{monthName}</h3>
                                        </div>
                                        <div className="text-sm text-slate-700">
                                            <span className="font-semibold">{monthData.count}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | <span className="font-semibold text-sky-800">{formatPrice(monthData.totalCost)}</span> ‡∏ö‡∏≤‡∏ó
                                        </div>
                                    </div>
                                    <div className={`month-content transition-all duration-300 ease-in-out overflow-hidden ${isMonthExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                                        <div className="p-4 bg-blue-50/30">
                                            {sortedWeeks.map(([weekKey, weekData], index) => (
                                                <WeeklyAccordion 
                                                    key={weekKey}
                                                    weekData={weekData}
                                                    weekNumber={index + 1}
                                                    isExpanded={expandedWeeks.has(weekKey)}
                                                    onToggle={() => toggleWeek(weekKey)}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                             )
                        }) : <div className="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</div>}
                    </div>
                    {selectedVehicleDetails && (
                        <VehicleChargeDetailsModal 
                            vehiclePlate={selectedVehicleDetails}
                            chargeData={filteredData}
                            onClose={() => setSelectedVehicleDetails(null)}
                        />
                    )}
                </div>
            );
        };
        // ### EV CHARGING APP COMPONENTS (END) ###
        
        // ##################################################################
        // ### ENERGY COMPARISON APP (START) ###
        // ##################################################################
        const MonthlyComparisonLineChart = ({ data, currentYear, previousYear }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            
            const labels = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            const previousYearData = data.map(d => d.previousYear);
            const currentYearData = data.map(d => d.currentYear);
            
            React.useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy existing chart
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Calculate smooth trend line using moving average
                    const calculateSmoothTrend = (data) => {
                        const smoothedData = [];
                        const windowSize = 3; // 3-month moving average
                        
                        for (let i = 0; i < data.length; i++) {
                            let sum = 0;
                            let count = 0;
                            
                            // Calculate moving average with available data points
                            for (let j = Math.max(0, i - Math.floor(windowSize/2)); 
                                 j <= Math.min(data.length - 1, i + Math.floor(windowSize/2)); j++) {
                                if (data[j] !== null && data[j] !== undefined) {
                                    sum += data[j];
                                    count++;
                                }
                            }
                            
                            smoothedData[i] = count > 0 ? sum / count : data[i];
                        }
                        
                        return smoothedData;
                    };
                    
                    const currentYearTrend = calculateSmoothTrend(currentYearData);
                    const previousYearTrend = calculateSmoothTrend(previousYearData);
                    
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            type: 'bar',
                            label: `‡∏õ‡∏µ ${previousYear + 543}`,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            data: previousYearData,
                            order: 2
                        }, {
                            type: 'bar',
                            label: `‡∏õ‡∏µ ${currentYear + 543}`,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            data: currentYearData,
                            order: 2
                        }, {
                            type: 'line',
                            label: `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ‡∏õ‡∏µ ${previousYear + 543}`,
                            borderColor: '#1e40af',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            data: previousYearTrend,
                            order: 1,
                            tension: 0.4
                        }, {
                            type: 'line',
                            label: `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ‡∏õ‡∏µ ${currentYear + 543}`,
                            borderColor: '#059669',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            data: currentYearTrend,
                            order: 1,
                            tension: 0.4
                        }]
                    };
                    
                    const config = {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏õ‡∏µ ${previousYear + 543} vs ‡∏õ‡∏µ ${currentYear + 543}`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    color: '#374151'
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: '#374151',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (value === null || value === undefined) return null;
                                            return `${context.dataset.label}: ${formatPrice(value)} ‡∏ö‡∏≤‡∏ó`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        },
                                        color: '#6b7280'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.3)'
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        },
                                        color: '#6b7280',
                                        callback: function(value) {
                                            return formatPrice(value) + ' ‡∏ö‡∏≤‡∏ó';
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    chartInstance.current = new Chart(ctx, config);
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, currentYear, previousYear]);
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div className="relative h-96">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };
        
        // Progress Bar Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        const ComparisonProgressBar = ({ currentValue, previousValue, title, unit = "‡∏ö‡∏≤‡∏ó" }) => {
            const difference = currentValue - previousValue;
            const percentageChange = previousValue > 0 ? ((difference / previousValue) * 100) : 0;
            const isIncrease = difference > 0;
            const isSaving = difference < 0;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á progress bar (0-100%)
            const maxValue = Math.max(currentValue, previousValue);
            const currentPercentage = maxValue > 0 ? (currentValue / maxValue) * 100 : 0;
            const previousPercentage = maxValue > 0 ? (previousValue / maxValue) * 100 : 0;
            
            return (
                <div className="bg-white p-6 rounded-lg shadow-md border">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
                    
                    {/* ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß */}
                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span className="text-sm font-semibold text-blue-600">{formatPrice(previousValue)} {unit}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                className="bg-blue-500 h-3 rounded-full transition-all duration-500 ease-out"
                                style={{ width: `${previousPercentage}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô */}
                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                            <span className={`text-sm font-semibold ${isIncrease ? 'text-red-600' : 'text-green-600'}`}>
                                {formatPrice(currentValue)} {unit}
                            </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                className={`h-3 rounded-full transition-all duration-500 ease-out ${
                                    isIncrease ? 'bg-red-500' : 'bg-green-500'
                                }`}
                                style={{ width: `${currentPercentage}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á */}
                    <div className={`p-4 rounded-lg ${
                        isSaving ? 'bg-green-50 border border-green-200' : 
                        isIncrease ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'
                    }`}>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <div className={`w-3 h-3 rounded-full mr-2 ${
                                    isSaving ? 'bg-green-500' : 
                                    isIncrease ? 'bg-red-500' : 'bg-gray-500'
                                }`}></div>
                                <span className="text-sm font-medium text-gray-700">
                                    {isSaving ? '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î' : isIncrease ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô' : '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á'}
                                </span>
                            </div>
                            <div className="text-right">
                                <div className={`text-lg font-bold ${
                                    isSaving ? 'text-green-600' : 
                                    isIncrease ? 'text-red-600' : 'text-gray-600'
                                }`}>
                                    {formatPrice(Math.abs(difference))} {unit}
                                </div>
                                <div className={`text-sm ${
                                    isSaving ? 'text-green-500' : 
                                    isIncrease ? 'text-red-500' : 'text-gray-500'
                                }`}>
                                    {Math.abs(percentageChange).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ##################################################################
        // ### CARBON REDUCTION CALCULATION FUNCTIONS ###
        // ##################################################################
        
        // Emission factors (kg CO2 per liter) from TGO Thailand <mcreference link="https://thaicarbonlabel.tgo.or.th/index.php?lang=EN&mod=YjNKbllXNXBlbUYwYVc5dVgyVnRhWE56YVc5dQ" index="1">1</mcreference>
        const EMISSION_FACTORS = {
            gasoline: 2.181564,  // Motor gasoline
            diesel: 2.698722     // Gas/Diesel oil
        };
        
        // Function to calculate carbon reduction from fuel savings
        const calculateCarbonReduction = (fuelSavingsLiters, fuelType = 'diesel') => {
            const emissionFactor = EMISSION_FACTORS[fuelType] || EMISSION_FACTORS.diesel;
            return fuelSavingsLiters * emissionFactor; // kg CO2
        };
        
        // Function to estimate fuel consumption from cost (approximate)
        const estimateFuelConsumptionFromCost = (fuelCost, avgFuelPrice = 35) => {
            return fuelCost / avgFuelPrice; // liters (approximate)
        };
        
        // Function to calculate carbon reduction from cost savings
        const calculateCarbonReductionFromCostSavings = (costSavings, avgFuelPrice = 35, fuelType = 'diesel') => {
            if (costSavings <= 0) return 0;
            const fuelSavingsLiters = estimateFuelConsumptionFromCost(costSavings, avgFuelPrice);
            return calculateCarbonReduction(fuelSavingsLiters, fuelType);
        };
        
        // Function to format carbon reduction display
        const formatCarbonReduction = (carbonKg) => {
            if (carbonKg >= 1000) {
                return `${(carbonKg / 1000).toFixed(2)} ‡∏ï‡∏±‡∏ô`;
            } else {
                return `${carbonKg.toFixed(2)} ‡∏Å‡∏Å.`;
            }
        };
        
        const EnergyComparisonApp = ({ fuelData, evData }) => {
            const today = new Date();
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(today.getMonth()); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!fuelData || !fuelData.supply) {
                return (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                        <div className="text-center p-8 text-gray-600">
                            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                        </div>
                    </div>
                );
            }

            const { uniqueYears, availableMonths } = useMemo(() => {
                const years = new Set();
                const months = new Set();
                const supply = fuelData?.supply || [];
                supply.forEach(item => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                    if (date) {
                        years.add(date.getFullYear());
                        if (date.getFullYear() === selectedYear) {
                            months.add(date.getMonth());
                        }
                    }
                });
                
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if (years.size === 0) {
                    const currentYear = new Date().getFullYear();
                    years.add(currentYear);
                }
                
                return { 
                    uniqueYears: Array.from(years).sort((a, b) => b - a),
                    availableMonths: Array.from(months).sort((a, b) => a - b)
                };
            }, [fuelData, selectedYear]);

            const comparisonData = useMemo(() => {
                const fuel = (fuelData?.supply || []).filter(item => item['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å SAP'] !== '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤');

                const getMonthlyFuelCost = (year, month) => {
                    return fuel.filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        if (!date) return false;
                        return date.getFullYear() === year && date.getMonth() === month;
                    }).reduce((sum, item) => sum + (Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0), 0);
                };

                const currentMonthCost = getMonthlyFuelCost(selectedYear, selectedMonth);
                const previousMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
                const previousMonthYear = selectedMonth === 0 ? selectedYear - 1 : selectedYear;
                const previousMonthCost = getMonthlyFuelCost(previousMonthYear, previousMonth);
                
                const difference = currentMonthCost - previousMonthCost;
                const percentageChange = previousMonthCost > 0 ? ((difference / previousMonthCost) * 100) : 0;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
                const daysInCurrentMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
                const daysInPreviousMonth = new Date(previousMonthYear, previousMonth + 1, 0).getDate();
                const avgCurrentMonthPerDay = currentMonthCost / daysInCurrentMonth;
                const avgPreviousMonthPerDay = previousMonthCost / daysInPreviousMonth;
                const avgDailyDifference = avgCurrentMonthPerDay - avgPreviousMonthPerDay;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ
                const getYearlyFuelCost = (year) => {
                    return fuel.filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        if (!date) return false;
                        return date.getFullYear() === year;
                    }).reduce((sum, item) => sum + (Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0), 0);
                };
                
                const currentYearTotal = getYearlyFuelCost(selectedYear);
                const previousYearTotal = getYearlyFuelCost(selectedYear - 1);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô
                const yearlyFuelSavings = previousYearTotal - currentYearTotal;
                const yearlyFuelSavingsPercentage = previousYearTotal > 0 ? ((yearlyFuelSavings / previousYearTotal) * 100) : 0;
                const yearlyCarbonReduction = yearlyFuelSavings > 0 ? calculateCarbonReductionFromCostSavings(yearlyFuelSavings) : 0;
                const previousYearCarbonTotal = calculateCarbonReductionFromCostSavings(previousYearTotal);
                const yearlyCarbonReductionPercentage = previousYearCarbonTotal > 0 ? ((yearlyCarbonReduction / previousYearCarbonTotal) * 100) : 0;

                return {
                    currentMonthCost,
                    previousMonthCost,
                    difference,
                    percentageChange,
                    avgCurrentMonthPerDay,
                    avgPreviousMonthPerDay,
                    avgDailyDifference,
                    currentMonthName: getThaiMonthName(selectedMonth),
                    previousMonthName: getThaiMonthName(previousMonth),
                    previousMonthYear,
                    currentYearTotal,
                    previousYearTotal,
                    yearlyFuelSavings,
                    yearlyFuelSavingsPercentage,
                    yearlyCarbonReduction,
                    yearlyCarbonReductionPercentage
                };

            }, [fuelData, selectedYear, selectedMonth]);



            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {availableMonths.map(month => <option key={month} value={month}>{getThaiMonthName(month)}</option>)}
                        </select>
                    </div>

                    {/* ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß */}
                    <div className="mb-6">
                        <div className="text-center mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">
                                ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö {comparisonData.currentMonthName} {selectedYear + 543} ‡∏Å‡∏±‡∏ö {comparisonData.previousMonthName} {comparisonData.previousMonthYear + 543}
                            </h3>
                        </div>
                        
                        <ComparisonProgressBar 
                            currentValue={comparisonData.currentMonthCost}
                            previousValue={comparisonData.previousMonthCost}
                            title="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°"
                            unit="‡∏ö‡∏≤‡∏ó"
                        />
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
                        <SummaryCard 
                            title={`${comparisonData.currentMonthName} ${selectedYear + 543}`}
                            value={formatPrice(comparisonData.currentMonthCost)}
                            unit="‡∏ö‡∏≤‡∏ó"
                            icon={<img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" className="w-8 h-8"/>}
                            color={{bg:'bg-blue-100', border:'border-blue-500'}}
                        />
                        <SummaryCard 
                            title={`${comparisonData.previousMonthName} ${comparisonData.previousMonthYear + 543}`}
                            value={formatPrice(comparisonData.previousMonthCost)}
                            unit="‡∏ö‡∏≤‡∏ó"
                            icon={<img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" className="w-8 h-8"/>}
                            color={{bg:'bg-gray-100', border:'border-gray-500'}}
                        />
                        <SummaryCard 
                            title="‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô"
                            value={formatPrice(Math.abs(comparisonData.avgDailyDifference))}
                            unit={comparisonData.avgDailyDifference >= 0 ? "‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°)" : "‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô (‡∏•‡∏î)"}
                            icon={<Icons name="balance"/>}
                            color={{bg: comparisonData.avgDailyDifference >= 0 ? 'bg-red-100' : 'bg-green-100', border: comparisonData.avgDailyDifference >= 0 ? 'border-red-500' : 'border-green-500'}}
                        />
                        <SummaryCard 
                            title="‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ"
                            value={comparisonData.currentYearTotal < comparisonData.previousYearTotal ? formatCarbonReduction(calculateCarbonReductionFromCostSavings(comparisonData.previousYearTotal - comparisonData.currentYearTotal)) : '0 ‡∏Å‡∏Å.'}
                            unit="CO‚ÇÇ"
                            icon={<span className="text-2xl">üå±</span>}
                            color={{bg:'bg-green-100', border:'border-green-500'}}
                            footerText={comparisonData.currentYearTotal < comparisonData.previousYearTotal ? `‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ ${formatPrice(comparisonData.previousYearTotal - comparisonData.currentYearTotal)} ‡∏ö‡∏≤‡∏ó` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î'}
                        />
                        <SummaryCard 
                            title="% ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô"
                            value={comparisonData.yearlyFuelSavingsPercentage > 0 ? comparisonData.yearlyFuelSavingsPercentage.toFixed(2) : '0'}
                            unit="%"
                            icon={<span className="text-2xl">‚õΩ</span>}
                            color={{bg: comparisonData.yearlyFuelSavingsPercentage > 0 ? 'bg-blue-100' : 'bg-gray-100', border: comparisonData.yearlyFuelSavingsPercentage > 0 ? 'border-blue-500' : 'border-gray-500'}}
                            footerText={`‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ${selectedYear - 1 + 543}`}
                        />
                        <SummaryCard 
                            title="% ‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô"
                            value={comparisonData.yearlyCarbonReductionPercentage > 0 ? comparisonData.yearlyCarbonReductionPercentage.toFixed(2) : '0'}
                            unit="%"
                            icon={<span className="text-2xl">üåç</span>}
                            color={{bg: comparisonData.yearlyCarbonReductionPercentage > 0 ? 'bg-emerald-100' : 'bg-gray-100', border: comparisonData.yearlyCarbonReductionPercentage > 0 ? 'border-emerald-500' : 'border-gray-500'}}
                            footerText={`‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ${selectedYear - 1 + 543}`}
                        />                    </div>

                    {/* Cards ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */}
                    <div className="mt-8">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ {selectedYear + 543}</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {Array.from({length: 12}, (_, index) => {
                                const month = index + 1;
                                const supply = fuelData?.supply || [];
                                const monthData = supply.filter(item => {
                                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                                    return date && date.getFullYear() === selectedYear && date.getMonth() + 1 === month;
                                });
                                
                                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                                const previousMonth = month === 1 ? 12 : month - 1;
                                const previousYear = month === 1 ? selectedYear - 1 : selectedYear;
                                const previousMonthData = supply.filter(item => {
                                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                                    return date && date.getFullYear() === previousYear && date.getMonth() + 1 === previousMonth;
                                });
                                
                                const monthCost = monthData.reduce((sum, item) => sum + (Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0), 0);
                                const previousMonthCost = previousMonthData.reduce((sum, item) => sum + (Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0), 0);
                                const savings = previousMonthCost - monthCost; // ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î = ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                const monthName = getThaiMonthName(month);
                                const hasData = monthData.length > 0;
                                const hasPreviousData = previousMonthData.length > 0;
                                
                                return (
                                    <div key={month} className={`p-4 rounded-lg border-2 transition-all duration-200 hover:shadow-md ${
                                        hasData 
                                            ? month === selectedMonth + 1
                                                ? 'bg-blue-50 border-blue-500 shadow-md' 
                                                : 'bg-white border-gray-200 hover:border-blue-300'
                                            : 'bg-gray-50 border-gray-200 opacity-60'
                                    }`}>
                                        <div className="text-center">
                                            <div className={`text-sm font-medium mb-2 ${
                                                hasData ? 'text-gray-700' : 'text-gray-400'
                                            }`}>
                                                {monthName}
                                            </div>
                                            <div className={`text-lg font-bold ${
                                                hasData 
                                                    ? month === selectedMonth + 1
                                                        ? 'text-blue-600' 
                                                        : 'text-gray-800'
                                                    : 'text-gray-400'
                                            }`}>
                                                {hasData ? formatPrice(monthCost) : '0'}
                                            </div>
                                            <div className={`text-xs ${
                                                hasData ? 'text-gray-500' : 'text-gray-400'
                                            }`}>
                                                ‡∏ö‡∏≤‡∏ó
                                            </div>
                                            {hasData && (
                                                <div className="text-xs text-gray-500 mt-1">
                                                    {monthData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                                </div>
                                            )}
                                            {hasData && hasPreviousData && (
                                                <>
                                                    <div className={`text-xs mt-1 font-medium ${
                                                        savings > 0 ? 'text-green-600' : 
                                                        savings < 0 ? 'text-red-600' : 'text-gray-500'
                                                    }`}>
                                                        {savings > 0 ? '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î ' : savings < 0 ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ' : '‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° '}
                                                        {Math.abs(savings) > 0 ? formatPrice(Math.abs(savings)) : '0'}
                                                    </div>
                                                    {savings > 0 && (
                                                        <div className="text-xs mt-1 text-green-700 font-medium">
                                                            <span className="text-green-600">üå±</span> ‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô {formatCarbonReduction(calculateCarbonReductionFromCostSavings(savings))}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                            {hasData && !hasPreviousData && (
                                                <div className="text-xs text-gray-400 mt-1">
                                                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ##################################################################
        // ### EV IMPACT APP (START) ###
        // ##################################################################
        const EVImpactApp = ({ fuelData, evData }) => {
            const today = new Date();
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState('all'); // 'all' for the whole year

            const { uniqueYears } = useMemo(() => {
                const years = new Set();
                (fuelData?.supply || []).forEach(item => {
                    const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                    if (date) years.add(date.getFullYear());
                });
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [fuelData]);

            const comparisonData = useMemo(() => {
                const currentYear = selectedYear;
                const previousYear = selectedYear - 1;
                
                const fuel = (fuelData?.supply || []).filter(item => item['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å SAP'] !== '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤');
                
                const getYearlyData = (year) => {
                    const yearData = fuel.filter(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        return date && date.getFullYear() === year;
                    });
                    
                    const monthlyData = Array(12).fill(0);
                    let totalCost = 0;
                    
                    yearData.forEach(item => {
                        const date = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
                        if (date) {
                            const month = date.getMonth();
                            const cost = Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0;
                            monthlyData[month] += cost;
                            totalCost += cost;
                        }
                    });
                    
                    return { monthlyData, totalCost };
                };
                
                const currentYearData = getYearlyData(currentYear);
                const previousYearData = getYearlyData(previousYear);
                
                const totalDifference = currentYearData.totalCost - previousYearData.totalCost;
                const avgDailyDifference = totalDifference / 365;
                
                const monthlyChartData = Array(12).fill(0).map((_, month) => {
                    const currentMonthCost = currentYearData.monthlyData[month];
                    const previousMonthCost = previousYearData.monthlyData[month];
                    const difference = currentMonthCost - previousMonthCost;
                    
                    return {
                        month,
                        currentYear: currentMonthCost,
                        previousYear: previousMonthCost,
                        difference: difference
                    };
                });
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ
                const yearlyFuelSavingsPercentage = previousYearData.totalCost > 0 
                    ? ((previousYearData.totalCost - currentYearData.totalCost) / previousYearData.totalCost) * 100 
                    : 0;
                
                return {
                    currentYearTotal: currentYearData.totalCost,
                    previousYearTotal: previousYearData.totalCost,
                    totalDifference,
                    avgDailyDifference,
                    yearlyFuelSavingsPercentage,
                    monthlyChartData
                };
            }, [fuelData, selectedYear]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value === 'all' ? 'all' : Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
                            {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
                        <SummaryCard title={`‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏µ ${selectedYear - 1 + 543}`} value={formatPrice(comparisonData.previousYearTotal)} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', border:'border-blue-500'}}/>
                        <SummaryCard title={`‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏µ ${selectedYear + 543}`} value={formatPrice(comparisonData.currentYearTotal)} unit="‡∏ö‡∏≤‡∏ó" icon={<Icons name="balance"/>} color={{bg:'bg-green-100', border:'border-green-500'}}/>
                        <SummaryCard title="‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" value={formatPrice(Math.abs(comparisonData.totalDifference))} unit={comparisonData.totalDifference >= 0 ? "‡∏ö‡∏≤‡∏ó (‡πÄ‡∏û‡∏¥‡πà‡∏°)" : "‡∏ö‡∏≤‡∏ó (‡∏•‡∏î)"} icon={<Icons name="balance"/>} color={{bg: comparisonData.totalDifference >= 0 ? 'bg-red-100' : 'bg-yellow-100', border: comparisonData.totalDifference >= 0 ? 'border-red-500' : 'border-yellow-500'}}/>
                        <SummaryCard title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô" value={formatPrice(Math.abs(comparisonData.avgDailyDifference))} unit={comparisonData.avgDailyDifference >= 0 ? "‡∏ö‡∏≤‡∏ó (‡πÄ‡∏û‡∏¥‡πà‡∏°)" : "‡∏ö‡∏≤‡∏ó (‡∏•‡∏î)"} icon={<Icons name="balance"/>} color={{bg: comparisonData.avgDailyDifference >= 0 ? 'bg-red-100' : 'bg-yellow-100', border: comparisonData.avgDailyDifference >= 0 ? 'border-red-500' : 'border-yellow-500'}}/>
                        <SummaryCard title="‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ" value={formatCarbonReduction(calculateCarbonReductionFromCostSavings(Math.abs(comparisonData.totalDifference)))} unit="CO‚ÇÇ" icon={<Icons name="leaf"/>} color={{bg:'bg-emerald-100', border:'border-emerald-500'}}/>
                        <SummaryCard 
                            title="% ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ" 
                            value={comparisonData.yearlyFuelSavingsPercentage >= 0 ? comparisonData.yearlyFuelSavingsPercentage.toFixed(2) : '0.00'} 
                            unit={comparisonData.yearlyFuelSavingsPercentage >= 0 ? '% (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î)' : '% (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô)'} 
                            icon={<span className="text-lg">‚õΩ</span>} 
                            color={{bg: comparisonData.yearlyFuelSavingsPercentage >= 0 ? 'bg-green-100' : 'bg-red-100', border: comparisonData.yearlyFuelSavingsPercentage >= 0 ? 'border-green-500' : 'border-red-500'}} 
                            footer={`‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ${selectedYear - 1 + 543}`}
                        />
                    </div>
                    
                    <MonthlyComparisonLineChart data={comparisonData.monthlyChartData} currentYear={selectedYear} previousYear={selectedYear - 1} />
                </div>
            );
        };
        
        // ##################################################################
        // ### BREAKEVEN APP (START) ###
        // ##################################################################
        const BreakevenApp = ({ repairData, fuelData, evData }) => {
            // --- CONFIGURATIONS ---
            const EV_CONFIG = {
              'TT-19': { name: 'TT-19', price: 533930 },
              'TT-20': { name: 'TT-20', price: 1660000 },
              'TT-21': { name: 'TT-21', price: 1660000 },
              'TT-22': { name: 'TT-22', price: 1660000 },
              'TT-23': { name: 'TT-23', price: 1660000 },
            };
            const ICE_VEHICLES_FOR_COMPARISON = ['TT-02', 'TT-03', 'TT-06', 'TT-07', 'TT-08', 'TT-09', 'TT-10', 'TT-11', 'TT-12', 'TT-13', 'TT-15', 'TT-16', 'TT-17', 'TT-18'];

            // --- CALCULATIONS ---
            const iceBenchmarkCosts = useMemo(() => {
                if (!repairData || !fuelData?.supply) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const relevantRepairData = repairData.filter(item => ICE_VEHICLES_FOR_COMPARISON.includes(item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']));
                const relevantFuelData = fuelData.supply.filter(item => ICE_VEHICLES_FOR_COMPARISON.includes(item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ']));

                const allData = [...relevantRepairData.map(i => i['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']), ...relevantFuelData.map(i => i['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])];
                const validDates = allData.map(d => parseDate(d)).filter(Boolean);
                
                if (validDates.length < 2) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const minDate = new Date(Math.min.apply(null, validDates));
                const maxDate = new Date(Math.max.apply(null, validDates));
                const durationYears = (maxDate - minDate) / (1000 * 60 * 60 * 24 * 365.25);

                if (durationYears <= 0) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const totalRepairCost = relevantRepairData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const totalFuelCost = relevantFuelData.reduce((sum, item) => sum + (Number(item['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô']) || 0), 0);
                
                const totalFleetCost = totalRepairCost + totalFuelCost;
                const avgAnnualCostForFleet = totalFleetCost / durationYears;
                const avgAnnualCostPerVehicle = avgAnnualCostForFleet / ICE_VEHICLES_FOR_COMPARISON.length;

                return { totalRepairCost, totalFuelCost, avgAnnualCostPerVehicle, durationYears };
            }, [repairData, fuelData]);

            const evAnnualCosts = useMemo(() => {
                if (!repairData || !evData) return {};
                const EV_START_DATE = new Date('2025-08-01');
                const today = new Date(); // Use current date for calculation
                
                // Ensure we don't divide by zero or a tiny number if the app is run on the start date
                const timeDiff = today - EV_START_DATE;
                if (timeDiff <= 0) return {};
                
                const durationYears = timeDiff / (1000 * 60 * 60 * 24 * 365.25);

                const costs = {};
                Object.keys(EV_CONFIG).forEach(evPlate => {
                    const evRepairData = repairData.filter(item => item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ'] === evPlate && parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°(APP)']) >= EV_START_DATE);
                    const totalRepairCost = evRepairData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                    
                    const evChargeData = evData.filter(item => item.licensePlate === evPlate);
                    const totalChargeCost = evChargeData.reduce((sum, item) => sum + (Number(item.electricityCost) || 0), 0);

                    const totalCost = totalRepairCost + totalChargeCost;
                    const annualCost = totalCost / durationYears;
                    costs[evPlate] = annualCost;
                });
                return costs;
            }, [repairData, evData]);

            const breakevenPoints = useMemo(() => {
                return Object.values(EV_CONFIG).map(ev => {
                    const initialCost = ev.price;
                    const evAnnualCost = evAnnualCosts[ev.name] || 0;
                    const iceAnnualCost = iceBenchmarkCosts.avgAnnualCostPerVehicle;
                    const annualSavings = iceAnnualCost - evAnnualCost;

                    if (annualSavings <= 0) {
                        return { ...ev, evAnnualCost, annualSavings, yearsToBreakeven: Infinity };
                    }
                    const yearsToBreakeven = initialCost / annualSavings;
                    return { ...ev, initialCost, evAnnualCost, annualSavings, yearsToBreakeven };
                });
            }, [EV_CONFIG, iceBenchmarkCosts, evAnnualCosts]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6 space-y-6">
                    <h2 className="text-xl font-bold text-gray-800">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (EV Break-Even Analysis)</h2>
                    
                    {/* Costs Summary Section */}
                     <div className="p-4 border rounded-lg bg-blue-50">
                        <h3 className="font-semibold text-lg text-blue-800">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏™‡∏±‡∏ô‡∏î‡∏≤‡∏õ (Benchmark)</h3>
                        <p className="text-sm text-blue-600 mb-2">
                            ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á {formatNumber(iceBenchmarkCosts.durationYears, 1)} ‡∏õ‡∏µ ‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ {ICE_VEHICLES_FOR_COMPARISON.length} ‡∏Ñ‡∏±‡∏ô
                        </p>
                        <div className="text-3xl font-bold text-blue-900">{formatPrice(iceBenchmarkCosts.avgAnnualCostPerVehicle)}</div>
                        <div className="text-md text-blue-700">‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏±‡∏ô/‡∏õ‡∏µ</div>
                    </div>

                    {/* Results Table */}
                    <div className="overflow-x-auto">
                        <h3 className="font-semibold text-lg text-slate-800 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô</h3>
                        <p className="text-sm text-slate-600 mb-3">
                            ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ‡∏à‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ EV ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÑ‡∏õ
                        </p>
                        <table className="w-full text-sm text-left text-gray-700 border-collapse">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th className="px-4 py-3 border">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏ñ EV</th>
                                    <th className="px-4 py-3 border text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ EV (‡∏ö‡∏≤‡∏ó)</th>
                                    <th className="px-4 py-3 border text-right">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ EV ‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏ö‡∏≤‡∏ó)</th>
                                    <th className="px-4 py-3 border text-right">‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏ö‡∏≤‡∏ó)</th>
                                    <th className="px-4 py-3 border text-right">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô (‡∏õ‡∏µ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {breakevenPoints.map(ev => (
                                    <tr key={ev.name} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-4 py-3 border font-medium">{ev.name}</td>
                                        <td className="px-4 py-3 border text-right">{formatPrice(ev.price)}</td>
                                        <td className="px-4 py-3 border text-right text-red-600">{formatPrice(ev.evAnnualCost)}</td>
                                        <td className={`px-4 py-3 border text-right font-semibold ${ev.annualSavings > 0 ? 'text-green-700' : 'text-red-700'}`}>{formatPrice(ev.annualSavings)}</td>
                                        <td className="px-4 py-3 border text-right font-bold text-indigo-700">
                                            {isFinite(ev.yearsToBreakeven) ? formatNumber(ev.yearsToBreakeven, 1) : '‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        // ### BREAKEVEN APP (END) ###


        // ##################################################################
        // ### MAIN APP COMPONENT (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å) ###
        // ##################################################################
        const App = () => {
            const [activeApp, setActiveApp] = useState('repair'); // 'repair', 'fuel', 'ev', 'energy', 'ev_impact', 'breakeven'
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const fetchDataFromScript = async () => {
                if (SCRIPT_URL === 'YOUR_CONSOLIDATED_WEB_APP_URL_HERE') {
                    setError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                    setLoading(false);
                    return;
                }
                setLoading(true);
                setError(null);
                try {
                    // Initialize Firebase
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const auth = window.firebase.getAuth(app);
                    const db = window.firebase.getFirestore(app);

                    // Authenticate anonymously first
                    console.log('Attempting anonymous authentication...');
                    const userCredential = await window.firebase.signInAnonymously(auth);
                    console.log('Authentication successful:', userCredential.user.uid);

                    // Fetch from Google Sheet and Firebase in parallel
                    console.log('Fetching data from Google Sheet and Firestore...');
                    const [sheetResponse, historySnapshot] = await Promise.all([
                        fetch(SCRIPT_URL),
                        window.firebase.getDocs(window.firebase.query(
                            window.firebase.collection(db, `artifacts/tmtev-2025/history`),
                            window.firebase.orderBy("date", "desc")
                        )).catch(error => {
                            console.error('Firestore error:', error);
                            throw error;
                        })
                    ]);

                    if (!sheetResponse.ok) {
                        throw new Error(`Google Script fetch failed with status ${sheetResponse.status}`);
                    }
                    const sheetJson = await sheetResponse.json();
                    if (sheetJson.error) throw new Error(sheetJson.error);

                    const historyList = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    setData({
                        repairData: sheetJson.repairData,
                        fuelData: sheetJson.fuelData,
                        evData: historyList
                    });

                } catch (err) {
                    console.error("Error fetching data:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchDataFromScript();
            }, []);

            const renderActiveApp = () => {
                if (loading) return <Loader text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î..." />;
                if (error) return <div className="text-center p-8 text-red-600 bg-red-100 rounded-lg m-4"><strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> {error}</div>;
                if (!data) return <div className="text-center p-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>;

                switch (activeApp) {
                    case 'repair':
                        return <RepairApp data={data.repairData} isMobile={isMobile} />;
                    case 'fuel':
                        return <FuelApp data={data.fuelData} />;
                    case 'ev':
                        return <EVChargingApp data={data.evData} />;
                    case 'energy':
                        return <EnergyComparisonApp fuelData={data.fuelData} evData={data.evData} />;
                    case 'ev_impact':
                        return <EVImpactApp fuelData={data.fuelData} evData={data.evData} />;
                    case 'breakeven':
                        return <BreakevenApp repairData={data.repairData} fuelData={data.fuelData} evData={data.evData} />;
                    default:
                        return null;
                }
            };

            return (
                <div className="container mx-auto p-4 sm:p-6">
                    <header className="mb-6">
                        <div className="header-container flex flex-col items-center">
                            <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 text-center">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Material handling</h1>
                             <button type="button" className="refresh-button" onClick={fetchDataFromScript} disabled={loading}>
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                fill="currentColor"
                                className="bi bi-arrow-repeat"
                                viewBox="0 0 16 16"
                              >
                                <path
                                  d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                                ></path>
                                <path
                                  fillRule="evenodd"
                                  d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                                ></path>
                              </svg>
                              <span className="refresh-text">Refresh</span>
                            </button>
                        </div>
                        <nav className="main-nav-container mt-6 flex justify-center">
                            <div className="button-container">
                                <button title="‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" className={`nav-button ${activeApp === 'repair' ? 'active' : ''}`} onClick={() => setActiveApp('repair')}>
                                    <Icons name="toolbox" className="w-6 h-6" />
                                    <span className="nav-text">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</span>
                                </button>
                                <button title="‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" className={`nav-button ${activeApp === 'fuel' ? 'active' : ''}`} onClick={() => setActiveApp('fuel')}>
                                    <img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" alt="‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" className="w-6 h-6" />
                                    <span className="nav-text">‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</span>
                                </button>
                                <button title="‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏üEV" className={`nav-button ${activeApp === 'ev' ? 'active' : ''}`} onClick={() => setActiveApp('ev')}>
                                    <Icons name="bolt" className="w-6 h-6" />
                                    <span className="nav-text">‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏üEV</span>
                                </button>
                                <button title="‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" className={`nav-button ${activeApp === 'energy' ? 'active' : ''}`} onClick={() => setActiveApp('energy')}>
                                    <Icons name="balance" className="w-6 h-6" />
                                    <span className="nav-text">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>
                                </button>
                                <button title="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î EV" className={`nav-button ${activeApp === 'ev_impact' ? 'active' : ''}`} onClick={() => setActiveApp('ev_impact')}>
                                     <dotlottie-wc src="https://lottie.host/ddc40909-2718-4242-927f-e3fda3ac77ca/L8DWV25LrA.lottie" style={{width: '24px', height: '24px'}} speed="1" autoplay loop></dotlottie-wc>
                                    <span className="nav-text">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</span>
                                </button>
                                <button title="‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô EV" className={`nav-button ${activeApp === 'breakeven' ? 'active' : ''}`} onClick={() => setActiveApp('breakeven')}>
                                     <Icons name="calculator" className="w-6 h-6" />
                                    <span className="nav-text">‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô EV</span>
                                </button>
                            </div>
                        </nav>
                    </header>
                    <main>
                        {renderActiveApp()}
                    </main>
                </div>
            );
        };

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
