

<!DOCTYPE html>
<html lang="th">
<head>
<link rel="icon" type="image/png" href="https://img.icons8.com/?size=64&id=xVnReHOxsQVt&format=png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>รายงานค่าใช้จ่าย Material handling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .pagination-btn { transition: background-color: 0.2s; }
        .pagination-btn-active { background-color: #2563eb; color: white; }
        .pagination-btn-inactive { background-color: white; color: #374151; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Refresh Button */
        .refresh-button {
          color: white;
          background-color: #222;
          font-weight: 500;
          border-radius: 0.5rem;
          font-size: 1rem;
          line-height: 2rem;
          padding-left: 2rem;
          padding-right: 2rem;
          padding-top: 0.7rem;
          padding-bottom: 0.7rem;
          cursor: pointer;
          text-align: center;
          margin-right: 0.5rem;
          display: inline-flex;
          align-items: center;
          border: none;
        }

        .refresh-button:hover {
          background-color: #333;
        }

        .refresh-button svg {
          display: inline;
          width: 1.3rem;
          height: 1.3rem;
          margin-right: 0.75rem;
          color: white;
        }

        .refresh-button:focus svg {
          animation: spin_357 0.5s linear;
        }
        
        /* Main Nav */
        .button-container {
          display: flex;
          background-color: rgb(27, 133, 219);
          width: 540px; /* Increased width for new button */
          height: 60px;
          align-items: center;
          justify-content: space-around;
          border-radius: 10px;
          box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px,
            rgba(27, 133, 219, 0.5) 5px 10px 15px;
        }

        .nav-button {
          outline: 0 !important;
          border: 0 !important;
          width: 80px;
          height: 100%;
          border-radius: 10px;
          background-color: transparent;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          color: #fff;
          transition: all ease-in-out 0.3s;
          cursor: pointer;
          padding: 4px 0;
        }

        .nav-button:hover {
          transform: translateY(-3px);
        }
        
        .nav-button.active {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .nav-text {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        @keyframes spin_357 {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }
        
        /* New Radio Tabs for RepairApp */
        .radio-input {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          background-color: #e2e8f0;
          padding: 4px;
          border-radius: 10px;
        }

        .radio-input input {
          display: none;
        }

        .radio-input .label {
          flex: 1 1 auto;
          min-width: 120px;
          height: 50px;
          background-color: #ffffff;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          transition: all 0.15s ease-in-out;
          cursor: pointer;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .radio-input .label:has(input[type="radio"]:checked) {
          background-color: #2563eb;
          box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        .radio-input .label .text {
          color: #334155;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.15s ease-in-out;
        }

        .radio-input .label:has(input[type="radio"]:checked) .text {
          color: white;
        }


        /* Mobile adjustments */
        @media (max-width: 768px) {
            body {
                padding-bottom: 80px; /* Space for bottom nav */
            }
            .header-container {
                position: relative;
                padding-top: 50px; /* Space for refresh button */
            }
            .refresh-button {
                position: absolute;
                top: 0;
                right: 0;
                padding: 0.5rem;
                width: 40px;
                height: 40px;
                border-radius: 50%;
            }
            .refresh-button .refresh-text {
                display: none;
            }
            .refresh-button svg {
                margin: 0;
                width: 1.5rem;
                height: 1.5rem;
            }
            .main-nav-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                padding: 10px 0;
                background-color: #f1f5f9; /* Match body background */
                display: flex;
                justify-content: center;
                border-top: 1px solid #e2e8f0;
            }
            .button-container {
                width: 100%;
                max-width: 540px;
            }
        }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
    
    <!-- Lottie Animation Player -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        window.firebase = { initializeApp, getFirestore, collection, getDocs, query, orderBy, getAuth, signInAnonymously };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';

        // ##################################################################
        // ### CONFIGURATIONS ###
        // ##################################################################
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwp0yu3ryGYYaaSIkTkOs64BFI3CYllPcQPJe3HcpldhPqHnggmmjTC1uSOV_xHLpUh/exec'; 
        
        const firebaseConfig = {
          apiKey: "AIzaSyAtlLnWd2Rkbx48Gt2LSrqLrtFr1a7A46w",
          authDomain: "tmtev-2025.firebaseapp.com",
          projectId: "tmtev-2025",
          storageBucket: "tmtev-2025.firebasestorage.app",
          messagingSenderId: "224826852272",
          appId: "1:224826852272:web:fd9c9805ea55747edc0c75",
          measurementId: "G-KYW1JLVFHX"
        };

        // ##################################################################
        // ### UTILITY FUNCTIONS (ฟังก์ชันช่วยเหลือ) ###
        // ##################################################################
        const parseDate = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null;
            if (date.getFullYear() > 2200) { date.setFullYear(date.getFullYear() - 543); }
            return date;
        };
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'Invalid Date';
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        const formatSimpleDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'Invalid Date';
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const formatTime = (timeValue) => {
            if (!timeValue) return 'N/A';
            const date = new Date(timeValue);
            if (isNaN(date.getTime())) {
                return 'Invalid Time';
            }
            return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        };
        const formatNumber = (num, digits = 2) => {
            const number = Number(num);
            if (isNaN(number)) return '0.00';
            return number.toLocaleString('th-TH', { minimumFractionDigits: digits, maximumFractionDigits: digits });
        };
        const formatPrice = (price) => formatNumber(price, 2);
        const getThaiMonthName = (monthIndex) => ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'][monthIndex];
        const calculateTotalSparePartsPrice = (priceString) => {
            if (!priceString) return 0;
            return String(priceString).split(/[,;|+]/).map(p => parseFloat(p.trim())).filter(p => !isNaN(p)).reduce((sum, current) => sum + current, 0);
        };
        const calculateTotalCost = (item) => {
            const sparePartsPrice = calculateTotalSparePartsPrice(item['ราคาอะไหล่']);
            const servicePrice = parseFloat(String(item['ราคา'])) || 0;
            return sparePartsPrice + servicePrice;
        };
        const sumDurations = (durations) => {
            if (!durations || durations.length === 0) return '00:00';
            const totalMinutes = durations.reduce((acc, duration) => {
                const minutes = parseInt(duration, 10) || 0;
                return acc + minutes;
            }, 0);

            if (totalMinutes === 0) return '00:00';

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };
        const processTypeData = (data) => {
            const stats = {};
            data.forEach(item => {
                const type = item['ประเภท'] || 'ไม่ระบุ';
                const cost = calculateTotalCost(item);
                const vehicleNumber = item['เบอร์รถ'] || 'ไม่ระบุ';

                if (!stats[type]) {
                    stats[type] = { count: 0, totalCost: 0, regNumbers: new Set(), vehicleDetails: {} };
                }

                stats[type].count++;
                stats[type].totalCost += cost;

                if (vehicleNumber !== 'ไม่ระบุ') {
                    stats[type].regNumbers.add(vehicleNumber);

                    if (!stats[type].vehicleDetails[vehicleNumber]) {
                        stats[type].vehicleDetails[vehicleNumber] = { count: 0, totalCost: 0 };
                    }
                    stats[type].vehicleDetails[vehicleNumber].count++;
                    stats[type].vehicleDetails[vehicleNumber].totalCost += cost;
                }
            });

            Object.keys(stats).forEach(type => {
                stats[type].avgCost = stats[type].count > 0 ? stats[type].totalCost / stats[type].count : 0;
            });
            return stats;
        };
        const processVehicleData = (data) => {
            const stats = {};
            data.forEach(item => {
                const vehicleNumber = item['เบอร์รถ'] || 'ไม่ระบุ';
                if (vehicleNumber === 'ไม่ระบุ') return;
                const cost = calculateTotalCost(item);
                if (!stats[vehicleNumber]) {
                    stats[vehicleNumber] = { count: 0, totalCost: 0, items: [], types: {} };
                }
                stats[vehicleNumber].count++;
                stats[vehicleNumber].totalCost += cost;
                stats[vehicleNumber].items.push(item);
                const type = item['ประเภท'] || 'ไม่ระบุ';
                stats[vehicleNumber].types[type] = (stats[vehicleNumber].types[type] || 0) + 1;
            });
            Object.keys(stats).forEach(vehicle => {
                stats[vehicle].avgCost = stats[vehicle].count > 0 ? stats[vehicle].totalCost / stats[vehicle].count : 0;
                let maxTypeCount = 0;
                let mostCommonType = 'ไม่ระบุ';
                Object.entries(stats[vehicle].types).forEach(([type, count]) => {
                    if (count > maxTypeCount) {
                        mostCommonType = type;
                        maxTypeCount = count;
                    }
                });
                stats[vehicle].mostCommonType = mostCommonType;
            });
            return stats;
        };
        
        // ##################################################################
        // ### SHARED COMPONENTS (คอมโพเนนต์ที่ใช้ร่วมกัน) ###
        // ##################################################################
        const Icons = ({ name, className = "w-6 h-6" }) => {
            const iconPaths = {
                toolbox: <path strokeLinecap="round" strokeLinejoin="round" d="M21.75 9.75v2.25-2.25H2.25v2.25-2.25H21.75zM2.25 9.75v9.75a2.25 2.25 0 0 0 2.25 2.25h15a2.25 2.25 0 0 0 2.25-2.25V9.75m-19.5 0v-2.25a2.25 2.25 0 0 1 2.25-2.25h15a2.25 2.25 0 0 1 2.25 2.25v2.25m-15-4.5-3 3m15 0-3-3" />,
                bolt: <path strokeLinecap="round" strokeLinejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />,
                chevronDown: <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />,
                up: <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 10.5L12 3l7.5 7.5" />,
                down: <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 13.5L12 21l-7.5-7.5" />,
                balance: <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />,
                impact: <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1-8.414 1.414M2.25 18 18 2.25M12 21V9M15.75 21v-5.25M8.25 21v-5.25" />,
                calculator: <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm3-6h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm3-6h.008v.008H14.25v-.008zm0 3h.008v.008H14.25v-.008zM4.5 3.75v16.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V3.75m-15 0h15M4.5 3.75a2.25 2.25 0 012.25-2.25h10.5a2.25 2.25 0 012.25 2.25" />,
                grid: <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>{iconPaths[name]}</svg>;
        };
        const Loader = ({text}) => (
            <div className="flex flex-col justify-center items-center h-80 text-center">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600"></div>
                <p className="mt-4 text-lg text-gray-600">{text}</p>
            </div>
        );
        const SummaryCard = ({ title, value, unit, icon, color, footerText }) => (
            <div className={`bg-white p-5 rounded-xl shadow-md flex flex-col justify-between ${color.border} border-l-4`}>
                <div className="flex items-start space-x-4">
                    <div className={`p-3 rounded-full ${color.bg}`}>
                        <div className={color.icon}>{icon}</div>
                    </div>
                    <div>
                        <p className="text-sm font-medium text-gray-500">{title}</p>
                        <p className="text-2xl font-bold text-gray-800">{value} <span className="text-base font-medium">{unit}</span></p>
                    </div>
                </div>
                {footerText && <p className="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">{footerText}</p>}
            </div>
        );
        const BarChart = ({ data, color, title }) => {
            const maxValue = Math.max(...data.map(d => d.value), 0);
            return (
                <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                    <h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">{title}</h3>
                    <div className="mt-4 space-y-3">
                        {data.map((item, index) => (
                            <div key={index} className="chart-container flex items-center text-sm">
                                <div className="w-1/3 sm:w-1/4 font-medium truncate pr-2 text-slate-700">{item.label}</div>
                                <div className="w-2/3 sm:w-3/4 flex items-center">
                                    <div className={`chart-bar rounded-sm ${color}`} style={{ width: maxValue > 0 ? `${(item.value / maxValue) * 100}%` : '0%', height: '24px' }}></div>
                                    <span className="ml-2 whitespace-nowrap font-medium text-slate-700">{item.displayValue}</span>
                                </div>
                            </div>
                        ))}
                    </div>


                </div>
            );
        };

        // ##################################################################
        // ### EXPENSE CHART COMPONENT (คอมโพเนนต์กราฟค่าใช้จ่าย) ###
        // ##################################################################
        const ExpenseChart = ({ data, title }) => {
            const maxValue = Math.max(...data.flatMap(item => [item.current, item.last, Math.abs(item.difference)]));
            const colors = {
                current: 'bg-blue-500',
                last: 'bg-gray-400', 
                difference: 'bg-green-500',
                differenceNegative: 'bg-red-500'
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-6 text-center">{title}</h3>
                    
                    {/* Legend */}
                    <div className="flex flex-wrap justify-center gap-4 mb-6">
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 ${colors.current} rounded`}></div>
                            <span className="text-sm text-gray-600">ปี {new Date().getFullYear()}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 ${colors.last} rounded`}></div>
                            <span className="text-sm text-gray-600">ปี {new Date().getFullYear() - 1}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 ${colors.difference} rounded`}></div>
                            <span className="text-sm text-gray-600">ผลต่าง (ลดลง)</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 ${colors.differenceNegative} rounded`}></div>
                            <span className="text-sm text-gray-600">ผลต่าง (เพิ่มขึ้น)</span>
                        </div>
                    </div>

                    {/* Vertical Bar Chart */}
                    <div className="flex justify-center items-end space-x-8 h-80 bg-gray-50 rounded-lg p-4">
                        {data.map((item, index) => (
                            <div key={index} className="flex flex-col items-center space-y-2">
                                {/* Category Label */}
                                <div className="text-xs text-gray-600 text-center font-medium mb-2 w-20">
                                    {item.category.replace(' (ยกเว้นยาง)', '').replace('ค่า', '')}
                                </div>
                                
                                {/* Bars Container */}
                                <div className="flex items-end space-x-1 h-64">
                                    {/* Current Year Bar */}
                                    <div className="flex flex-col items-center">
                                        <div 
                                            className={`${colors.current} w-8 rounded-t flex items-end justify-center pb-1`}
                                            style={{ height: maxValue > 0 ? `${(item.current / maxValue) * 240}px` : '2px' }}
                                        >
                                            <span className="text-xs text-white font-medium transform -rotate-90 whitespace-nowrap">
                                                {maxValue > 0 && (item.current / maxValue) * 240 > 30 ? 
                                                    formatPrice(item.current).replace('฿', '').replace(',', 'K').slice(0, -3) + 'K' : ''}
                                            </span>
                                        </div>
                                        <div className="text-xs text-blue-600 mt-1 font-medium">
                                            {formatPrice(item.current)}
                                        </div>
                                    </div>

                                    {/* Last Year Bar */}
                                    <div className="flex flex-col items-center">
                                        <div 
                                            className={`${colors.last} w-8 rounded-t flex items-end justify-center pb-1`}
                                            style={{ height: maxValue > 0 ? `${(item.last / maxValue) * 240}px` : '2px' }}
                                        >
                                            <span className="text-xs text-white font-medium transform -rotate-90 whitespace-nowrap">
                                                {maxValue > 0 && (item.last / maxValue) * 240 > 30 ? 
                                                    formatPrice(item.last).replace('฿', '').replace(',', 'K').slice(0, -3) + 'K' : ''}
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-600 mt-1 font-medium">
                                            {formatPrice(item.last)}
                                        </div>
                                    </div>

                                    {/* Difference Bar */}
                                    <div className="flex flex-col items-center">
                                        <div 
                                            className={`${item.difference >= 0 ? colors.differenceNegative : colors.difference} w-8 rounded-t flex items-end justify-center pb-1`}
                                            style={{ height: maxValue > 0 ? `${(Math.abs(item.difference) / maxValue) * 240}px` : '2px' }}
                                        >
                                            <span className="text-xs text-white font-medium transform -rotate-90 whitespace-nowrap">
                                                {maxValue > 0 && (Math.abs(item.difference) / maxValue) * 240 > 30 ? 
                                                    `${item.difference >= 0 ? '+' : ''}${formatPrice(item.difference).replace('฿', '').replace(',', 'K').slice(0, -3)}K` : ''}
                                            </span>
                                        </div>
                                        <div className={`text-xs mt-1 font-medium ${
                                            item.difference >= 0 ? 'text-red-600' : 'text-green-600'
                                        }`}>
                                            {item.difference >= 0 ? '+' : ''}{formatPrice(item.difference)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Legend */}
                    <div className="mt-6 pt-4 border-t border-gray-200">
                        <div className="flex flex-wrap justify-center gap-4 text-sm">
                            <div className="flex items-center gap-2">
                                <div className={`w-4 h-4 ${colors.current} rounded`}></div>
                                <span className="text-gray-600">ปี {new Date().getFullYear()}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className={`w-4 h-4 ${colors.last} rounded`}></div>
                                <span className="text-gray-600">ปี {new Date().getFullYear() - 1}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className={`w-4 h-4 ${colors.difference} rounded`}></div>
                                <span className="text-gray-600">ผลต่าง (ลดลง)</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className={`w-4 h-4 ${colors.differenceNegative} rounded`}></div>
                                <span className="text-gray-600">ผลต่าง (เพิ่มขึ้น)</span>
                            </div>
                        </div>
                    </div>


                </div>
            );
        };
        const PaginatedDataTable = ({ title, data, columns }) => {
            const ITEMS_PER_PAGE = 10;
            const [currentPage, setCurrentPage] = useState(1);
            useEffect(() => { setCurrentPage(1); }, [data]);
            const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const currentData = data.slice(startIndex, endIndex);
            const goToPage = (page) => { setCurrentPage(Math.max(1, Math.min(page, totalPages))); };
            return (
                <div className="bg-white p-4 sm:p-6 rounded-xl shadow-md mt-6">
                    <h2 className="text-lg font-semibold text-gray-700 mb-4">{title}</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>{columns.map(col => <th key={col.key} scope="col" className="px-6 py-3">{col.label}</th>)}</tr>
                            </thead>
                            <tbody>
                                {currentData.map((row, index) => (
                                    <tr key={startIndex + index} className="bg-white border-b hover:bg-gray-50">
                                        {columns.map(col => (
                                            <td key={col.key} className="px-6 py-4 whitespace-nowrap">
                                                {col.render ? col.render(row[col.key], row, startIndex + index) : row[col.key]}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center mt-4 text-sm">
                            <span className="text-gray-600">หน้า {currentPage} จาก {totalPages} (ทั้งหมด {data.length} รายการ)</span>
                            <div className="flex items-center space-x-1">
                                <button onClick={() => goToPage(1)} disabled={currentPage === 1} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">« แรก</button>
                                <button onClick={() => goToPage(currentPage - 1)} disabled={currentPage === 1} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">‹ ก่อนหน้า</button>
                                <button onClick={() => goToPage(currentPage + 1)} disabled={currentPage === totalPages} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">ถัดไป ›</button>
                                <button onClick={() => goToPage(totalPages)} disabled={currentPage === totalPages} className="pagination-btn pagination-btn-inactive px-3 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">สุดท้าย »</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ##################################################################
        // ### OVERVIEW APP (แอปภาพรวม) ###
        // ##################################################################
        const OverviewApp = ({ repairData, fuelData, evData }) => {
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;

            // คำนวณค่าซ่อมทั้งหมด (ยกเว้นยาง)
            const repairCosts = useMemo(() => {
                const currentYearRepairs = repairData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    const isNotTire = !item['ประเภท']?.toLowerCase().includes('ยาง') && 
                                     !item['รายการซ่อม']?.toLowerCase().includes('ยาง');
                    return date && date.getFullYear() === currentYear && isNotTire;
                });
                
                const lastYearRepairs = repairData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    const isNotTire = !item['ประเภท']?.toLowerCase().includes('ยาง') && 
                                     !item['รายการซ่อม']?.toLowerCase().includes('ยาง');
                    return date && date.getFullYear() === lastYear && isNotTire;
                });

                const currentTotal = currentYearRepairs.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const lastTotal = lastYearRepairs.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const difference = currentTotal - lastTotal;
                const percentChange = lastTotal > 0 ? ((difference / lastTotal) * 100) : 0;

                return { currentTotal, lastTotal, difference, percentChange };
            }, [repairData, currentYear, lastYear]);

            // คำนวณค่าน้ำมัน
            const fuelCosts = useMemo(() => {
                const fuelSupply = fuelData?.supply || [];
                const currentYearFuel = fuelSupply.filter(item => {
                    const date = parseDate(item['วันที่']);
                    return date && date.getFullYear() === currentYear && item['เลขที่ใบเบิก SAP'] !== 'ยอดยกมา';
                });
                
                const lastYearFuel = fuelSupply.filter(item => {
                    const date = parseDate(item['วันที่']);
                    return date && date.getFullYear() === lastYear && item['เลขที่ใบเบิก SAP'] !== 'ยอดยกมา';
                });

                const currentTotal = currentYearFuel.reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                const lastTotal = lastYearFuel.reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                const difference = currentTotal - lastTotal;
                const percentChange = lastTotal > 0 ? ((difference / lastTotal) * 100) : 0;

                return { currentTotal, lastTotal, difference, percentChange };
            }, [fuelData, currentYear, lastYear]);

            // คำนวณค่าซ่อมยาง
            const tireCosts = useMemo(() => {
                const currentYearTires = repairData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    const isTire = item['ประเภท']?.toLowerCase().includes('ยาง') || 
                                  item['รายการซ่อม']?.toLowerCase().includes('ยาง');
                    return date && date.getFullYear() === currentYear && isTire;
                });
                
                const lastYearTires = repairData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    const isTire = item['ประเภท']?.toLowerCase().includes('ยาง') || 
                                  item['รายการซ่อม']?.toLowerCase().includes('ยาง');
                    return date && date.getFullYear() === lastYear && isTire;
                });

                const currentTotal = currentYearTires.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const lastTotal = lastYearTires.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const difference = currentTotal - lastTotal;
                const percentChange = lastTotal > 0 ? ((difference / lastTotal) * 100) : 0;

                return { currentTotal, lastTotal, difference, percentChange };
            }, [repairData, currentYear, lastYear]);

            // คำนวณค่าไฟฟ้ารถ EV
            const evCosts = useMemo(() => {
                const currentYearEV = evData.filter(item => {
                    const date = parseDate(item.date);
                    return date && date.getFullYear() === currentYear;
                });
                
                const lastYearEV = evData.filter(item => {
                    const date = parseDate(item.date);
                    return date && date.getFullYear() === lastYear;
                });

                const currentTotal = currentYearEV.reduce((sum, item) => sum + (Number(item.electricityCost) || 0), 0);
                const lastTotal = lastYearEV.reduce((sum, item) => sum + (Number(item.electricityCost) || 0), 0);
                const difference = currentTotal - lastTotal;
                const percentChange = lastTotal > 0 ? ((difference / lastTotal) * 100) : 0;

                return { currentTotal, lastTotal, difference, percentChange };
            }, [evData, currentYear, lastYear]);

            return (
                <div className="space-y-6">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">ภาพรวมค่าใช้จ่าย</h2>
                        <p className="text-gray-600">เปรียบเทียบข้อมูลปี {lastYear} กับปี {currentYear}</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {/* ค่าซ่อม (ยกเว้นยาง) */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">ค่าซ่อม (ยกเว้นยาง)</h3>
                                <Icons name="toolbox" className="w-8 h-8 text-blue-600" />
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <p className="text-sm text-gray-600">ปี {currentYear}</p>
                                    <p className="text-2xl font-bold text-blue-600">{formatPrice(repairCosts.currentTotal)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-600">ปี {lastYear}</p>
                                    <p className="text-lg text-gray-700">{formatPrice(repairCosts.lastTotal)}</p>
                                </div>
                                <div className="border-t pt-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-gray-600">ผลต่าง</span>
                                        <span className={`font-semibold ${repairCosts.difference >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {repairCosts.difference >= 0 ? '+' : ''}{formatPrice(repairCosts.difference)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-sm text-gray-600">% เปลี่ยนแปลง</span>
                                        <span className={`font-semibold ${repairCosts.percentChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {repairCosts.percentChange >= 0 ? '+' : ''}{repairCosts.percentChange.toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ค่าน้ำมัน */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">ค่าน้ำมัน</h3>
                                <img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" alt="น้ำมัน" className="w-8 h-8" />
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <p className="text-sm text-gray-600">ปี {currentYear}</p>
                                    <p className="text-2xl font-bold text-orange-600">{formatPrice(fuelCosts.currentTotal)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-600">ปี {lastYear}</p>
                                    <p className="text-lg text-gray-700">{formatPrice(fuelCosts.lastTotal)}</p>
                                </div>
                                <div className="border-t pt-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-gray-600">ผลต่าง</span>
                                        <span className={`font-semibold ${fuelCosts.difference >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {fuelCosts.difference >= 0 ? '+' : ''}{formatPrice(fuelCosts.difference)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-sm text-gray-600">% เปลี่ยนแปลง</span>
                                        <span className={`font-semibold ${fuelCosts.percentChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {fuelCosts.percentChange >= 0 ? '+' : ''}{fuelCosts.percentChange.toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ค่าซ่อมยาง */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">ค่าซ่อมยาง</h3>
                                <Icons name="circle" className="w-8 h-8 text-gray-600" />
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <p className="text-sm text-gray-600">ปี {currentYear}</p>
                                    <p className="text-2xl font-bold text-gray-600">{formatPrice(tireCosts.currentTotal)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-600">ปี {lastYear}</p>
                                    <p className="text-lg text-gray-700">{formatPrice(tireCosts.lastTotal)}</p>
                                </div>
                                <div className="border-t pt-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-gray-600">ผลต่าง</span>
                                        <span className={`font-semibold ${tireCosts.difference >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {tireCosts.difference >= 0 ? '+' : ''}{formatPrice(tireCosts.difference)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-sm text-gray-600">% เปลี่ยนแปลง</span>
                                        <span className={`font-semibold ${tireCosts.percentChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {tireCosts.percentChange >= 0 ? '+' : ''}{tireCosts.percentChange.toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ค่าไฟฟ้ารถ EV */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">ค่าไฟฟ้ารถ EV</h3>
                                <Icons name="bolt" className="w-8 h-8 text-green-600" />
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <p className="text-sm text-gray-600">ปี {currentYear}</p>
                                    <p className="text-2xl font-bold text-green-600">{formatPrice(evCosts.currentTotal)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-600">ปี {lastYear}</p>
                                    <p className="text-lg text-gray-700">{formatPrice(evCosts.lastTotal)}</p>
                                </div>
                                <div className="border-t pt-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-gray-600">ผลต่าง</span>
                                        <span className={`font-semibold ${evCosts.difference >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {evCosts.difference >= 0 ? '+' : ''}{formatPrice(evCosts.difference)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-sm text-gray-600">% เปลี่ยนแปลง</span>
                                        <span className={`font-semibold ${evCosts.percentChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                            {evCosts.percentChange >= 0 ? '+' : ''}{evCosts.percentChange.toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* สรุปรวม */}
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mt-8">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">สรุปค่าใช้จ่ายรวม</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="text-center">
                                <p className="text-sm text-gray-600 mb-2">ปี {currentYear}</p>
                                <p className="text-3xl font-bold text-blue-600">
                                    {formatPrice(repairCosts.currentTotal + fuelCosts.currentTotal + tireCosts.currentTotal + evCosts.currentTotal)}
                                </p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm text-gray-600 mb-2">ปี {lastYear}</p>
                                <p className="text-2xl font-semibold text-gray-700">
                                    {formatPrice(repairCosts.lastTotal + fuelCosts.lastTotal + tireCosts.lastTotal + evCosts.lastTotal)}
                                </p>
                            </div>
                        </div>
                        <div className="text-center mt-4 pt-4 border-t border-gray-200">
                            <div className="flex justify-center items-center space-x-6">
                                <div>
                                    <span className="text-sm text-gray-600">ผลต่างรวม: </span>
                                    <span className={`font-bold text-lg ${
                                        (repairCosts.difference + fuelCosts.difference + tireCosts.difference + evCosts.difference) >= 0 
                                        ? 'text-red-600' : 'text-green-600'
                                    }`}>
                                        {(repairCosts.difference + fuelCosts.difference + tireCosts.difference + evCosts.difference) >= 0 ? '+' : ''}
                                        {formatPrice(repairCosts.difference + fuelCosts.difference + tireCosts.difference + evCosts.difference)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* กราฟเปรียบเทียบค่าใช้จ่าย */}
                    <ExpenseChart 
                        title="กราฟเปรียบเทียบค่าใช้จ่ายแต่ละหมวด"
                        data={[
                            {
                                category: "ค่าซ่อม (ยกเว้นยาง)",
                                current: repairCosts.currentTotal,
                                last: repairCosts.lastTotal,
                                difference: repairCosts.difference
                            },
                            {
                                category: "ค่าน้ำมัน",
                                current: fuelCosts.currentTotal,
                                last: fuelCosts.lastTotal,
                                difference: fuelCosts.difference
                            },
                            {
                                category: "ค่าซ่อมยาง",
                                current: tireCosts.currentTotal,
                                last: tireCosts.lastTotal,
                                difference: tireCosts.difference
                            },
                            {
                                category: "ค่าไฟฟ้ารถ EV",
                                current: evCosts.currentTotal,
                                last: evCosts.lastTotal,
                                difference: evCosts.difference
                            }
                        ]}
                    />
                </div>
            );
        };

        // ##################################################################
        // ### REPAIR APP SUB-COMPONENTS (คอมโพเนนต์ย่อยของแอปแจ้งซ่อม) ###
        // ##################################################################
        const RepairTableRow = ({ item, index }) => {
            const totalCost = calculateTotalCost(item);
            return (
                <tr className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 text-sm">
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-600">{index}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-800 font-medium">{item['เบอร์รถ']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['รายการซ่อม']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['ประเภท']}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['วันที่แจ้งซ่อม(APP)'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['ซ่อมเสร็จ(APP)'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right text-slate-700">{formatPrice(calculateTotalSparePartsPrice(item['ราคาอะไหล่']))}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right text-slate-700">{formatPrice(item['ราคา'])}</td>
                    <td className="border-b border-gray-200 px-4 py-3 text-right font-bold text-emerald-600">{formatPrice(totalCost)}</td>
                </tr>
            );
        };
        const RepairCard = ({ item, index }) => {
            const totalCost = calculateTotalCost(item);
            const sparePartsPrice = calculateTotalSparePartsPrice(item['ราคาอะไหล่']);
            const servicePrice = parseFloat(String(item['ราคา'])) || 0;
            return (
                <div className="mobile-card border border-gray-200 rounded-lg mb-4 p-4 bg-white shadow">
                    <div className="flex justify-between items-center mb-2">
                        <div className="font-semibold text-slate-800">#{index} - {item['เบอร์รถ']}</div>
                        <div className="text-right"><div className="font-bold text-emerald-600">{formatPrice(totalCost)}</div><div className="text-xs text-gray-500">ต้นทุนรวม</div></div>
                    </div>
                    <div className="mb-2 text-sm"><div className="font-medium text-slate-700">{item['รายการซ่อม']}</div><div className="text-blue-600 font-medium">{item['ประเภท']}</div></div>
                    <div className="grid grid-cols-2 gap-1 text-xs text-gray-600 mb-2"><div>แจ้งซ่อม: {formatDate(item['วันที่แจ้งซ่อม(APP)'])}</div><div>ซ่อมเสร็จ: {formatDate(item['ซ่อมเสร็จ(APP)'])}</div></div>
                    <div className="bg-gray-50 p-2 rounded text-xs"><div className="flex justify-between"><span>ราคาอะไหล่:</span> <span>{formatPrice(sparePartsPrice)}</span></div><div className="flex justify-between"><span>ราคาซ่อม:</span> <span>{formatPrice(servicePrice)}</span></div></div>
                </div>
            );
        };
        const MonthGroupSection = ({ group, isMobile, onToggle, isExpanded }) => {
            const monthName = getThaiMonthName(group.month) + ' ' + group.year;
            return (
                <div className="mb-4 bg-white rounded-lg shadow-md overflow-hidden">
                    <div onClick={onToggle} className="month-header bg-blue-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-blue-100 transition-colors duration-200">
                        <div className="flex items-center">
                            <span className={`transform transition-transform duration-200 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 mr-2 text-blue-600" /></span>
                            <h3 className="font-semibold text-blue-800">{monthName}</h3>
                        </div>
                        <div className="text-sm text-slate-700"><span className="font-semibold text-slate-800">{group.items.length}</span> รายการ | <span className="font-semibold text-slate-800">{formatPrice(group.totalPrice)}</span> บาท</div>
                    </div>
                    <div className={`month-content transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                        <div className="p-0 sm:p-0">
                            {isMobile ? (<div className="p-2">{group.items.map((item, idx) => <RepairCard key={item['ลำดับที่']} item={item} index={idx + 1}/>)}</div>) 
                            : (<div className="overflow-x-auto"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ลำดับที่</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">เบอร์รถ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">รายการซ่อม</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ประเภท</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">วันที่แจ้งซ่อม</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ซ่อมเสร็จ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">ราคาอะไหล่</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">ราคาซ่อม</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">ต้นทุนรวม</th></tr></thead><tbody>{group.items.map((item, idx) => <RepairTableRow key={item['ลำดับที่']} item={item} index={idx + 1}/>)}</tbody></table></div>)}
                        </div>
                    </div>
                </div>
            );
        };
        const AllDataTab = ({ data, isMobile }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('');
            const [filterYear, setFilterYear] = useState('');
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const { uniqueTypes, uniqueYears } = useMemo(() => {
                const types = new Set(); const years = new Set();
                data.forEach(item => { if (item.ประเภท) types.add(item.ประเภท); const date = new Date(item['วันที่แจ้งซ่อม(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); });
                return { uniqueTypes: Array.from(types).sort(), uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);
            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const date = new Date(item['วันที่แจ้งซ่อม(APP)']);
                    const itemYear = !isNaN(date.getTime()) ? date.getFullYear().toString() : '';
                    const matchesSearch = searchTerm === '' || Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesType = filterType === '' || item.ประเภท === filterType;
                    const matchesYear = filterYear === '' || itemYear === filterYear;
                    return matchesSearch && matchesType && matchesYear;
                });
            }, [data, searchTerm, filterType, filterYear]);
            const groupDataByMonth = (data) => {
                const grouped = {};
                const sortedData = [...data].sort((a, b) => (parseDate(b['วันที่แจ้งซ่อม(APP)']) || 0) - (parseDate(a['วันที่แจ้งซ่อม(APP)']) || 0));
                sortedData.forEach(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']); if (!date) return;
                    const year = date.getFullYear(); const month = date.getMonth(); const key = `${year}-${month}`;
                    if (!grouped[key]) { grouped[key] = { items: [], totalPrice: 0, year, month }; }
                    grouped[key].items.push(item); grouped[key].totalPrice += calculateTotalCost(item);
                });
                return grouped;
            };
            const groupedData = useMemo(() => Object.entries(groupDataByMonth(filteredData)).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1])), [filteredData]);
            const toggleMonth = (monthKey) => setExpandedMonths(prev => { const newSet = new Set(prev); if (newSet.has(monthKey)) newSet.delete(monthKey); else newSet.add(monthKey); return newSet; });
            const totalCost = useMemo(() => filteredData.reduce((sum, item) => sum + calculateTotalCost(item), 0), [filteredData]);

            // Calculate yearly totals for summary cards
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            const currentYearTotal = useMemo(() => {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    return 0;
                }
                
                const currentYearData = data.filter(item => {
                    const dateStr = item['วันที่แจ้งซ่อม(APP)'];
                    if (!dateStr) return false;
                    
                    const parsedDate = parseDate(dateStr);
                    if (!parsedDate) return false;
                    
                    const itemYear = parsedDate.getFullYear();
                    return itemYear === currentYear;
                });
                
                return currentYearData.reduce((sum, item) => {
                    return sum + calculateTotalCost(item);
                }, 0);
            }, [data, currentYear]);
            
            const lastYearTotal = useMemo(() => {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    return 0;
                }
                
                const lastYearData = data.filter(item => {
                    const dateStr = item['วันที่แจ้งซ่อม(APP)'];
                    if (!dateStr) return false;
                    
                    const parsedDate = parseDate(dateStr);
                    if (!parsedDate) return false;
                    
                    const itemYear = parsedDate.getFullYear();
                    return itemYear === lastYear;
                });
                
                return lastYearData.reduce((sum, item) => {
                    return sum + calculateTotalCost(item);
                }, 0);
            }, [data, lastYear]);
            
            const yearlyDifference = currentYearTotal - lastYearTotal;
            const yearlyPercentChange = lastYearTotal > 0 ? ((yearlyDifference / lastYearTotal) * 100) : 0;

            const searchColumns = [
                { key: 'ลำดับที่', label: 'ลำดับที่', render: (val, row, index) => index + 1 },
                { key: 'เบอร์รถ', label: 'เบอร์รถ' },
                { key: 'รายการซ่อม', label: 'รายการซ่อม' },
                { key: 'ประเภท', label: 'ประเภท' },
                { key: 'วันที่แจ้งซ่อม(APP)', label: 'วันที่แจ้งซ่อม', render: (val) => formatDate(val) },
                { key: 'ซ่อมเสร็จ(APP)', label: 'ซ่อมเสร็จ', render: (val) => formatDate(val) },
                { key: 'ราคา', label: 'ค่าซ่อม', render: (val) => formatPrice(val) },
                { key: 'ราคาอะไหล่', label: 'ค่าอะไหล่', render: (val) => formatPrice(calculateTotalSparePartsPrice(val)) },
                { key: 'total', label: 'รวม', render: (val, row) => formatPrice(calculateTotalCost(row)) },
            ];

            return (
                <div>
                    {/* Yearly Summary Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <SummaryCard
                            title={`ยอดซ่อมปี ${currentYear}`}
                            value={formatPrice(currentYearTotal)}
                            unit="บาท"
                            icon="📊"
                            color="blue"
                        />
                        <SummaryCard
                            title={`ยอดซ่อมปี ${lastYear}`}
                            value={formatPrice(lastYearTotal)}
                            unit="บาท"
                            icon="📈"
                            color="gray"
                        />
                        <SummaryCard
                            title="ผลต่าง"
                            value={formatPrice(Math.abs(yearlyDifference))}
                            unit="บาท"
                            icon={yearlyDifference >= 0 ? "📈" : "📉"}
                            color={yearlyDifference >= 0 ? "red" : "green"}
                            subtitle={yearlyDifference >= 0 ? "เพิ่มขึ้น" : "ลดลง"}
                        />
                        <SummaryCard
                            title="% การเปลี่ยนแปลง"
                            value={Math.abs(yearlyPercentChange).toFixed(1)}
                            unit="%"
                            icon={yearlyPercentChange >= 0 ? "📈" : "📉"}
                            color={yearlyPercentChange >= 0 ? "red" : "green"}
                            subtitle={yearlyPercentChange >= 0 ? "เพิ่มขึ้น" : "ลดลง"}
                        />
                    </div>
                    
                    <div className="mb-4 sm:mb-6">
                        <div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
                            <input type="text" placeholder="ค้นหา..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto" />
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"><option value="">ทุกประเภท</option>{uniqueTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                            <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"><option value="">ทุกปี</option>{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                        </div>
                    </div>
                    
                    {searchTerm ? (
                        <PaginatedDataTable
                            title={`ผลการค้นหาสำหรับ "${searchTerm}"`}
                            data={filteredData}
                            columns={searchColumns}
                        />
                    ) : (
                        <div id="monthlyDataContainer">
                            {groupedData.length > 0 ? groupedData.map(([key, group]) => (<MonthGroupSection key={key} group={group} isMobile={isMobile} isExpanded={expandedMonths.has(key)} onToggle={() => toggleMonth(key)} />)) : <div className="text-center py-8 text-gray-500">ไม่พบข้อมูล</div>}
                        </div>
                    )}

                    <div className="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 text-sm sm:text-base">
                        <div><span className="font-semibold">{filteredData.length}</span> รายการ</div>
                        <div>ราคารวม: <span className="font-semibold">{formatPrice(totalCost)}</span> บาท</div>
                    </div>
                </div>
            );
        };
        const WeeklyTab = ({ data, isMobile }) => {
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [selectedWeek, setSelectedWeek] = useState(null);
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['วันที่แจ้งซ่อม(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            const groupDataByWeek = (data, year, month) => {
                const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const weeks = [];
                let currentWeekStart = new Date(firstDay); currentWeekStart.setDate(currentWeekStart.getDate() - firstDay.getDay());
                while (currentWeekStart <= lastDay) { const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); weeks.push({ start: new Date(currentWeekStart), end: new Date(weekEnd), items: [] }); currentWeekStart.setDate(currentWeekStart.getDate() + 7); }
                data.forEach(item => { const date = parseDate(item['วันที่แจ้งซ่อม(APP)']); if (!date) return; for (const week of weeks) { const weekEndMidnight = new Date(week.end); weekEndMidnight.setHours(23, 59, 59, 999); if (date >= week.start && date <= weekEndMidnight) { week.items.push(item); break; } } });
                return weeks.filter(w => w.items.length > 0);
            };
            const { weeklyReport, monthData } = useMemo(() => {
                const filtered = data.filter(item => { const date = parseDate(item['วันที่แจ้งซ่อม(APP)']); return date && date.getFullYear() === year && date.getMonth() === month; });
                return { weeklyReport: groupDataByWeek(filtered, year, month), monthData: filtered };
            }, [data, year, month]);
            const monthlyTotalCount = monthData.length;
            const monthlyTotalPrice = monthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
            const weeklyAvgCount = weeklyReport.length > 0 ? (monthlyTotalCount / weeklyReport.length) : 0;
            const weeklyAvgPrice = weeklyReport.length > 0 ? (monthlyTotalPrice / weeklyReport.length) : 0;
            if (selectedWeek) {
                const typeDataForWeek = processTypeData(selectedWeek.items);
                const sortedTypesByCount = Object.entries(typeDataForWeek).sort(([, a], [, b]) => b.count - a.count);
                const sortedTypesByPrice = Object.entries(typeDataForWeek).sort(([, a], [, b]) => b.totalCost - a.totalCost);
                const countChartData = sortedTypesByCount.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.count, displayValue: `${stats.count} ครั้ง` }));
                const priceChartData = sortedTypesByPrice.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
                return (<div><h3 className="font-semibold text-lg mb-2 text-slate-800">สรุปข้อมูลสัปดาห์ที่ {weeklyReport.findIndex(w => w.start.getTime() === selectedWeek.start.getTime()) + 1}<span className="text-sm font-normal text-gray-600 ml-2">({formatDate(selectedWeek.start.toISOString())} - {formatDate(selectedWeek.end.toISOString())})</span></h3><div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6"><BarChart data={countChartData} color="bg-blue-500" title="จำนวนรายการตามประเภท (Top 10)" /><BarChart data={priceChartData} color="bg-green-500" title="ราคารวมตามประเภท (Top 10)" /></div><h3 className="font-semibold text-lg mb-3 text-slate-800">รายละเอียดการซ่อม</h3>{isMobile ? (<div>{selectedWeek.items.map((item, idx) => <RepairCard key={item['ลำดับที่']} item={item} index={idx+1} />)}</div>) : (<div className="overflow-x-auto bg-white rounded-lg shadow-md p-4"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ลำดับที่</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">เบอร์รถ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">รายการซ่อม</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ประเภท</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">วันที่แจ้งซ่อม</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">ต้นทุนรวม</th></tr></thead><tbody>{selectedWeek.items.map((item, idx) => (<tr key={item['ลำดับที่']} className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 text-sm"><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{idx + 1}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-800 font-medium">{item['เบอร์รถ']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['รายการซ่อม']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{item['ประเภท']}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-700">{formatDate(item['วันที่แจ้งซ่อม(APP)'])}</td><td className="border-b border-gray-200 px-4 py-3 text-right font-bold text-emerald-600">{formatPrice(calculateTotalCost(item))}</td></tr>))}</tbody></table></div>)}<button onClick={() => setSelectedWeek(null)} className="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition">กลับไปหน้ารายสัปดาห์</button></div>)
            }
            return (<div><div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2"><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select><select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6"><SummaryCard title="จำนวนรายการทั้งหมด" value={monthlyTotalCount} color={{bg: 'bg-blue-100', text: 'text-blue-800'}} /><SummaryCard title="ราคารวมทั้งหมด" value={formatPrice(monthlyTotalPrice)} unit="บาท" color={{bg: 'bg-green-100', text: 'text-green-800'}} /><SummaryCard title="จำนวนเฉลี่ยต่อสัปดาห์" value={weeklyAvgCount.toFixed(1)} color={{bg: 'bg-purple-100', text: 'text-purple-800'}} /><SummaryCard title="ราคาเฉลี่ยต่อสัปดาห์" value={formatPrice(weeklyAvgPrice)} unit="บาท" color={{bg: 'bg-amber-100', text: 'text-amber-800'}} /></div>{weeklyReport.length === 0 ? <div className="text-center py-8 text-gray-500">ไม่พบข้อมูลในเดือนที่เลือก</div> : (<div className="bg-white rounded-lg shadow-md p-3 sm:p-4"><h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">รายงานรายสัปดาห์</h3>{isMobile ? (<div className="space-y-3">{weeklyReport.map((week, index) => { const totalCost = week.items.reduce((sum, item) => sum + calculateTotalCost(item), 0); return (<div key={index} onClick={() => setSelectedWeek(week)} className="mobile-card border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-100/80 shadow-sm"><div className="flex justify-between items-center mb-1"><div className="font-semibold text-slate-800">สัปดาห์ที่ {index + 1}</div><div className="text-right font-bold text-blue-800">{formatPrice(totalCost)}</div></div><div className="text-xs text-slate-500 mb-2">{formatDate(week.start.toISOString())} - {formatDate(week.end.toISOString())}</div><div className="text-sm text-slate-700">จำนวน: <span className="font-semibold text-slate-900">{week.items.length} รายการ</span></div></div>)})}</div>) : (<div className="overflow-x-auto"><table className="w-full border-collapse"><thead><tr className="bg-slate-100"><th className="border-b-2 border-gray-200 px-4 py-3 text-center text-sm font-semibold text-slate-800 uppercase tracking-wider">สัปดาห์</th><th className="border-b-2 border-gray-200 px-4 py-3 text-left text-sm font-semibold text-slate-800 uppercase tracking-wider">ช่วงวันที่</th><th className="border-b-2 border-gray-200 px-4 py-3 text-center text-sm font-semibold text-slate-800 uppercase tracking-wider">จำนวนรายการ</th><th className="border-b-2 border-gray-200 px-4 py-3 text-right text-sm font-semibold text-slate-800 uppercase tracking-wider">ราคารวม</th></tr></thead><tbody>{weeklyReport.map((week, index) => { const totalCost = week.items.reduce((sum, item) => sum + calculateTotalCost(item), 0); return (<tr key={index} onClick={() => setSelectedWeek(week)} className="odd:bg-white even:bg-slate-50 hover:bg-blue-100/50 cursor-pointer text-sm"><td className="border-b border-gray-200 px-4 py-3 text-center font-medium text-slate-700">{index + 1}</td><td className="border-b border-gray-200 px-4 py-3 text-slate-800">{formatDate(week.start.toISOString())} - {formatDate(week.end.toISOString())}</td><td className="border-b border-gray-200 px-4 py-3 text-center text-slate-800 font-bold">{week.items.length}</td><td className="border-b border-gray-200 px-4 py-3 text-right font-semibold text-blue-800">{formatPrice(totalCost)}</td></tr>)})}</tbody></table></div>)}</div>)}</div>);
        };
        const TypeTab = ({ data, isMobile }) => {
            const [period, setPeriod] = useState('all');
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [expandedTypes, setExpandedTypes] = useState(new Set());
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['วันที่แจ้งซ่อม(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            
            const typeData = useMemo(() => {
                let filteredData = data;
                if (period === 'year') { filteredData = data.filter(item => { const d = parseDate(item['วันที่แจ้งซ่อม(APP)']); return d && d.getFullYear() === year; }); } 
                else if (period === 'month') { filteredData = data.filter(item => { const d = parseDate(item['วันที่แจ้งซ่อม(APP)']); return d && d.getFullYear() === year && d.getMonth() === month; }); }
                return processTypeData(filteredData);
            }, [data, period, year, month]);

            const sortedTypes = useMemo(() => Object.entries(typeData).sort(([, a], [, b]) => b.count - a.count), [typeData]);
            const totalItems = useMemo(() => sortedTypes.reduce((sum, [, stats]) => sum + stats.count, 0), [sortedTypes]);
            const totalPrice = useMemo(() => sortedTypes.reduce((sum, [, stats]) => sum + stats.totalCost, 0), [sortedTypes]);
            const countChartData = sortedTypes.slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.count, displayValue: `${stats.count}` }));
            const priceChartData = [...sortedTypes].sort(([,a], [,b]) => b.totalCost - a.totalCost).slice(0, 10).map(([type, stats]) => ({ label: type, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
            const toggleType = (type) => setExpandedTypes(prev => { const newSet = new Set(prev); if (newSet.has(type)) newSet.delete(type); else newSet.add(type); return newSet; });

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={period} onChange={e => setPeriod(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md"><option value="all">ทั้งหมด</option><option value="year">รายปี</option><option value="month">รายเดือน</option></select>
                        {period === 'year' && (<select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>)}
                        {period === 'month' && (<><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select><select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select></>)}
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                        <SummaryCard title="จำนวนประเภทการซ่อม" value={sortedTypes.length} color={{bg: 'bg-blue-100', text: 'text-blue-800'}} />
                        <SummaryCard title="จำนวนรายการทั้งหมด" value={totalItems} color={{bg: 'bg-green-100', text: 'text-green-800'}} />
                        <SummaryCard title="ราคารวมทั้งหมด" value={formatPrice(totalPrice)} unit="บาท" color={{bg: 'bg-purple-100', text: 'text-purple-800'}} />
                        <SummaryCard title="ราคาเฉลี่ยต่อรายการ" value={formatPrice(totalItems > 0 ? totalPrice / totalItems : 0)} unit="บาท" color={{bg: 'bg-amber-100', text: 'text-amber-800'}} />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                        <BarChart data={countChartData} color="bg-blue-500" title="จำนวนรายการตามประเภท (Top 10)" />
                        <BarChart data={priceChartData} color="bg-green-500" title="ราคารวมตามประเภท (Top 10)" />
                    </div>
                    <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                        <h3 className="font-semibold text-base sm:text-lg mb-3 sm:mb-4 text-slate-800">รายละเอียดตามประเภทการซ่อม</h3>
                        <div className="space-y-2">
                             {sortedTypes.map(([type, stats]) => {
                                const isExpanded = expandedTypes.has(type);
                                const sortedVehicles = Object.entries(stats.vehicleDetails).sort(([,a],[,b]) => b.totalCost - a.totalCost);
                                return (
                                    <div key={type} className="border rounded-lg overflow-hidden bg-white">
                                        <div onClick={() => toggleType(type)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                            <div className="flex items-center">
                                                <span className={`transform transition-transform duration-200 mr-2 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-slate-500" /></span>
                                                <h4 className="font-semibold text-blue-800">{type}</h4>
                                            </div>
                                            <div className="text-sm text-right">
                                                <div><span className="font-semibold">{stats.count}</span> ครั้ง / <span className="font-semibold">{stats.regNumbers.size}</span> คัน</div>
                                                <div className="font-bold text-emerald-600">{formatPrice(stats.totalCost)} บาท</div>
                                            </div>
                                        </div>
                                        <div className={`transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                            <div className="p-4 bg-slate-50/70 border-t">
                                                <h5 className="font-medium mb-2 text-slate-700">รายละเอียดรถในประเภทนี้:</h5>
                                                <div className="overflow-x-auto border rounded-md">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-200">
                                                            <tr>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">จำนวนครั้ง</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าใช้จ่าย (บาท)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {sortedVehicles.map(([vehicle, details]) => (
                                                                <tr key={vehicle} className="border-t bg-white">
                                                                    <td className="px-3 py-2 font-medium text-slate-700">{vehicle}</td>
                                                                    <td className="px-3 py-2 text-right text-slate-600">{details.count}</td>
                                                                    <td className="px-3 py-2 text-right text-slate-600">{formatPrice(details.totalCost)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        const VehicleTab = ({ data, isMobile }) => {
            const [period, setPeriod] = useState('all');
            const [sortBy, setSortBy] = useState('plate_asc');
            const today = new Date();
            const [year, setYear] = useState(today.getFullYear());
            const [month, setMonth] = useState(today.getMonth());
            const [expandedVehicles, setExpandedVehicles] = useState(new Set());
            const { uniqueYears } = useMemo(() => { const years = new Set(); data.forEach(item => { const date = new Date(item['วันที่แจ้งซ่อม(APP)']); if (!isNaN(date.getTime())) years.add(date.getFullYear()); }); return { uniqueYears: Array.from(years).sort((a, b) => b - a) }; }, [data]);
            
            const vehicleData = useMemo(() => {
                let filteredData = data;
                if (period === 'year') { filteredData = data.filter(item => { const d = parseDate(item['วันที่แจ้งซ่อม(APP)']); return d && d.getFullYear() === year; }); } 
                else if (period === 'month') { filteredData = data.filter(item => { const d = parseDate(item['วันที่แจ้งซ่อม(APP)']); return d && d.getFullYear() === year && d.getMonth() === month; }); }
                return processVehicleData(filteredData);
            }, [data, period, year, month]);

            const sortedVehicles = useMemo(() => Object.entries(vehicleData).sort(([keyA, statsA], [keyB, statsB]) => {
                const customPlateSort = (a, b) => {
                    const partsA = a.split(/[- ]/);
                    const partsB = b.split(/[- ]/);
                    const prefixA = partsA[0];
                    const prefixB = partsB[0];
                    const numA = parseInt(partsA[1], 10) || 0;
                    const numB = parseInt(partsB[1], 10) || 0;

                    const getPrefixPriority = (prefix) => {
                        if (prefix === 'FL') return 1;
                        if (prefix === 'TT') return 2;
                        if (prefix === 'TTL') return 3;
                        return 4;
                    };

                    const priorityA = getPrefixPriority(prefixA);
                    const priorityB = getPrefixPriority(prefixB);

                    if (priorityA !== priorityB) {
                        return priorityA - priorityB;
                    }
                    
                    if (prefixA !== prefixB) {
                        return prefixA.localeCompare(prefixB);
                    }

                    return numA - numB;
                };

                switch (sortBy) {
                    case 'count_desc':
                        return statsB.count - statsA.count;
                    case 'count_asc':
                        return statsA.count - statsB.count;
                    case 'price_desc':
                        return statsB.totalCost - statsA.totalCost;
                    case 'price_asc':
                        return statsA.totalCost - statsB.totalCost;
                    case 'plate_asc':
                    default:
                        return customPlateSort(keyA, keyB);
                }
            }), [vehicleData, sortBy]);

            const countChartData = [...sortedVehicles].sort(([,a],[,b])=>b.count - a.count).slice(0, 10).map(([vehicle, stats]) => ({ label: vehicle, value: stats.count, displayValue: `${stats.count} ครั้ง` }));
            const priceChartData = [...sortedVehicles].sort(([,a],[,b])=>b.totalCost - a.totalCost).slice(0, 10).map(([vehicle, stats]) => ({ label: vehicle, value: stats.totalCost, displayValue: formatPrice(stats.totalCost) }));
            const toggleVehicle = (vehicle) => setExpandedVehicles(prev => { const newSet = new Set(prev); if (newSet.has(vehicle)) newSet.delete(vehicle); else newSet.add(vehicle); return newSet; });

            const SparePartsList = ({ item }) => {
                const parts = item['รายการอะไหล่ที่ต้องเปลี่ยน']?.split(/[+,]/).map(p => p.trim()).filter(Boolean) || [];
                const prices = String(item['ราคาอะไหล่'] || '').split(/[,;|+]/).map(p => p.trim()).filter(Boolean);

                if (parts.length === 0 && prices.length === 0) {
                    return <span className="text-slate-500">-</span>;
                }

                return (
                    <div className="space-y-1 text-xs">
                        {parts.map((part, index) => (
                            <div key={index} className="flex justify-between items-center">
                                <span className="text-slate-700">{part}</span>
                                <span className="font-medium text-slate-800">{formatPrice(prices[index] || 0)}</span>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={period} onChange={e => setPeriod(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md"><option value="all">ทั้งหมด</option><option value="year">รายปี</option><option value="month">รายเดือน</option></select>
                        {period !== 'all' && (<><select value={year} onChange={e => setYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>{period === 'month' && (<select value={month} onChange={e => setMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">{Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}</select>)}</>)}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                        <BarChart data={countChartData} color="bg-blue-500" title="จำนวนครั้งการซ่อม (Top 10)" />
                        <BarChart data={priceChartData} color="bg-green-500" title="ค่าใช้จ่ายรวม (Top 10)" />
                    </div>
                    <div className="bg-white rounded-lg shadow-md p-3 sm:p-4">
                        <div className="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 className="font-semibold text-base sm:text-lg text-slate-800">รายละเอียดสถิติรถ</h3>
                            <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="plate_asc">เรียงตามทะเบียน (น้อยไปมาก)</option>
                                <option value="count_desc">เรียงตามจำนวนครั้ง (มากไปน้อย)</option>
                                <option value="count_asc">เรียงตามจำนวนครั้ง (น้อยไปมาก)</option>
                                <option value="price_desc">เรียงตามราคารวม (มากไปน้อย)</option>
                                <option value="price_asc">เรียงตามราคารวม (น้อยไปมาก)</option>
                            </select>
                        </div>
                        <div className="space-y-2">
                            {sortedVehicles.map(([vehicle, stats]) => {
                                const isExpanded = expandedVehicles.has(vehicle);
                                return (
                                    <div key={vehicle} className="border rounded-lg overflow-hidden bg-white">
                                        <div onClick={() => toggleVehicle(vehicle)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                            <div>
                                                <h4 className="font-semibold text-blue-800">{vehicle}</h4>
                                                <div className="text-xs text-slate-500">ประเภทที่ซ่อมบ่อย: {stats.mostCommonType}</div>
                                            </div>
                                            <div className="text-sm text-right">
                                                <div><span className="font-semibold">{stats.count}</span> ครั้ง</div>
                                                <div className="font-bold text-emerald-600">{formatPrice(stats.totalCost)} บาท</div>
                                            </div>
                                        </div>
                                        <div className={`transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                            <div className="p-4 bg-slate-50/70 border-t">
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-200">
                                                            <tr>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">รายการซ่อม</th>
                                                                <th className="px-3 py-2 text-left font-medium text-slate-600">รายการอะไหล่</th>
                                                                <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าใช้จ่ายรวม</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {stats.items.map((item, index) => (
                                                                <tr key={index} className="border-t bg-white">
                                                                    <td className="px-3 py-2 align-top text-slate-600 whitespace-nowrap">{formatDate(item['วันที่แจ้งซ่อม(APP)'])}</td>
                                                                    <td className="px-3 py-2 align-top">
                                                                        <div className="font-medium text-slate-800">{item['รายการซ่อม']}</div>
                                                                        <div className="text-xs text-blue-600">{item['ประเภท']}</div>
                                                                    </td>
                                                                    <td className="px-3 py-2 align-top w-1/3">
                                                                        <SparePartsList item={item} />
                                                                    </td>
                                                                    <td className="px-3 py-2 align-top text-right font-semibold text-emerald-700">{formatPrice(calculateTotalCost(item))}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        const ComparisonTab = ({ data }) => {
            const today = new Date();
            const [selectedVehicle, setSelectedVehicle] = useState('');
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(today.getMonth());

            const { uniqueVehicles, uniqueYears } = useMemo(() => {
                const vehicles = new Set();
                const years = new Set();
                data.forEach(item => {
                    if (item['เบอร์รถ']) vehicles.add(item['เบอร์รถ']);
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    if (date) years.add(date.getFullYear());
                });
                return {
                    uniqueVehicles: Array.from(vehicles).sort(),
                    uniqueYears: Array.from(years).sort((a, b) => b - a)
                };
            }, [data]);

            const comparisonData = useMemo(() => {
                if (!selectedVehicle) return null;

                const vehicleData = data.filter(item => item['เบอร์รถ'] === selectedVehicle);

                const currentMonthData = vehicleData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    return date && date.getFullYear() === selectedYear && date.getMonth() === selectedMonth;
                });
                const currentMonthTotal = currentMonthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);

                const prevMonthDate = new Date(selectedYear, selectedMonth, 1);
                prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
                const prevMonth = prevMonthDate.getMonth();
                const prevYear = prevMonthDate.getFullYear();

                const previousMonthData = vehicleData.filter(item => {
                    const date = parseDate(item['วันที่แจ้งซ่อม(APP)']);
                    return date && date.getFullYear() === prevYear && date.getMonth() === prevMonth;
                });
                const previousMonthTotal = previousMonthData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                
                const difference = currentMonthTotal - previousMonthTotal;
                
                // คำนวณเปอร์เซ็นต์การเปลี่ยนแปลงค่าใช้จ่าย
                const percentageChange = previousMonthTotal > 0 
                    ? ((currentMonthTotal - previousMonthTotal) / previousMonthTotal) * 100 
                    : 0;

                return {
                    currentMonthData,
                    previousMonthData,
                    currentMonthTotal,
                    previousMonthTotal,
                    difference,
                    percentageChange,
                    prevMonth,
                    prevYear
                };
            }, [data, selectedVehicle, selectedYear, selectedMonth]);

            const RepairDetailTable = ({ title, items }) => (
                <div>
                    <h3 className="text-md font-semibold text-slate-700 mb-2">{title}</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">วันที่</th>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">รายการ</th>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">ประเภท</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">ต้นทุนรวม</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.length > 0 ? items.map((item, index) => (
                                    <tr key={index} className="border-t">
                                        <td className="px-4 py-2 text-slate-600 whitespace-nowrap">{formatDate(item['วันที่แจ้งซ่อม(APP)'])}</td>
                                        <td className="px-4 py-2 text-slate-700">{item['รายการซ่อม']}</td>
                                        <td className="px-4 py-2 text-slate-600">{item['ประเภท']}</td>
                                        <td className="px-4 py-2 text-right font-semibold text-emerald-700">{formatPrice(calculateTotalCost(item))}</td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="4" className="text-center py-4 text-slate-500">ไม่พบข้อมูล</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedVehicle} onChange={e => setSelectedVehicle(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">-- เลือกเบอร์รถ --</option>
                            {uniqueVehicles.map(v => <option key={v} value={v}>{v}</option>)}
                        </select>
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][i]}</option>)}
                        </select>
                    </div>

                    {!selectedVehicle ? (
                        <div className="text-center py-12 text-gray-500 bg-white rounded-lg shadow">
                            กรุณาเลือกเบอร์รถเพื่อดูการเปรียบเทียบ
                        </div>
                    ) : (
                        <div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <SummaryCard 
                                    title={`ยอดซ่อม ${['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][selectedMonth]} ${selectedYear + 543}`}
                                    value={formatPrice(comparisonData.currentMonthTotal)}
                                    unit="บาท"
                                    icon={<Icons name="balance" />}
                                    color={{ bg: 'bg-blue-100', icon: 'text-blue-600', border: 'border-blue-500' }}
                                />
                                <SummaryCard 
                                    title={`ยอดซ่อม ${['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][comparisonData.prevMonth]} ${comparisonData.prevYear + 543}`}
                                    value={formatPrice(comparisonData.previousMonthTotal)}
                                    unit="บาท"
                                    icon={<Icons name="balance" />}
                                    color={{ bg: 'bg-gray-100', icon: 'text-gray-600', border: 'border-gray-400' }}
                                />
                                <SummaryCard 
                                    title="ผลต่าง"
                                    value={formatPrice(comparisonData.difference)}
                                    unit="บาท"
                                    icon={comparisonData.difference >= 0 ? <Icons name="up"/> : <Icons name="down"/>}
                                    color={comparisonData.difference >= 0 ? 
                                        { bg: 'bg-red-100', icon: 'text-red-600', border: 'border-red-500' } : 
                                        { bg: 'bg-green-100', icon: 'text-green-600', border: 'border-green-500' }}
                                />
                                <SummaryCard 
                                    title="% การเปลี่ยนแปลง"
                                    value={Math.abs(comparisonData.percentageChange).toFixed(1)}
                                    unit="%"
                                    icon={comparisonData.percentageChange >= 0 ? <Icons name="up"/> : <Icons name="down"/>}
                                    color={comparisonData.percentageChange >= 0 ? 
                                        { bg: 'bg-red-100', icon: 'text-red-600', border: 'border-red-500' } : 
                                        { bg: 'bg-green-100', icon: 'text-green-600', border: 'border-green-500' }}
                                    footer={`เทียบกับ ${['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][comparisonData.prevMonth]} ${comparisonData.prevYear + 543}`}
                                />
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <RepairDetailTable title={`รายการซ่อมเดือน ${['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][selectedMonth]}`} items={comparisonData.currentMonthData} />
                                <RepairDetailTable title={`รายการซ่อมเดือน ${['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][comparisonData.prevMonth]}`} items={comparisonData.previousMonthData} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // ##################################################################
        // ### REPAIR APP MAIN COMPONENT (คอมโพเนนต์หลักของแอปแจ้งซ่อม) ###
        // ##################################################################
        const RepairApp = ({ data, isMobile }) => {
            const [activeTab, setActiveTab] = useState('all');
            const tabConfig = [ 
                { id: 'all', label: 'ข้อมูลทั้งหมด' }, 
                { id: 'weekly', label: 'รายสัปดาห์' }, 
                { id: 'type', label: 'สรุปประเภท' }, 
                { id: 'vehicle', label: 'สถิติรถ' },
                { id: 'comparison', label: 'เปรียบเทียบรายคัน' }
            ];
            const renderContent = () => {
                if (!data || data.length === 0) return <div className="text-center py-8 text-gray-500">ไม่พบข้อมูลการแจ้งซ่อม</div>;
                switch (activeTab) {
                    case 'all': return <AllDataTab data={data} isMobile={isMobile} />;
                    case 'weekly': return <WeeklyTab data={data} isMobile={isMobile} />;
                    case 'type': return <TypeTab data={data} isMobile={isMobile} />;
                    case 'vehicle': return <VehicleTab data={data} isMobile={isMobile} />;
                    case 'comparison': return <ComparisonTab data={data} />;
                    default: return null;
                }
            };
            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <div className="radio-input mb-4 sm:mb-6">
                        {tabConfig.map(tab => (
                            <label className="label" key={tab.id}>
                                <input
                                    value={tab.id}
                                    name="repair-tab-radio"
                                    id={`tab-${tab.id}`}
                                    type="radio"
                                    checked={activeTab === tab.id}
                                    onChange={() => setActiveTab(tab.id)}
                                />
                                <span className="text">{tab.label}</span>
                            </label>
                        ))}
                    </div>
                    {renderContent()}
                </div>
            );
        };
        
        // ##################################################################
        // ### FUEL APP COMPONENTS (START) ###
        // ##################################################################
        const FuelLast7DaysTab = ({ fuelOutData, fuelInData }) => {
            const [expandedDates, setExpandedDates] = useState(new Set());

            const { groupedByDate, chartData } = useMemo(() => {
                const today = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(today.getDate() - 7);

                const filterAndSortData = (data, type) =>
                    (data || [])
                        .filter(item => {
                            const date = parseDate(item['วันที่']);
                            return date && date >= sevenDaysAgo && date <= today;
                        })
                        .map(item => ({ ...item, ประเภท: type }));

                const filteredOut = filterAndSortData(fuelOutData, 'เบิกออก');
                const filteredIn = filterAndSortData(fuelInData, 'รับเข้า');
                const allData = [...filteredOut, ...filteredIn];

                const grouped = allData.reduce((acc, item) => {
                    const dateKey = parseDate(item['วันที่']).toLocaleString('sv-SE', { timeZone: 'Asia/Bangkok' }).split(' ')[0];
                    if (!acc[dateKey]) {
                        acc[dateKey] = { items: [], totalOut: 0, totalIn: 0 };
                    }
                    acc[dateKey].items.push(item);
                    if(item.ประเภท === 'เบิกออก') {
                        acc[dateKey].totalOut += parseFloat(item['ราคาน้ำมัน']) || 0;
                    } else {
                        acc[dateKey].totalIn += parseFloat(item['ราคาน้ำมัน']) || 0;
                    }
                    return acc;
                }, {});

                const sortedGrouped = Object.entries(grouped).sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA));

                const vehicleStats = {};
                filteredOut.forEach(item => {
                    const plate = item['เบอร์รถ'] || 'ไม่ระบุ';
                    const cost = parseFloat(item['ราคาน้ำมัน']) || 0;
                    if (!vehicleStats[plate]) vehicleStats[plate] = { total: 0, count: 0 };
                    vehicleStats[plate].total += cost;
                    vehicleStats[plate].count++;
                });

                const finalChartData = Object.entries(vehicleStats).map(([plate, stats]) => ({
                    label: plate,
                    value: stats.total,
                    displayValue: formatPrice(stats.total)
                })).sort((a, b) => b.value - a.value);

                return { groupedByDate: sortedGrouped, chartData: finalChartData };
            }, [fuelOutData, fuelInData]);

            useEffect(() => {
                if (groupedByDate.length > 0) {
                    const latestDateKey = groupedByDate[0][0];
                    setExpandedDates(new Set([latestDateKey]));
                }
            }, [groupedByDate]);

            const toggleDate = (dateKey) => {
                setExpandedDates(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(dateKey)) {
                        newSet.delete(dateKey);
                    } else {
                        newSet.add(dateKey);
                    }
                    return newSet;
                });
            };

            return (
                <div>
                    <h2 className="text-lg font-semibold mb-4 text-slate-800">
                        รายการน้ำมัน 7 วันล่าสุด
                    </h2>

                    <div className="overflow-x-auto bg-white rounded-lg shadow-md p-4 mb-6">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ประเภท</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ปริมาณ (ลิตร)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ราคา (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {groupedByDate.map(([dateKey, data]) => {
                                    const isExpanded = expandedDates.has(dateKey);
                                    return (
                                        <React.Fragment key={dateKey}>
                                            <tr className="bg-slate-50 border-t-2 border-slate-200 cursor-pointer hover:bg-slate-100" onClick={() => toggleDate(dateKey)}>
                                                <td className="px-3 py-2 font-semibold text-slate-700" colSpan="3">
                                                    <div className="flex items-center">
                                                        <span className={`transform transition-transform duration-200 mr-2 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-4 w-4" /></span>
                                                        {formatDate(dateKey)}
                                                    </div>
                                                </td>
                                                <td className="px-3 py-2 text-right font-semibold text-green-600">+{formatPrice(data.totalIn)}</td>
                                                <td className="px-3 py-2 text-right font-semibold text-red-600">-{formatPrice(data.totalOut)}</td>
                                            </tr>
                                            {isExpanded && data.items.map((row, idx) => (
                                                <tr key={idx} className="border-t">
                                                    <td className="px-3 py-2 pl-8 text-slate-500 text-xs">{formatTime(row['เวลา'])}</td>
                                                    <td className="px-3 py-2">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${row['ประเภท'] === 'เบิกออก' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                            {row['ประเภท']}
                                                        </span>
                                                    </td>
                                                    <td className="px-3 py-2 text-slate-700">{row['เบอร์รถ'] || '-'}</td>
                                                    <td className="px-3 py-2 text-right text-slate-600">
                                                        {row['ประเภท'] === 'เบิกออก'
                                                            ? formatNumber(row['จ่ายออก /ลิตร'])
                                                            : formatNumber(row['รับเข้า'])}
                                                    </td>
                                                    <td className="px-3 py-2 text-right font-semibold text-emerald-600">
                                                        {formatPrice(row['ราคาน้ำมัน'])}
                                                    </td>
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    <BarChart
                        data={chartData}
                        color="bg-indigo-500"
                        title="มูลค่าน้ำมันตามทะเบียนรถ (เบิกออก - 7 วันล่าสุด)"
                    />
                </div>
            );
        };
        const FuelCharts = ({ supplyData }) => {
            const { dieselPriceChart, dieselLiterChart, benzenePriceChart, benzeneLiterChart } = useMemo(() => {
                if (!supplyData || supplyData.length === 0) {
                    return { dieselPriceChart: [], dieselLiterChart: [], benzenePriceChart: [], benzeneLiterChart: [] };
                }

                const processFuelData = (data, valueField, unit) => {
                    const vehicleSummary = data.reduce((acc, item) => {
                        const vehicle = item['เบอร์รถ'] || 'ไม่ระบุ';
                        const value = parseFloat(item[valueField]) || 0;
                        if (!acc[vehicle]) acc[vehicle] = 0;
                        acc[vehicle] += value;
                        return acc;
                    }, {});

                    return Object.entries(vehicleSummary)
                        .map(([label, value]) => ({ label, value, displayValue: `${formatNumber(value)} ${unit}` }))
                        .sort((a, b) => b.value - a.value)
                        .slice(0, 10);
                };
                
                const dieselData = supplyData.filter(item => {
                    const fuelType = item['ชนิดน้ำมัน'] ? item['ชนิดน้ำมัน'].toLowerCase() : '';
                    return fuelType.includes('ดีเซล');
                });
                const benzeneData = supplyData.filter(item => {
                    const fuelType = item['ชนิดน้ำมัน'] ? item['ชนิดน้ำมัน'].toLowerCase() : '';
                    return fuelType.includes('เบนซิน') || fuelType.includes('แก๊สโซฮอล์') || fuelType.includes('91') || fuelType.includes('95');
                });

                const dieselPriceChart = processFuelData(dieselData, 'ราคาน้ำมัน', 'บาท');
                const dieselLiterChart = processFuelData(dieselData, 'จ่ายออก /ลิตร', 'ลิตร');
                const benzenePriceChart = processFuelData(benzeneData, 'ราคาน้ำมัน', 'บาท');
                const benzeneLiterChart = processFuelData(benzeneData, 'จ่ายออก /ลิตร', 'ลิตร');

                return { dieselPriceChart, dieselLiterChart, benzenePriceChart, benzeneLiterChart };

            }, [supplyData]);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <BarChart data={dieselLiterChart} color="bg-sky-600" title="10 อันดับรถที่เบิกดีเซลสูงสุด (ลิตร)" />
                    <BarChart data={dieselPriceChart} color="bg-sky-500" title="10 อันดับรถที่เบิกดีเซลสูงสุด (บาท)" />
                    <BarChart data={benzeneLiterChart} color="bg-amber-600" title="อันดับรถที่เบิกเบนซินสูงสุด (ลิตร)" />
                    <BarChart data={benzenePriceChart} color="bg-amber-500" title="อันดับรถที่เบิกเบนซินสูงสุด (บาท)" />
                    

                </div>
            );
        };

        const FuelSupplyTab = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const [expandedVehicles, setExpandedVehicles] = useState(new Set());

            const groupedByMonth = useMemo(() => {
                if (!data) return [];
                const grouped = data.reduce((acc, item) => {
                    const date = parseDate(item['วันที่']);
                    if (!date) return acc;
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!acc[monthKey]) {
                        acc[monthKey] = { year: date.getFullYear(), month: date.getMonth(), items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[monthKey].items.push(item);
                    acc[monthKey].totalLiters += Number(item['จ่ายออก /ลิตร']) || 0;
                    acc[monthKey].totalPrice += Number(item['ราคาน้ำมัน']) || 0;
                    return acc;
                }, {});
                return Object.entries(grouped).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));
            }, [data]);
            
            const groupVehicles = (items) => {
                 if (!items) return [];
                 const grouped = items.reduce((acc, item) => {
                    const vehicle = item['เบอร์รถ'] || 'ไม่ระบุ';
                    if (!acc[vehicle]) {
                        acc[vehicle] = { items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[vehicle].items.push(item);
                    acc[vehicle].totalLiters += Number(item['จ่ายออก /ลิตร']) || 0;
                    acc[vehicle].totalPrice += Number(item['ราคาน้ำมัน']) || 0;
                    return acc;
                }, {});
                return Object.entries(grouped).sort(([, a], [, b]) => b.totalPrice - a.totalPrice);
            };

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            const toggleVehicle = (vehicleKey) => {
                setExpandedVehicles(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(vehicleKey)) newSet.delete(vehicleKey);
                    else newSet.add(vehicleKey);
                    return newSet;
                });
            };

            return (
                <div className="space-y-2">
                    {groupedByMonth.length === 0 && <div className="text-center py-8 text-gray-500">ไม่พบข้อมูลในเดือนที่เลือก</div>}
                    {groupedByMonth.map(([monthKey, monthData]) => {
                        const isMonthExpanded = expandedMonths.has(monthKey);
                        const vehiclesInMonth = groupVehicles(monthData.items);
                        return (
                             <div key={monthKey} className="border rounded-lg overflow-hidden bg-white">
                                <div onClick={() => toggleMonth(monthKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50 bg-blue-50">
                                    <div className="flex items-center">
                                        <span className={`transform transition-transform duration-200 mr-2 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-blue-600" /></span>
                                        <h4 className="font-semibold text-blue-800">{getThaiMonthName(monthData.month)} {monthData.year}</h4>
                                    </div>
                                     <div className="text-sm text-right">
                                        <div className="font-semibold text-red-600">{formatPrice(monthData.totalPrice)} บาท</div>
                                        <div className="text-xs text-slate-500">{formatNumber(monthData.totalLiters)} ลิตร</div>
                                    </div>
                                </div>
                                <div className={`transition-all duration-300 ease-in-out ${isMonthExpanded ? 'max-h-[5000px] opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                    <div className="p-4 bg-blue-50/30 border-t space-y-2">
                                        {vehiclesInMonth.map(([vehicle, stats]) => {
                                            const vehicleKey = `${monthKey}-${vehicle}`;
                                            const isVehicleExpanded = expandedVehicles.has(vehicleKey);
                                            return (
                                                <div key={vehicleKey} className="border rounded-lg overflow-hidden bg-white">
                                                    <div onClick={() => toggleVehicle(vehicleKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50">
                                                        <div className="flex items-center">
                                                            <span className={`transform transition-transform duration-200 mr-2 ${isVehicleExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-slate-500" /></span>
                                                            <h5 className="font-medium text-slate-700">{vehicle}</h5>
                                                        </div>
                                                        <div className="text-sm text-right">
                                                            <div className="font-semibold text-red-600">{formatPrice(stats.totalPrice)} บาท</div>
                                                            <div className="text-xs text-slate-500">{formatNumber(stats.totalLiters)} ลิตร</div>
                                                        </div>
                                                    </div>
                                                    <div className={`transition-all duration-300 ease-in-out ${isVehicleExpanded ? 'max-h-none opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                                        <div className="p-4 bg-slate-50/70 border-t">
                                                            <table className="w-full text-sm">
                                                                <thead className="bg-slate-200">
                                                                    <tr>
                                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">ชนิดน้ำมัน</th>
                                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">จ่ายออก (ลิตร)</th>
                                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">ราคาน้ำมัน (บาท)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {stats.items.map((item, index) => (
                                                                        <tr key={index} className="border-t">
                                                                            <td className="px-3 py-2 text-slate-600">{formatSimpleDate(item['วันที่'])}</td>
                                                                            <td className="px-3 py-2 text-slate-700">{item['ชนิดน้ำมัน']}</td>
                                                                            <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item['จ่ายออก /ลิตร'])}</td>
                                                                            <td className="px-3 py-2 text-right text-red-600">{formatPrice(item['ราคาน้ำมัน'])}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const FuelReceivingTab = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());

            const groupedByMonth = useMemo(() => {
                if (!data) return [];
                const grouped = data.reduce((acc, item) => {
                    const date = parseDate(item['วันที่']);
                    if (!date) return acc;
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!acc[monthKey]) {
                        acc[monthKey] = { year: date.getFullYear(), month: date.getMonth(), items: [], totalLiters: 0, totalPrice: 0 };
                    }
                    acc[monthKey].items.push(item);
                    acc[monthKey].totalLiters += Number(item['รับเข้า']) || 0;
                    acc[monthKey].totalPrice += Number(item['ราคาน้ำมัน']) || 0;
                    return acc;
                }, {});

                return Object.entries(grouped).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));
            }, [data]);

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            return (
                <div className="space-y-2">
                    {groupedByMonth.length === 0 && <div className="text-center py-8 text-gray-500">ไม่พบข้อมูลในเดือนที่เลือก</div>}
                    {groupedByMonth.map(([monthKey, monthData]) => {
                        const isMonthExpanded = expandedMonths.has(monthKey);
                        return (
                             <div key={monthKey} className="border rounded-lg overflow-hidden bg-white">
                                <div onClick={() => toggleMonth(monthKey)} className="p-3 cursor-pointer flex justify-between items-center hover:bg-slate-50 bg-blue-50">
                                    <div className="flex items-center">
                                        <span className={`transform transition-transform duration-200 mr-2 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons name="chevronDown" className="h-5 w-5 text-blue-600" /></span>
                                        <h4 className="font-semibold text-blue-800">{getThaiMonthName(monthData.month)} {monthData.year}</h4>
                                    </div>
                                    <div className="text-sm text-right">
                                        <div className="font-semibold text-green-600">{formatPrice(monthData.totalPrice)} บาท</div>
                                        <div className="text-xs text-slate-500">{formatNumber(monthData.totalLiters)} ลิตร</div>
                                    </div>
                                </div>
                                <div className={`transition-all duration-300 ease-in-out ${isMonthExpanded ? 'max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'} overflow-hidden`}>
                                    <div className="p-4 bg-blue-50/30 border-t">
                                        <table className="w-full text-sm bg-white rounded-lg overflow-hidden">
                                            <thead className="bg-slate-200">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ชนิดน้ำมัน</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">รับเข้า (ลิตร)</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ราคาน้ำมัน (บาท)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {monthData.items.map((item, index) => (
                                                    <tr key={index} className="border-t">
                                                        <td className="px-3 py-2 text-slate-600">{formatSimpleDate(item['วันที่'])}</td>
                                                        <td className="px-3 py-2 text-slate-700">{item['ชนิดน้ำมัน']}</td>
                                                        <td className="px-3 py-2 text-right text-green-600">{formatNumber(item['รับเข้า'])}</td>
                                                        <td className="px-3 py-2 text-right text-green-600">{formatPrice(item['ราคาน้ำมัน'])}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )
        };

        const FuelApp = ({ data }) => {
            const [activeTab, setActiveTab] = useState('last7days');
            const [selectedYear, setSelectedYear] = useState('all');
            const [selectedMonth, setSelectedMonth] = useState('all');

            const { uniqueYears } = useMemo(() => {
                const allFuelData = [...(data.receiving || []), ...(data.supply || [])];
                const years = new Set(allFuelData.map(item => parseDate(item['วันที่'])?.getFullYear()).filter(Boolean));
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);

            const filteredData = useMemo(() => {
                const filterByDate = (d) => {
                    if (!d) return [];
                    const dataWithoutCarryOver = d.filter(item => item['เลขที่ใบเบิก SAP'] !== 'ยอดยกมา');

                    if (selectedYear === 'all') return dataWithoutCarryOver;
                    
                    return dataWithoutCarryOver.filter(item => {
                        const date = parseDate(item['วันที่']);
                        if (!date) return false;
                        const yearMatch = date.getFullYear() === parseInt(selectedYear, 10);
                        const monthMatch = selectedMonth === 'all' || date.getMonth() === parseInt(selectedMonth, 10);
                        return yearMatch && monthMatch;
                    });
                };
                return {
                    receiving: filterByDate(data.receiving),
                    supply: filterByDate(data.supply)
                };
            }, [data, selectedYear, selectedMonth]);

            const { summary } = useMemo(() => {
                const receivingInPeriod = filteredData.receiving;
                const supplyInPeriod = filteredData.supply;

                const aggregateFuelData = (data, valueField) => {
                    const summary = { 'ดีเซล': 0, 'เบนซิน': 0 };
                    (data || []).forEach(item => {
                        const type = item['ชนิดน้ำมัน'] || 'ไม่ระบุ';
                        const value = Number(item[valueField]) || 0;
                        const fuelTypeStr = type.toLowerCase();
                        if (fuelTypeStr.includes('ดีเซล')) {
                            summary['ดีเซล'] += value;
                        } else if (fuelTypeStr.includes('เบนซิน') || fuelTypeStr.includes('แก๊สโซฮอล์') || fuelTypeStr.includes('91') || fuelTypeStr.includes('95')) {
                            summary['เบนซิน'] += value;
                        }
                    });
                    return summary;
                };

                const receivedBahtByType = aggregateFuelData(receivingInPeriod, 'ราคาน้ำมัน');
                const receivedLitersByType = aggregateFuelData(receivingInPeriod, 'รับเข้า');
                const suppliedBahtByType = aggregateFuelData(supplyInPeriod, 'ราคาน้ำมัน');
                const suppliedLitersByType = aggregateFuelData(supplyInPeriod, 'จ่ายออก /ลิตร');

                // Helper function to get cumulative balance up to a certain date
                const getCumulativeBalanceByDate = (endDate) => {
                    const receiving = (data.receiving || []).filter(item => {
                        const date = parseDate(item['วันที่']);
                        return date && date <= endDate;
                    });
                    const supply = (data.supply || []).filter(item => {
                        const date = parseDate(item['วันที่']);
                        return date && date <= endDate;
                    });

                    const totalReceivedLiters = aggregateFuelData(receiving, 'รับเข้า');
                    const totalSuppliedLiters = aggregateFuelData(supply, 'จ่ายออก /ลิตร');

                    return {
                        'ดีเซล': (totalReceivedLiters['ดีเซล'] || 0) - (totalSuppliedLiters['ดีเซล'] || 0),
                        'เบนซิน': (totalReceivedLiters['เบนซิน'] || 0) - (totalSuppliedLiters['เบนซิน'] || 0),
                    };
                };

                let fuelBalanceByType = {};
                
                if (selectedYear === 'all') {
                    // If 'all years' is selected, show the total cumulative balance as before.
                    const allReceiving = data.receiving || [];
                    const allSupply = data.supply || [];
                    const totalReceivedLiters = aggregateFuelData(allReceiving, 'รับเข้า');
                    const totalSuppliedLiters = aggregateFuelData(allSupply, 'จ่ายออก /ลิตร');
                    fuelBalanceByType = {
                        'ดีเซล': (totalReceivedLiters['ดีเซล'] || 0) - (totalSuppliedLiters['ดีเซล'] || 0),
                        'เบนซิน': (totalReceivedLiters['เบนซิน'] || 0) - (totalSuppliedLiters['เบนซิน'] || 0),
                    };
                } else {
                    // If a specific year/month is selected, calculate the change from the previous period.
                    let endOfCurrentPeriod, endOfPreviousPeriod;
                    const year = parseInt(selectedYear, 10);

                    if (selectedMonth === 'all') { // Yearly view
                        endOfCurrentPeriod = new Date(year, 12, 0); // Last day of the year
                        endOfPreviousPeriod = new Date(year - 1, 12, 0); // Last day of the previous year
                    } else { // Monthly view
                        const month = parseInt(selectedMonth, 10);
                        endOfCurrentPeriod = new Date(year, month + 1, 0); // Last day of the selected month
                        endOfPreviousPeriod = new Date(year, month, 0); // Last day of the previous month
                    }
                    
                    endOfCurrentPeriod.setHours(23, 59, 59, 999);
                    endOfPreviousPeriod.setHours(23, 59, 59, 999);

                    const currentBalance = getCumulativeBalanceByDate(endOfCurrentPeriod);
                    const previousBalance = getCumulativeBalanceByDate(endOfPreviousPeriod);

                    fuelBalanceByType = {
                        'ดีเซล': currentBalance['ดีเซล'] - previousBalance['ดีเซล'],
                        'เบนซิน': currentBalance['เบนซิน'] - previousBalance['เบนซิน'],
                    };
                }

                // Value calculation remains based on cumulative average price for stability
                const allDataBeforeEndDate = (d) => {
                    if (!d) return [];
                    if (selectedYear === 'all') return d;
                    
                    const endOfMonth = new Date(parseInt(selectedYear, 10), selectedMonth === 'all' ? 12 : parseInt(selectedMonth, 10) + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    
                    return d.filter(item => {
                        const date = parseDate(item['วันที่']);
                        return date && date <= endOfMonth;
                    });
                };
                
                const receivingBefore = allDataBeforeEndDate(data.receiving);
                const totalReceivedLiters = aggregateFuelData(receivingBefore, 'รับเข้า');
                const totalReceivedValue = aggregateFuelData(receivingBefore, 'ราคาน้ำมัน');
                
                const avgPriceByType = {
                    'ดีเซล': totalReceivedLiters['ดีเซล'] > 0 ? totalReceivedValue['ดีเซล'] / totalReceivedLiters['ดีเซล'] : 0,
                    'เบนซิน': totalReceivedLiters['เบนซิน'] > 0 ? totalReceivedValue['เบนซิน'] / totalReceivedLiters['เบนซิน'] : 0,
                };
                const fuelBalanceValueByType = {
                    'ดีเซล': fuelBalanceByType['ดีเซล'] * avgPriceByType['ดีเซล'],
                    'เบนซิน': fuelBalanceByType['เบนซิน'] * avgPriceByType['เบนซิน'],
                };

                return { 
                    summary: {
                        receivedBahtByType,
                        suppliedBahtByType,
                        receivedLitersByType,
                        suppliedLitersByType,
                        fuelBalanceByType,
                        fuelBalanceValueByType
                    }
                };
            }, [filteredData, data, selectedYear, selectedMonth]); 

            return (
                 <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => { setSelectedYear(e.target.value); setSelectedMonth('all'); }} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">ทุกปี</option>
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md" disabled={selectedYear === 'all'}>
                            <option value="all">ทุกเดือน</option>
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][i]}</option>)}
                        </select>
                    </div>

                    <div className="space-y-6">
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">สรุปยอดรับเข้า</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <SummaryCard key="r-liter-diesel" title="รับเข้า ดีเซล (ลิตร)" value={formatNumber(summary.receivedLitersByType['ดีเซล'])} unit="ลิตร" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-liter-benzene" title="รับเข้า เบนซิน (ลิตร)" value={formatNumber(summary.receivedLitersByType['เบนซิน'])} unit="ลิตร" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-baht-diesel" title="รับเข้า ดีเซล (บาท)" value={formatPrice(summary.receivedBahtByType['ดีเซล'])} unit="บาท" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                                <SummaryCard key="r-baht-benzene" title="รับเข้า เบนซิน (บาท)" value={formatPrice(summary.receivedBahtByType['เบนซิน'])} unit="บาท" icon={<Icons name="up"/>} color={{bg:'bg-green-100', icon:'text-green-600', border:'border-green-500'}}/>
                             </div>
                        </div>
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">สรุปยอดจ่ายออก</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <SummaryCard key="s-liter-diesel" title="จ่ายออก ดีเซล (ลิตร)" value={formatNumber(summary.suppliedLitersByType['ดีเซล'])} unit="ลิตร" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-liter-benzene" title="จ่ายออก เบนซิน (ลิตร)" value={formatNumber(summary.suppliedLitersByType['เบนซิน'])} unit="ลิตร" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-baht-diesel" title="จ่ายออก ดีเซล (บาท)" value={formatPrice(summary.suppliedBahtByType['ดีเซล'])} unit="บาท" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                                <SummaryCard key="s-baht-benzene" title="จ่ายออก เบนซิน (บาท)" value={formatPrice(summary.suppliedBahtByType['เบนซิน'])} unit="บาท" icon={<Icons name="down"/>} color={{bg:'bg-red-100', icon:'text-red-600', border:'border-red-500'}}/>
                             </div>
                        </div>
                        <div>
                             <h3 className="text-lg font-semibold text-slate-700 mb-3">สรุปยอดคงเหลือ (ณ สิ้นเดือนที่เลือก)</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                {summary.fuelBalanceByType['ดีเซล'] !== undefined && <SummaryCard key="b-liter-diesel" title="คงเหลือ ดีเซล (ลิตร)" value={formatNumber(summary.fuelBalanceByType['ดีเซล'])} unit="ลิตร" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceByType['เบนซิน'] !== undefined && <SummaryCard key="b-liter-benzene" title="คงเหลือ เบนซิน (ลิตร)" value={formatNumber(summary.fuelBalanceByType['เบนซิน'])} unit="ลิตร" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceValueByType['ดีเซล'] !== undefined && <SummaryCard key="b-baht-diesel" title="มูลค่าคงเหลือ ดีเซล (บาท)" value={formatPrice(summary.fuelBalanceValueByType['ดีเซล'])} unit="บาท" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                                {summary.fuelBalanceValueByType['เบนซิน'] !== undefined && <SummaryCard key="b-baht-benzene" title="มูลค่าคงเหลือ เบนซิน (บาท)" value={formatPrice(summary.fuelBalanceValueByType['เบนซิน'])} unit="บาท" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', icon:'text-blue-600', border:'border-blue-500'}}/>}
                             </div>
                        </div>
                    </div>
                    
                    <div className="mt-8">
                        <FuelCharts supplyData={filteredData.supply} />
                    </div>

                    <div className="flex border-b border-gray-200 mt-8 mb-4 sm:mb-6 overflow-x-auto">
                        <button onClick={() => setActiveTab('last7days')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'last7days' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                            7 วันล่าสุด
                        </button>
                        <button onClick={() => setActiveTab('supply')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'supply' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                            ข้อมูลการจ่ายน้ำมัน
                        </button>
                        <button onClick={() => setActiveTab('receiving')} className={`py-2 px-3 sm:px-4 font-medium whitespace-nowrap text-sm sm:text-base border-b-2 ${activeTab === 'receiving' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                           ข้อมูลการรับน้ำมัน
                        </button>
                    </div>
                    
                    {activeTab === 'last7days' && <FuelLast7DaysTab fuelOutData={data.supply} fuelInData={data.receiving} />}
                    {activeTab === 'supply' && <FuelSupplyTab data={filteredData.supply} />}
                    {activeTab === 'receiving' && <FuelReceivingTab data={filteredData.receiving} />}
                </div>
            );
        };
        // ### FUEL APP COMPONENTS (END) ###
        
        // ##################################################################
        // ### EV CHARGING APP COMPONENTS (START) ###
        // ##################################################################

        const EVChargingCharts = ({ chartData }) => {
            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <BarChart data={chartData.vehicleCost} color="bg-amber-500" title="10 อันดับรถที่ค่าไฟฟ้าสูงสุด" />
                    <BarChart data={chartData.chargerKwh} color="bg-sky-500" title="10 อันดับตู้ชาร์จที่ใช้งาน (kWh) สูงสุด" />
                </div>
            );
        };

        const VehicleChargeDetailsModal = ({ vehiclePlate, chargeData, onClose }) => {
            const vehicleHistory = chargeData.filter(item => item.licensePlate === vehiclePlate);
            return (
                <div className="modal-backdrop">
                    <div className="modal-content">
                        <h3 className="text-lg font-bold mb-4">ประวัติการชาร์จ: {vehiclePlate}</h3>
                        <div className="overflow-y-auto max-h-[60vh]">
                             <table className="w-full text-sm">
                                <thead className="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">ตู้ชาร์จ</th>
                                        <th className="px-3 py-2 text-right font-medium text-slate-600">kWh</th>
                                        <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าไฟ (บาท)</th>
                                        <th className="px-3 py-2 text-left font-medium text-slate-600">ระยะเวลา</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {vehicleHistory.map((item, index) => (
                                        <tr key={item.id || index} className="border-t">
                                            <td className="px-3 py-2 text-slate-600">{formatDate(item.date)}</td>
                                            <td className="px-3 py-2 text-slate-700">{item.chargerName}</td>
                                            <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.units)}</td>
                                            <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.electricityCost)}</td>
                                            <td className="px-3 py-2 text-slate-600">{item.duration}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={onClose} className="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition">ปิด</button>
                    </div>
                </div>
            );
        };

        const BatteryPerformanceAnalysis = ({ vehicleData, evConfig }) => {
            const batteryAnalysis = useMemo(() => {
                if (!vehicleData || vehicleData.length === 0) return [];

                const analysis = vehicleData.map(vehicle => {
                    const config = evConfig[vehicle.licensePlate];
                    if (!config) return null;

                    // คำนวณประสิทธิภาพแบตเตอรี่แบบขั้นสูง
                    const avgKwhPerCharge = vehicle.totalKwh / vehicle.count;
                    const avgCostPerKwh = vehicle.totalCost / vehicle.totalKwh;
                    const chargingFrequency = vehicle.count; // จำนวนครั้งที่ชาร์จ
                    
                    // ประเมินประสิทธิภาพรวมปัจจัย SOC, DoD และ Cycle Efficiency
                    const standardKwhPerCharge = 16; // kWh มาตรฐานต่อการชาร์จ
                    
                    // ประมาณค่า SOC และ DoD จากรูปแบบการใช้งาน
                    const usageRatio = avgKwhPerCharge / standardKwhPerCharge;
                    const estimatedSOC = Math.max(20, Math.min(90, 100 - (usageRatio - 1) * 50)); // SOC 20-90%
                    const estimatedDoD = Math.min(80, usageRatio * 60); // DoD 0-80%
                    const cycleEfficiency = 0.92; // ประสิทธิภาพรอบการชาร์จ 92%
                    
                    // ปัจจัยปรับแต่งตาม SOC และ DoD
                    const socFactor = estimatedSOC > 80 ? 0.95 : (estimatedSOC < 30 ? 0.85 : 1.0);
                    const dodFactor = estimatedDoD > 70 ? 0.90 : (estimatedDoD < 20 ? 0.95 : 1.0);
                    
                    // คำนวณประสิทธิภาพรวม
                    const baseEfficiency = (avgKwhPerCharge / standardKwhPerCharge) * 100;
                    const efficiency = (baseEfficiency * socFactor * dodFactor * cycleEfficiency).toFixed(1);
                    
                    // สถานะแบตเตอรี่ตามประสิทธิภาพ (ยิ่งใกล้ 100% ยิ่งดี)
                    let batteryStatus = 'ดีเยี่ยม';
                    let statusColor = 'text-green-600';
                    if (efficiency > 120 || efficiency < 60) {
                        batteryStatus = 'ต้องตรวจสอบ';
                        statusColor = 'text-red-600';
                    } else if (efficiency > 110 || efficiency < 80) {
                        batteryStatus = 'ปานกลาง';
                        statusColor = 'text-yellow-600';
                    } else if (efficiency > 105 || efficiency < 95) {
                        batteryStatus = 'ดี';
                        statusColor = 'text-blue-600';
                    }

                    return {
                        licensePlate: vehicle.licensePlate,
                        totalKwh: vehicle.totalKwh,
                        totalCost: vehicle.totalCost,
                        count: vehicle.count,
                        avgKwhPerCharge,
                        avgCostPerKwh,
                        efficiency: parseFloat(efficiency),
                        batteryStatus,
                        statusColor,
                        chargingFrequency,
                        estimatedSOC: estimatedSOC.toFixed(1),
                        estimatedDoD: estimatedDoD.toFixed(1),
                        cycleEfficiency: (cycleEfficiency * 100).toFixed(1),
                        socFactor: socFactor.toFixed(2),
                        dodFactor: dodFactor.toFixed(2)
                    };
                }).filter(Boolean);

                return analysis.sort((a, b) => b.efficiency - a.efficiency);
            }, [vehicleData, evConfig]);

            if (batteryAnalysis.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">การวิเคราะห์ประสิทธิภาพแบตเตอรี่รถ EV</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ประสิทธิภาพ (%)</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">สถานะแบตเตอรี่</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">SOC (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">DoD (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">Cycle Eff (%)</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">เฉลี่ย kWh/ครั้ง</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าไฟ/kWh</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ความถี่การชาร์จ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าไฟรวม</th>
                                </tr>
                            </thead>
                            <tbody>
                                {batteryAnalysis.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-50">
                                        <td className="px-3 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-3 py-2 text-right font-semibold">
                                            <span className={item.efficiency >= 95 ? 'text-green-600' : item.efficiency >= 85 ? 'text-blue-600' : item.efficiency >= 70 ? 'text-yellow-600' : 'text-red-600'}>
                                                {item.efficiency}%
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.statusColor} bg-opacity-10`}>
                                                {item.batteryStatus}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.estimatedSOC}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.estimatedDoD}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.cycleEfficiency}%</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.avgKwhPerCharge)} kWh</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.avgCostPerKwh)} บาท</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.chargingFrequency} ครั้ง</td>
                                        <td className="px-3 py-2 text-right font-semibold text-sky-700">{formatPrice(item.totalCost)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-3 text-xs text-slate-500">
                        <p>* ประสิทธิภาพคำนวณจากการเปรียบเทียบกับค่ามาตรฐาน 16 kWh ต่อการชาร์จ (100% = ใช้ไฟตามมาตรฐาน)</p>
                        <p>* สถานะแบตเตอรี่: ดีเยี่ยม (95-105%), ดี (80-94% หรือ 106-110%), ปานกลาง (60-79% หรือ 111-120%), ต้องตรวจสอบ (&lt;60% หรือ &gt;120%)</p>
                    </div>
                </div>
            );
        };

        const AdvancedBatteryMetrics = ({ vehicleData, evConfig }) => {
            const advancedMetrics = useMemo(() => {
                if (!vehicleData || vehicleData.length === 0) return [];

                return vehicleData.map(vehicle => {
                    const config = evConfig[vehicle.licensePlate];
                    if (!config) return null;

                    const avgKwhPerCharge = vehicle.totalKwh / vehicle.count;
                    const chargingFrequency = vehicle.count;
                    
                    // Battery Health Score (0-100)
                    const usageRatio = avgKwhPerCharge / 16;
                    const frequencyFactor = Math.min(1, chargingFrequency / 30); // ปกติ 30 ครั้ง/เดือน
                    const healthScore = Math.max(0, Math.min(100, 100 - (Math.abs(usageRatio - 1) * 20) - (frequencyFactor > 0.8 ? (frequencyFactor - 0.8) * 50 : 0)));
                    
                    // Temperature Impact Estimation (สมมติจากการใช้งาน)
                    const tempImpact = usageRatio > 1.2 ? 'สูง' : usageRatio > 0.8 ? 'ปานกลาง' : 'ต่ำ';
                    const tempColor = tempImpact === 'สูง' ? 'text-red-600' : tempImpact === 'ปานกลาง' ? 'text-yellow-600' : 'text-green-600';
                    
                    // Charging Pattern Analysis
                    const avgChargePerDay = chargingFrequency / 30; // สมมติ 30 วัน
                    let chargingPattern = 'ปกติ';
                    let patternColor = 'text-blue-600';
                    if (avgChargePerDay > 2) {
                        chargingPattern = 'บ่อยเกินไป';
                        patternColor = 'text-red-600';
                    } else if (avgChargePerDay < 0.5) {
                        chargingPattern = 'น้อยเกินไป';
                        patternColor = 'text-orange-600';
                    } else if (avgChargePerDay > 1.5) {
                        chargingPattern = 'ค่อนข้างบ่อย';
                        patternColor = 'text-yellow-600';
                    }
                    
                    // Battery Degradation Estimate (% per year)
                    const degradationRate = Math.max(1, Math.min(8, 2 + (Math.abs(usageRatio - 1) * 3) + (frequencyFactor > 0.8 ? 2 : 0)));
                    
                    // Optimal Charging Recommendation
                    let recommendation = 'ใช้งานได้ตามปกติ';
                    if (healthScore < 70) {
                        recommendation = 'ควรตรวจสอบแบตเตอรี่';
                    } else if (avgChargePerDay > 2) {
                        recommendation = 'ลดความถี่การชาร์จ';
                    } else if (usageRatio > 1.3) {
                        recommendation = 'ลดการใช้งานหนัก';
                    }

                    return {
                        licensePlate: vehicle.licensePlate,
                        healthScore: healthScore.toFixed(1),
                        tempImpact,
                        tempColor,
                        chargingPattern,
                        patternColor,
                        avgChargePerDay: avgChargePerDay.toFixed(1),
                        degradationRate: degradationRate.toFixed(1),
                        recommendation
                    };
                }).filter(Boolean);
            }, [vehicleData, evConfig]);

            if (advancedMetrics.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">เมตริกขั้นสูงสำหรับแบตเตอรี่ EV</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">Health Score</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">อุณหภูมิกระทบ</th>
                                    <th className="px-3 py-2 text-center font-medium text-slate-600">รูปแบบการชาร์จ</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ชาร์จ/วัน</th>
                                    <th className="px-3 py-2 text-right font-medium text-slate-600">การเสื่อม/ปี (%)</th>
                                    <th className="px-3 py-2 text-left font-medium text-slate-600">คำแนะนำ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {advancedMetrics.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-50">
                                        <td className="px-3 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-3 py-2 text-right font-semibold">
                                            <span className={item.healthScore >= 80 ? 'text-green-600' : item.healthScore >= 60 ? 'text-yellow-600' : 'text-red-600'}>
                                                {item.healthScore}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.tempColor} bg-opacity-10`}>
                                                {item.tempImpact}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.patternColor} bg-opacity-10`}>
                                                {item.chargingPattern}
                                            </span>
                                        </td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.avgChargePerDay}</td>
                                        <td className="px-3 py-2 text-right text-slate-600">{item.degradationRate}%</td>
                                        <td className="px-3 py-2 text-slate-600 text-xs">{item.recommendation}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-3 text-xs text-slate-500">
                        <p>* Health Score: คะแนนสุขภาพแบตเตอรี่ (100 = ดีที่สุด, 0 = ต้องเปลี่ยน)</p>
                        <p>* การเสื่อม/ปี: ประมาณการอัตราการเสื่อมสภาพของแบตเตอรี่ต่อปี</p>
                        <p>* อุณหภูมิกระทบ: ประเมินผลกระทบจากอุณหภูมิต่อประสิทธิภาพแบตเตอรี่</p>
                    </div>
                </div>
            );
        };

        const VehicleCostSummaryTable = ({ summaryData, onVehicleSelect }) => {
            if (!summaryData || summaryData.length === 0) return null;

            return (
                <div className="mb-6">
                    <h3 className="text-lg font-semibold text-slate-800 mb-3">สรุปค่าไฟฟ้าตามทะเบียนรถ</h3>
                    <div className="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="px-4 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">จำนวนครั้งที่ชาร์จ</th>
                                    <th className="px-4 py-2 text-right font-medium text-slate-600">ค่าไฟฟ้าทั้งหมด (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {summaryData.map((item) => (
                                    <tr key={item.licensePlate} className="border-t hover:bg-slate-100 cursor-pointer" onClick={() => onVehicleSelect(item.licensePlate)}>
                                        <td className="px-4 py-2 font-medium text-slate-700">{item.licensePlate}</td>
                                        <td className="px-4 py-2 text-right text-slate-600">{item.count}</td>
                                        <td className="px-4 py-2 text-right font-semibold text-sky-700">{formatPrice(item.totalCost)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const WeeklyAccordion = ({ weekData, isExpanded, onToggle, weekNumber }) => {
            const { chargerSummary, vehicleSummary, items, startDate, endDate } = weekData;

            const groupedWeeklyItems = useMemo(() => {
                if (!items) return {};
                return items.reduce((acc, item) => {
                    const plate = item.licensePlate || 'ไม่ระบุ';
                    if (!acc[plate]) {
                        acc[plate] = { items: [], totalKwh: 0, totalCost: 0, durations: [] };
                    }
                    acc[plate].items.push(item);
                    acc[plate].totalKwh += parseFloat(item.units) || 0;
                    acc[plate].totalCost += parseFloat(item.electricityCost) || 0;
                    if(item.duration) acc[plate].durations.push(item.duration);
                    return acc;
                }, {});
            }, [items]);

            return (
                <div className="mb-2 border border-slate-200 rounded-lg overflow-hidden">
                    <div onClick={onToggle} className="bg-slate-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors duration-200">
                        <div className="flex items-center">
                             <span className={`transform transition-transform duration-200 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}>
                                <Icons name="chevronDown" className="h-5 w-5 mr-2 text-slate-500" />
                            </span>
                            <h4 className="font-semibold text-slate-700">
                                สัปดาห์ที่ {weekNumber}
                                <span className="font-normal text-slate-500 text-sm ml-2">
                                    ({formatDate(startDate)} - {formatDate(endDate)})
                                </span>
                            </h4>
                        </div>
                        <div className="text-sm text-slate-600">
                            <span className="font-semibold">{items.length}</span> รายการ | <span className="font-semibold text-sky-700">{formatPrice(weekData.totalCost)}</span> บาท
                        </div>
                    </div>
                    <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                        <div className="p-4 bg-white">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                {/* Charger Summary Table */}
                                <div>
                                    <h5 className="font-semibold text-slate-800 mb-2">สรุปการใช้งานตู้ชาร์จ</h5>
                                    <div className="overflow-x-auto border rounded-md">
                                        <table className="w-full text-sm">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ตู้ชาร์จ</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">จำนวนครั้ง</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าใช้จ่าย (บาท)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {Object.entries(chargerSummary).sort(([,a],[,b]) => b.count - a.count).map(([charger, data]) => (
                                                    <tr key={charger} className="border-t">
                                                        <td className="px-3 py-2 font-medium text-slate-700">{charger}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{data.count}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(data.totalCost)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                 {/* Vehicle Summary Table */}
                                <div>
                                    <h5 className="font-semibold text-slate-800 mb-2">สรุปการใช้งานของรถ</h5>
                                    <div className="overflow-x-auto border rounded-md">
                                        <table className="w-full text-sm">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="px-3 py-2 text-left font-medium text-slate-600">ทะเบียนรถ</th>
                                                    <th className="px-3 py-2 text-right font-medium text-slate-600">จำนวนครั้ง</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                 {Object.entries(vehicleSummary).sort(([,a],[,b]) => b.count - a.count).map(([vehicle, data]) => (
                                                    <tr key={vehicle} className="border-t">
                                                        <td className="px-3 py-2 font-medium text-slate-700">{vehicle}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{data.count}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {/* Detailed Charging List */}
                            <h5 className="font-semibold text-slate-800 mb-2">รายการชาร์จทั้งหมดในสัปดาห์นี้</h5>
                             <div className="overflow-x-auto border rounded-md">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">วันที่</th>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">ตู้ชาร์จ</th>
                                            <th className="px-3 py-2 text-right font-medium text-slate-600">จำนวน (kWh)</th>
                                            <th className="px-3 py-2 text-right font-medium text-slate-600">ค่าไฟฟ้า (บาท)</th>
                                            <th className="px-3 py-2 text-left font-medium text-slate-600">ระยะเวลา (นาที)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(groupedWeeklyItems).map(([plate, summary]) => (
                                            <React.Fragment key={plate}>
                                                <tr className="bg-slate-200/60 border-t border-b border-slate-300">
                                                    <td colSpan="5" className="px-3 py-2 font-semibold text-slate-800">
                                                        ทะเบียน: {plate}
                                                    </td>
                                                </tr>
                                                {summary.items.map((item, index) => (
                                                    <tr key={item.id || index} className="border-t hover:bg-slate-50">
                                                        <td className="px-3 py-2 text-slate-600 pl-6">{formatDate(item.date)}</td>
                                                        <td className="px-3 py-2 text-slate-700">{item.chargerName}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatNumber(item.units)}</td>
                                                        <td className="px-3 py-2 text-right text-slate-600">{formatPrice(item.electricityCost)}</td>
                                                        <td className="px-3 py-2 text-slate-600">{item.duration}</td>
                                                    </tr>
                                                ))}
                                                <tr className="bg-green-100 border-t-2 border-green-300 font-semibold">
                                                    <td colSpan="2" className="px-3 py-2 text-right text-green-800">รวม</td>
                                                    <td className="px-3 py-2 text-right text-green-800">{formatNumber(summary.totalKwh)}</td>
                                                    <td className="px-3 py-2 text-right text-green-800">{formatPrice(summary.totalCost)}</td>
                                                    <td className="px-3 py-2 text-green-800">{sumDurations(summary.durations)}</td>
                                                </tr>
                                            </React.Fragment>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EVChargingApp = ({ data }) => {
            const [expandedMonths, setExpandedMonths] = useState(new Set());
            const [expandedWeeks, setExpandedWeeks] = useState(new Set());
            const [selectedYear, setSelectedYear] = useState('all');
            const [selectedMonth, setSelectedMonth] = useState('all');
            const [selectedVehicleDetails, setSelectedVehicleDetails] = useState(null);

            // EV Configuration for battery analysis
            const EV_CONFIG = {
                'TT-19': { name: 'TT-19', price: 533930 },
                'TT-20': { name: 'TT-20', price: 1660000 },
                'TT-21': { name: 'TT-21', price: 1660000 },
                'TT-22': { name: 'TT-22', price: 1660000 },
                'TT-23': { name: 'TT-23', price: 1660000 },
            };

            const { uniqueYears } = useMemo(() => {
                const years = new Set(data.map(item => parseDate(item.date)?.getFullYear()).filter(Boolean));
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [data]);

            const filteredData = useMemo(() => {
                if (selectedYear === 'all') return data;
                return data.filter(item => {
                    const date = parseDate(item.date);
                    if (!date) return false;
                    const yearMatch = date.getFullYear() === parseInt(selectedYear, 10);
                    const monthMatch = selectedMonth === 'all' || date.getMonth() === parseInt(selectedMonth, 10);
                    return yearMatch && monthMatch;
                });
            }, [data, selectedYear, selectedMonth]);

            const dateRange = useMemo(() => {
                if(filteredData.length === 0) return { startDate: null, endDate: null };
                const dates = filteredData.map(item => parseDate(item.date).getTime()).filter(t => !isNaN(t));
                if(dates.length === 0) return { startDate: null, endDate: null };
                const startDate = new Date(Math.min(...dates));
                const endDate = new Date(Math.max(...dates));
                return { startDate, endDate };
            }, [filteredData]);

            const groupedData = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return [];

                const getWeekInfo = (d) => {
                    const date = new Date(d.getTime());
                    date.setHours(0, 0, 0, 0);
                    date.setDate(date.getDate() + 4 - (date.getDay() || 7));
                    const yearStart = new Date(date.getFullYear(), 0, 1);
                    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
                    return `${date.getFullYear()}-W${weekNo}`;
                };

                const processed = filteredData.reduce((acc, item) => {
                    const date = parseDate(item.date);
                    if (!date) return acc;

                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const monthKey = `${year}-${month}`;
                    const weekKey = getWeekInfo(date);

                    if (!acc[monthKey]) {
                        acc[monthKey] = { year, month, weeks: {}, totalKwh: 0, totalCost: 0, count: 0 };
                    }

                    if (!acc[monthKey].weeks[weekKey]) {
                        const firstDayOfWeek = new Date(date);
                        const day = firstDayOfWeek.getDay();
                        const diff = firstDayOfWeek.getDate() - day + (day === 0 ? -6 : 1); 
                        firstDayOfWeek.setDate(diff);
                        
                        const lastDayOfWeek = new Date(firstDayOfWeek);
                        lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                        acc[monthKey].weeks[weekKey] = { 
                            items: [], 
                            chargerSummary: {}, 
                            vehicleSummary: {},
                            totalKwh: 0,
                            totalCost: 0,
                            startDate: firstDayOfWeek.toISOString(),
                            endDate: lastDayOfWeek.toISOString()
                        };
                    }
                    
                    const week = acc[monthKey].weeks[weekKey];
                    week.items.push(item);
                    
                    const cost = parseFloat(item.electricityCost) || 0;
                    const kwh = parseFloat(item.units) || 0;
                    const charger = item.chargerName || 'ไม่ระบุ';
                    const vehicle = item.licensePlate || 'ไม่ระบุ';

                    week.totalCost += cost;
                    week.totalKwh += kwh;
                    
                    if (!week.chargerSummary[charger]) week.chargerSummary[charger] = { count: 0, totalCost: 0 };
                    week.chargerSummary[charger].count++;
                    week.chargerSummary[charger].totalCost += cost;

                    if (!week.vehicleSummary[vehicle]) week.vehicleSummary[vehicle] = { count: 0 };
                    week.vehicleSummary[vehicle].count++;
                    
                    acc[monthKey].totalCost += cost;
                    acc[monthKey].totalKwh += kwh;
                    acc[monthKey].count++;

                    return acc;
                }, {});
                
                return Object.entries(processed).sort(([keyA], [keyB]) => new Date(keyB.split('-')[0], keyB.split('-')[1]) - new Date(keyA.split('-')[0], keyA.split('-')[1]));

            }, [filteredData]);

            const vehicleCostSummary = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return [];

                const summary = filteredData.reduce((acc, item) => {
                    const vehicle = item.licensePlate || 'ไม่ระบุ';
                    const cost = parseFloat(item.electricityCost) || 0;
                    const kwh = parseFloat(item.units) || 0;

                    if (!acc[vehicle]) {
                        acc[vehicle] = { totalCost: 0, totalKwh: 0, count: 0 };
                    }
                    acc[vehicle].totalCost += cost;
                    acc[vehicle].totalKwh += kwh;
                    acc[vehicle].count++;
                    return acc;
                }, {});

                return Object.entries(summary)
                    .map(([licensePlate, data]) => ({
                        licensePlate,
                        totalCost: data.totalCost,
                        totalKwh: data.totalKwh,
                        count: data.count,
                    }))
                    .sort((a, b) => b.totalCost - a.totalCost);

            }, [filteredData]);

            const chartData = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return { vehicleCost: [], chargerKwh: [] };

                const vehicleSummary = filteredData.reduce((acc, item) => {
                    const vehicle = item.licensePlate || 'ไม่ระบุ';
                    const cost = parseFloat(item.electricityCost) || 0;
                    if (!acc[vehicle]) acc[vehicle] = 0;
                    acc[vehicle] += cost;
                    return acc;
                }, {});

                const chargerSummary = filteredData.reduce((acc, item) => {
                    const charger = item.chargerName || 'ไม่ระบุ';
                    const kwh = parseFloat(item.units) || 0;
                    if (!acc[charger]) acc[charger] = { totalKwh: 0, count: 0 };
                    acc[charger].totalKwh += kwh;
                    acc[charger].count++;
                    return acc;
                }, {});

                const vehicleCost = Object.entries(vehicleSummary)
                    .map(([label, value]) => ({ label, value, displayValue: formatPrice(value) }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                const chargerKwh = Object.entries(chargerSummary)
                    .map(([label, data]) => ({ label, value: data.totalKwh, displayValue: `${formatNumber(data.totalKwh)} kWh` }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return { vehicleCost, chargerKwh };
            }, [filteredData]);

            const toggleMonth = (monthKey) => {
                setExpandedMonths(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(monthKey)) newSet.delete(monthKey);
                    else newSet.add(monthKey);
                    return newSet;
                });
            };

            const toggleWeek = (weekKey) => {
                setExpandedWeeks(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(weekKey)) newSet.delete(weekKey);
                    else newSet.add(weekKey);
                    return newSet;
                });
            };
            
            const { totalKwh, totalCost, avgKwhPerDay, avgCostPerDay } = useMemo(() => {
                if (filteredData.length === 0) {
                    return { totalKwh: 0, totalCost: 0, avgKwhPerDay: 0, avgCostPerDay: 0 };
                }
                const kwh = filteredData.reduce((sum, item) => sum + (parseFloat(item.units) || 0), 0);
                const cost = filteredData.reduce((sum, item) => sum + (parseFloat(item.electricityCost) || 0), 0);

                let numberOfDays = 0;
                if (dateRange.startDate && dateRange.endDate) {
                    const diffTime = Math.abs(dateRange.endDate.getTime() - dateRange.startDate.getTime());
                    numberOfDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                } else if (filteredData.length > 0) {
                     numberOfDays = 1;
                }

                const avgKwhPerDay = numberOfDays > 0 ? kwh / numberOfDays : 0;
                const avgCostPerDay = numberOfDays > 0 ? cost / numberOfDays : 0;

                return { totalKwh: kwh, totalCost: cost, avgKwhPerDay, avgCostPerDay };
            }, [filteredData, dateRange]);

            const summaryFooterText = dateRange.startDate && dateRange.endDate 
                ? `ข้อมูล ณ ${formatDate(dateRange.startDate)} - ${formatDate(dateRange.endDate)}`
                : "ไม่มีข้อมูลในข่วงที่เลือก";

            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">ประวัติการชาร์จรถ EV</h2>
                    
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => { setSelectedYear(e.target.value); setSelectedMonth('all'); }} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">ทุกปี</option>
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md" disabled={selectedYear === 'all'}>
                            <option value="all">ทุกเดือน</option>
                            {Array.from({ length: 12 }).map((_, i) => <option key={i} value={i}>{['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][i]}</option>)}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <SummaryCard title="ปริมาณการใช้ไฟทั้งหมด" value={formatNumber(totalKwh)} unit="kWh" icon={<Icons name="bolt" />} color={{ bg: 'bg-sky-100', icon: 'text-sky-600', border: 'border-sky-500' }} footerText={summaryFooterText} />
                        <SummaryCard title="ค่าไฟฟ้าทั้งหมด" value={formatPrice(totalCost)} unit="บาท" icon={<Icons name="balance" />} color={{ bg: 'bg-amber-100', icon: 'text-amber-600', border: 'border-amber-500' }} footerText={summaryFooterText}/>
                        <SummaryCard title="ใช้ไฟเฉลี่ยต่อวัน" value={formatNumber(avgKwhPerDay)} unit="kWh" icon={<Icons name="bolt" />} color={{ bg: 'bg-teal-100', icon: 'text-teal-600', border: 'border-teal-500' }} footerText="คำนวณจากช่วงวันที่ที่เลือก" />
                        <SummaryCard title="ค่าไฟเฉลี่ยต่อวัน" value={formatPrice(avgCostPerDay)} unit="บาท" icon={<Icons name="balance" />} color={{ bg: 'bg-indigo-100', icon: 'text-indigo-600', border: 'border-indigo-500' }} footerText="คำนวณจากช่วงวันที่ที่เลือก" />
                    </div>
                    
                    <EVChargingCharts chartData={chartData} />
                    <BatteryPerformanceAnalysis vehicleData={vehicleCostSummary} evConfig={EV_CONFIG} />
                    <AdvancedBatteryMetrics vehicleData={vehicleCostSummary} evConfig={EV_CONFIG} />
                    <VehicleCostSummaryTable summaryData={vehicleCostSummary} onVehicleSelect={setSelectedVehicleDetails} />

                    <h3 className="text-lg font-semibold text-slate-800 mb-3 mt-8">รายละเอียดการชาร์จรายเดือน/สัปดาห์</h3>
                    <div className="space-y-4">
                        {groupedData.length > 0 ? groupedData.map(([monthKey, monthData]) => {
                             const monthName = getThaiMonthName(monthData.month) + ' ' + monthData.year;
                             const isMonthExpanded = expandedMonths.has(monthKey);
                             const sortedWeeks = Object.entries(monthData.weeks).sort(([, a], [, b]) => new Date(a.startDate) - new Date(b.startDate));

                             return (
                                <div key={monthKey} className="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                                     <div onClick={() => toggleMonth(monthKey)} className="month-header bg-blue-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-blue-100 transition-colors duration-200">
                                        <div className="flex items-center">
                                            <span className={`transform transition-transform duration-200 ${isMonthExpanded ? 'rotate-0' : '-rotate-90'}`}>
                                                <Icons name="chevronDown" className="h-5 w-5 mr-2 text-blue-600" />
                                            </span>
                                            <h3 className="font-semibold text-blue-800 text-lg">{monthName}</h3>
                                        </div>
                                        <div className="text-sm text-slate-700">
                                            <span className="font-semibold">{monthData.count}</span> รายการ | <span className="font-semibold text-sky-800">{formatPrice(monthData.totalCost)}</span> บาท
                                        </div>
                                    </div>
                                    <div className={`month-content transition-all duration-300 ease-in-out overflow-hidden ${isMonthExpanded ? 'max-h-[10000px] opacity-100' : 'max-h-0 opacity-50'}`}>
                                        <div className="p-4 bg-blue-50/30">
                                            {sortedWeeks.map(([weekKey, weekData], index) => (
                                                <WeeklyAccordion 
                                                    key={weekKey}
                                                    weekData={weekData}
                                                    weekNumber={index + 1}
                                                    isExpanded={expandedWeeks.has(weekKey)}
                                                    onToggle={() => toggleWeek(weekKey)}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                             )
                        }) : <div className="text-center py-8 text-gray-500">ไม่พบข้อมูลการชาร์จ</div>}
                    </div>
                    {selectedVehicleDetails && (
                        <VehicleChargeDetailsModal 
                            vehiclePlate={selectedVehicleDetails}
                            chargeData={filteredData}
                            onClose={() => setSelectedVehicleDetails(null)}
                        />
                    )}
                </div>
            );
        };
        // ### EV CHARGING APP COMPONENTS (END) ###
        
        // ##################################################################
        // ### ENERGY COMPARISON APP (START) ###
        // ##################################################################
        const MonthlyComparisonLineChart = ({ data, currentYear, previousYear }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            
            const labels = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const previousYearData = data.map(d => d.previousYear);
            const currentYearData = data.map(d => d.currentYear);
            
            React.useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy existing chart
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Calculate smooth trend line using moving average
                    const calculateSmoothTrend = (data) => {
                        const smoothedData = [];
                        const windowSize = 3; // 3-month moving average
                        
                        for (let i = 0; i < data.length; i++) {
                            let sum = 0;
                            let count = 0;
                            
                            // Calculate moving average with available data points
                            for (let j = Math.max(0, i - Math.floor(windowSize/2)); 
                                 j <= Math.min(data.length - 1, i + Math.floor(windowSize/2)); j++) {
                                if (data[j] !== null && data[j] !== undefined) {
                                    sum += data[j];
                                    count++;
                                }
                            }
                            
                            smoothedData[i] = count > 0 ? sum / count : data[i];
                        }
                        
                        return smoothedData;
                    };
                    
                    const currentYearTrend = calculateSmoothTrend(currentYearData);
                    const previousYearTrend = calculateSmoothTrend(previousYearData);
                    
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            type: 'bar',
                            label: `ปี ${previousYear + 543}`,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            data: previousYearData,
                            order: 2
                        }, {
                            type: 'bar',
                            label: `ปี ${currentYear + 543}`,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            data: currentYearData,
                            order: 2
                        }, {
                            type: 'line',
                            label: `แนวโน้ม ปี ${previousYear + 543}`,
                            borderColor: '#1e40af',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            data: previousYearTrend,
                            order: 1,
                            tension: 0.4
                        }, {
                            type: 'line',
                            label: `แนวโน้ม ปี ${currentYear + 543}`,
                            borderColor: '#059669',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            data: currentYearTrend,
                            order: 1,
                            tension: 0.4
                        }]
                    };
                    
                    const config = {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `เปรียบเทียบค่าน้ำมันรายเดือน: ปี ${previousYear + 543} vs ปี ${currentYear + 543}`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    color: '#374151'
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: '#374151',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (value === null || value === undefined) return null;
                                            return `${context.dataset.label}: ${formatPrice(value)} บาท`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        },
                                        color: '#6b7280'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.3)'
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        },
                                        color: '#6b7280',
                                        callback: function(value) {
                                            return formatPrice(value) + ' บาท';
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    chartInstance.current = new Chart(ctx, config);
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, currentYear, previousYear]);
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div className="relative h-96">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };
        
        // Progress Bar Component สำหรับแสดงการเปรียบเทียบ
        const ComparisonProgressBar = ({ currentValue, previousValue, title, unit = "บาท" }) => {
            const difference = currentValue - previousValue;
            const percentageChange = previousValue > 0 ? ((difference / previousValue) * 100) : 0;
            const isIncrease = difference > 0;
            const isSaving = difference < 0;
            
            // คำนวณความกว้างของ progress bar (0-100%)
            const maxValue = Math.max(currentValue, previousValue);
            const currentPercentage = maxValue > 0 ? (currentValue / maxValue) * 100 : 0;
            const previousPercentage = maxValue > 0 ? (previousValue / maxValue) * 100 : 0;
            
            return (
                <div className="bg-white p-6 rounded-lg shadow-md border">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
                    
                    {/* เดือนที่แล้ว */}
                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium text-gray-600">เดือนที่แล้ว</span>
                            <span className="text-sm font-semibold text-blue-600">{formatPrice(previousValue)} {unit}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                className="bg-blue-500 h-3 rounded-full transition-all duration-500 ease-out"
                                style={{ width: `${previousPercentage}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* เดือนปัจจุบัน */}
                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium text-gray-600">เดือนปัจจุบัน</span>
                            <span className={`text-sm font-semibold ${isIncrease ? 'text-red-600' : 'text-green-600'}`}>
                                {formatPrice(currentValue)} {unit}
                            </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                className={`h-3 rounded-full transition-all duration-500 ease-out ${
                                    isIncrease ? 'bg-red-500' : 'bg-green-500'
                                }`}
                                style={{ width: `${currentPercentage}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* ผลต่าง */}
                    <div className={`p-4 rounded-lg ${
                        isSaving ? 'bg-green-50 border border-green-200' : 
                        isIncrease ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'
                    }`}>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <div className={`w-3 h-3 rounded-full mr-2 ${
                                    isSaving ? 'bg-green-500' : 
                                    isIncrease ? 'bg-red-500' : 'bg-gray-500'
                                }`}></div>
                                <span className="text-sm font-medium text-gray-700">
                                    {isSaving ? 'ประหยัด' : isIncrease ? 'เพิ่มขึ้น' : 'ไม่เปลี่ยนแปลง'}
                                </span>
                            </div>
                            <div className="text-right">
                                <div className={`text-lg font-bold ${
                                    isSaving ? 'text-green-600' : 
                                    isIncrease ? 'text-red-600' : 'text-gray-600'
                                }`}>
                                    {formatPrice(Math.abs(difference))} {unit}
                                </div>
                                <div className={`text-sm ${
                                    isSaving ? 'text-green-500' : 
                                    isIncrease ? 'text-red-500' : 'text-gray-500'
                                }`}>
                                    {Math.abs(percentageChange).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ##################################################################
        // ### CARBON REDUCTION CALCULATION FUNCTIONS ###
        // ##################################################################
        
        // Emission factors (kg CO2 per liter) from TGO Thailand <mcreference link="https://thaicarbonlabel.tgo.or.th/index.php?lang=EN&mod=YjNKbllXNXBlbUYwYVc5dVgyVnRhWE56YVc5dQ" index="1">1</mcreference>
        const EMISSION_FACTORS = {
            gasoline: 2.181564,  // Motor gasoline
            diesel: 2.698722     // Gas/Diesel oil
        };
        
        // Function to calculate carbon reduction from fuel savings
        const calculateCarbonReduction = (fuelSavingsLiters, fuelType = 'diesel') => {
            const emissionFactor = EMISSION_FACTORS[fuelType] || EMISSION_FACTORS.diesel;
            return fuelSavingsLiters * emissionFactor; // kg CO2
        };
        
        // Function to estimate fuel consumption from cost (approximate)
        const estimateFuelConsumptionFromCost = (fuelCost, avgFuelPrice = 35) => {
            return fuelCost / avgFuelPrice; // liters (approximate)
        };
        
        // Function to calculate carbon reduction from cost savings
        const calculateCarbonReductionFromCostSavings = (costSavings, avgFuelPrice = 35, fuelType = 'diesel') => {
            if (costSavings <= 0) return 0;
            const fuelSavingsLiters = estimateFuelConsumptionFromCost(costSavings, avgFuelPrice);
            return calculateCarbonReduction(fuelSavingsLiters, fuelType);
        };
        
        // Function to format carbon reduction display
        const formatCarbonReduction = (carbonKg) => {
            if (carbonKg >= 1000) {
                return `${(carbonKg / 1000).toFixed(2)} ตัน`;
            } else {
                return `${carbonKg.toFixed(2)} กก.`;
            }
        };
        
        const EnergyComparisonApp = ({ fuelData, evData }) => {
            const today = new Date();
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(today.getMonth()); // เดือนปัจจุบัน
            
            // ตรวจสอบข้อมูล
            if (!fuelData || !fuelData.supply) {
                return (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">เปรียบเทียบค่าใช้จ่ายน้ำมันรายเดือน</h2>
                        <div className="text-center p-8 text-gray-600">
                            <p>ไม่พบข้อมูลน้ำมัน กรุณารอสักครู่...</p>
                        </div>
                    </div>
                );
            }

            const { uniqueYears, availableMonths } = useMemo(() => {
                const years = new Set();
                const months = new Set();
                const supply = fuelData?.supply || [];
                supply.forEach(item => {
                    const date = parseDate(item['วันที่']);
                    if (date) {
                        years.add(date.getFullYear());
                        if (date.getFullYear() === selectedYear) {
                            months.add(date.getMonth());
                        }
                    }
                });
                
                // ถ้าไม่มีข้อมูลปี ให้ใช้ปีปัจจุบัน
                if (years.size === 0) {
                    const currentYear = new Date().getFullYear();
                    years.add(currentYear);
                }
                
                return { 
                    uniqueYears: Array.from(years).sort((a, b) => b - a),
                    availableMonths: Array.from(months).sort((a, b) => a - b)
                };
            }, [fuelData, selectedYear]);

            const comparisonData = useMemo(() => {
                const fuel = (fuelData?.supply || []).filter(item => item['เลขที่ใบเบิก SAP'] !== 'ยอดยกมา');

                const getMonthlyFuelCost = (year, month) => {
                    return fuel.filter(item => {
                        const date = parseDate(item['วันที่']);
                        if (!date) return false;
                        return date.getFullYear() === year && date.getMonth() === month;
                    }).reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                };

                const currentMonthCost = getMonthlyFuelCost(selectedYear, selectedMonth);
                const previousMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
                const previousMonthYear = selectedMonth === 0 ? selectedYear - 1 : selectedYear;
                const previousMonthCost = getMonthlyFuelCost(previousMonthYear, previousMonth);
                
                const difference = currentMonthCost - previousMonthCost;
                const percentageChange = previousMonthCost > 0 ? ((difference / previousMonthCost) * 100) : 0;
                
                // คำนวณค่าเฉลี่ยต่อวัน
                const daysInCurrentMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
                const daysInPreviousMonth = new Date(previousMonthYear, previousMonth + 1, 0).getDate();
                const avgCurrentMonthPerDay = currentMonthCost / daysInCurrentMonth;
                const avgPreviousMonthPerDay = previousMonthCost / daysInPreviousMonth;
                const avgDailyDifference = avgCurrentMonthPerDay - avgPreviousMonthPerDay;
                
                // คำนวณค่าน้ำมันทั้งปี
                const getYearlyFuelCost = (year) => {
                    return fuel.filter(item => {
                        const date = parseDate(item['วันที่']);
                        if (!date) return false;
                        return date.getFullYear() === year;
                    }).reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                };
                
                const currentYearTotal = getYearlyFuelCost(selectedYear);
                const previousYearTotal = getYearlyFuelCost(selectedYear - 1);
                
                // คำนวณเปอร์เซ็นต์การประหยัดน้ำมันและการลดคาร์บอน
                const yearlyFuelSavings = previousYearTotal - currentYearTotal;
                const yearlyFuelSavingsPercentage = previousYearTotal > 0 ? ((yearlyFuelSavings / previousYearTotal) * 100) : 0;
                const yearlyCarbonReduction = yearlyFuelSavings > 0 ? calculateCarbonReductionFromCostSavings(yearlyFuelSavings) : 0;
                const previousYearCarbonTotal = calculateCarbonReductionFromCostSavings(previousYearTotal);
                const yearlyCarbonReductionPercentage = previousYearCarbonTotal > 0 ? ((yearlyCarbonReduction / previousYearCarbonTotal) * 100) : 0;

                return {
                    currentMonthCost,
                    previousMonthCost,
                    difference,
                    percentageChange,
                    avgCurrentMonthPerDay,
                    avgPreviousMonthPerDay,
                    avgDailyDifference,
                    currentMonthName: getThaiMonthName(selectedMonth),
                    previousMonthName: getThaiMonthName(previousMonth),
                    previousMonthYear,
                    currentYearTotal,
                    previousYearTotal,
                    yearlyFuelSavings,
                    yearlyFuelSavingsPercentage,
                    yearlyCarbonReduction,
                    yearlyCarbonReductionPercentage
                };

            }, [fuelData, selectedYear, selectedMonth]);



            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">เปรียบเทียบค่าใช้จ่ายน้ำมันรายเดือน</h2>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {availableMonths.map(month => <option key={month} value={month}>{getThaiMonthName(month)}</option>)}
                        </select>
                    </div>

                    {/* เปรียบเทียบข้อมูลเดือนปัจจุบันกับเดือนที่แล้ว */}
                    <div className="mb-6">
                        <div className="text-center mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">
                                เปรียบเทียบ {comparisonData.currentMonthName} {selectedYear + 543} กับ {comparisonData.previousMonthName} {comparisonData.previousMonthYear + 543}
                            </h3>
                        </div>
                        
                        <ComparisonProgressBar 
                            currentValue={comparisonData.currentMonthCost}
                            previousValue={comparisonData.previousMonthCost}
                            title="ค่าใช้จ่ายน้ำมันรวม"
                            unit="บาท"
                        />
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
                        <SummaryCard 
                            title={`${comparisonData.currentMonthName} ${selectedYear + 543}`}
                            value={formatPrice(comparisonData.currentMonthCost)}
                            unit="บาท"
                            icon={<img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" className="w-8 h-8"/>}
                            color={{bg:'bg-blue-100', border:'border-blue-500'}}
                        />
                        <SummaryCard 
                            title={`${comparisonData.previousMonthName} ${comparisonData.previousMonthYear + 543}`}
                            value={formatPrice(comparisonData.previousMonthCost)}
                            unit="บาท"
                            icon={<img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" className="w-8 h-8"/>}
                            color={{bg:'bg-gray-100', border:'border-gray-500'}}
                        />
                        <SummaryCard 
                            title="ค่าเฉลี่ยต่อวัน"
                            value={formatPrice(Math.abs(comparisonData.avgDailyDifference))}
                            unit={comparisonData.avgDailyDifference >= 0 ? "บาท/วัน (เพิ่ม)" : "บาท/วัน (ลด)"}
                            icon={<Icons name="balance"/>}
                            color={{bg: comparisonData.avgDailyDifference >= 0 ? 'bg-red-100' : 'bg-green-100', border: comparisonData.avgDailyDifference >= 0 ? 'border-red-500' : 'border-green-500'}}
                        />
                        <SummaryCard 
                            title="การลดคาร์บอนตลอดทั้งปี"
                            value={comparisonData.currentYearTotal < comparisonData.previousYearTotal ? formatCarbonReduction(calculateCarbonReductionFromCostSavings(comparisonData.previousYearTotal - comparisonData.currentYearTotal)) : '0 กก.'}
                            unit="CO₂"
                            icon={<span className="text-2xl">🌱</span>}
                            color={{bg:'bg-green-100', border:'border-green-500'}}
                            footerText={comparisonData.currentYearTotal < comparisonData.previousYearTotal ? `จากการประหยัดน้ำมันตลอดทั้งปี ${formatPrice(comparisonData.previousYearTotal - comparisonData.currentYearTotal)} บาท` : 'ไม่มีการประหยัด'}
                        />
                        <SummaryCard 
                            title="% ประหยัดน้ำมัน"
                            value={comparisonData.yearlyFuelSavingsPercentage > 0 ? comparisonData.yearlyFuelSavingsPercentage.toFixed(2) : '0'}
                            unit="%"
                            icon={<span className="text-2xl">⛽</span>}
                            color={{bg: comparisonData.yearlyFuelSavingsPercentage > 0 ? 'bg-blue-100' : 'bg-gray-100', border: comparisonData.yearlyFuelSavingsPercentage > 0 ? 'border-blue-500' : 'border-gray-500'}}
                            footerText={`เปรียบเทียบกับปี ${selectedYear - 1 + 543}`}
                        />
                        <SummaryCard 
                            title="% ลดคาร์บอน"
                            value={comparisonData.yearlyCarbonReductionPercentage > 0 ? comparisonData.yearlyCarbonReductionPercentage.toFixed(2) : '0'}
                            unit="%"
                            icon={<span className="text-2xl">🌍</span>}
                            color={{bg: comparisonData.yearlyCarbonReductionPercentage > 0 ? 'bg-emerald-100' : 'bg-gray-100', border: comparisonData.yearlyCarbonReductionPercentage > 0 ? 'border-emerald-500' : 'border-gray-500'}}
                            footerText={`เปรียบเทียบกับปี ${selectedYear - 1 + 543}`}
                        />                    </div>

                    {/* Cards แสดงข้อมูลทุกเดือนในปีที่เลือก */}
                    <div className="mt-8">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">ข้อมูลค่าใช้จ่ายน้ำมันทุกเดือนในปี {selectedYear + 543}</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {Array.from({length: 12}, (_, index) => {
                                const month = index + 1;
                                const supply = fuelData?.supply || [];
                                const monthData = supply.filter(item => {
                                    const date = parseDate(item['วันที่']);
                                    return date && date.getFullYear() === selectedYear && date.getMonth() + 1 === month;
                                });
                                
                                // คำนวณข้อมูลเดือนก่อนหน้า
                                const previousMonth = month === 1 ? 12 : month - 1;
                                const previousYear = month === 1 ? selectedYear - 1 : selectedYear;
                                const previousMonthData = supply.filter(item => {
                                    const date = parseDate(item['วันที่']);
                                    return date && date.getFullYear() === previousYear && date.getMonth() + 1 === previousMonth;
                                });
                                
                                const monthCost = monthData.reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                                const previousMonthCost = previousMonthData.reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                                const savings = previousMonthCost - monthCost; // ประหยัด = เดือนก่อน - เดือนปัจจุบัน
                                const monthName = getThaiMonthName(month);
                                const hasData = monthData.length > 0;
                                const hasPreviousData = previousMonthData.length > 0;
                                
                                return (
                                    <div key={month} className={`p-4 rounded-lg border-2 transition-all duration-200 hover:shadow-md ${
                                        hasData 
                                            ? month === selectedMonth + 1
                                                ? 'bg-blue-50 border-blue-500 shadow-md' 
                                                : 'bg-white border-gray-200 hover:border-blue-300'
                                            : 'bg-gray-50 border-gray-200 opacity-60'
                                    }`}>
                                        <div className="text-center">
                                            <div className={`text-sm font-medium mb-2 ${
                                                hasData ? 'text-gray-700' : 'text-gray-400'
                                            }`}>
                                                {monthName}
                                            </div>
                                            <div className={`text-lg font-bold ${
                                                hasData 
                                                    ? month === selectedMonth + 1
                                                        ? 'text-blue-600' 
                                                        : 'text-gray-800'
                                                    : 'text-gray-400'
                                            }`}>
                                                {hasData ? formatPrice(monthCost) : '0'}
                                            </div>
                                            <div className={`text-xs ${
                                                hasData ? 'text-gray-500' : 'text-gray-400'
                                            }`}>
                                                บาท
                                            </div>
                                            {hasData && (
                                                <div className="text-xs text-gray-500 mt-1">
                                                    {monthData.length} รายการ
                                                </div>
                                            )}
                                            {hasData && hasPreviousData && (
                                                <>
                                                    <div className={`text-xs mt-1 font-medium ${
                                                        savings > 0 ? 'text-green-600' : 
                                                        savings < 0 ? 'text-red-600' : 'text-gray-500'
                                                    }`}>
                                                        {savings > 0 ? 'ประหยัด ' : savings < 0 ? 'เพิ่มขึ้น ' : 'เท่าเดิม '}
                                                        {Math.abs(savings) > 0 ? formatPrice(Math.abs(savings)) : '0'}
                                                    </div>
                                                    {savings > 0 && (
                                                        <div className="text-xs mt-1 text-green-700 font-medium">
                                                            <span className="text-green-600">🌱</span> ลดคาร์บอน {formatCarbonReduction(calculateCarbonReductionFromCostSavings(savings))}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                            {hasData && !hasPreviousData && (
                                                <div className="text-xs text-gray-400 mt-1">
                                                    ไม่มีข้อมูลเปรียบเทียบ
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ##################################################################
        // ### EV IMPACT APP (START) ###
        // ##################################################################
        const EVImpactApp = ({ fuelData, evData }) => {
            const today = new Date();
            const [selectedYear, setSelectedYear] = useState(today.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState('all'); // 'all' for the whole year

            const { uniqueYears } = useMemo(() => {
                const years = new Set();
                (fuelData?.supply || []).forEach(item => {
                    const date = parseDate(item['วันที่']);
                    if (date) years.add(date.getFullYear());
                });
                return { uniqueYears: Array.from(years).sort((a, b) => b - a) };
            }, [fuelData]);

            const comparisonData = useMemo(() => {
                const currentYear = selectedYear;
                const previousYear = selectedYear - 1;
                
                const fuel = (fuelData?.supply || []).filter(item => item['เลขที่ใบเบิก SAP'] !== 'ยอดยกมา');
                
                const getYearlyData = (year) => {
                    const yearData = fuel.filter(item => {
                        const date = parseDate(item['วันที่']);
                        return date && date.getFullYear() === year;
                    });
                    
                    const monthlyData = Array(12).fill(0);
                    let totalCost = 0;
                    
                    yearData.forEach(item => {
                        const date = parseDate(item['วันที่']);
                        if (date) {
                            const month = date.getMonth();
                            const cost = Number(item['ราคาน้ำมัน']) || 0;
                            monthlyData[month] += cost;
                            totalCost += cost;
                        }
                    });
                    
                    return { monthlyData, totalCost };
                };
                
                const currentYearData = getYearlyData(currentYear);
                const previousYearData = getYearlyData(previousYear);
                
                const totalDifference = currentYearData.totalCost - previousYearData.totalCost;
                const avgDailyDifference = totalDifference / 365;
                
                const monthlyChartData = Array(12).fill(0).map((_, month) => {
                    const currentMonthCost = currentYearData.monthlyData[month];
                    const previousMonthCost = previousYearData.monthlyData[month];
                    const difference = currentMonthCost - previousMonthCost;
                    
                    return {
                        month,
                        currentYear: currentMonthCost,
                        previousYear: previousMonthCost,
                        difference: difference
                    };
                });
                
                // คำนวณเปอร์เซ็นต์การประหยัดน้ำมันต่อปี
                const yearlyFuelSavingsPercentage = previousYearData.totalCost > 0 
                    ? ((previousYearData.totalCost - currentYearData.totalCost) / previousYearData.totalCost) * 100 
                    : 0;
                
                return {
                    currentYearTotal: currentYearData.totalCost,
                    previousYearTotal: previousYearData.totalCost,
                    totalDifference,
                    avgDailyDifference,
                    yearlyFuelSavingsPercentage,
                    monthlyChartData
                };
            }, [fuelData, selectedYear]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-3 sm:p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">แนวโน้มค่าใช้จ่ายน้ำมันเทียบรายปี</h2>
                    <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row gap-2">
                        <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            {uniqueYears.map(y => <option key={y} value={y}>{y + 543}</option>)}
                        </select>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value === 'all' ? 'all' : Number(e.target.value))} className="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">ทั้งปี</option>
                            {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{getThaiMonthName(i)}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
                        <SummaryCard title={`ค่าน้ำมันปี ${selectedYear - 1 + 543}`} value={formatPrice(comparisonData.previousYearTotal)} unit="บาท" icon={<Icons name="balance"/>} color={{bg:'bg-blue-100', border:'border-blue-500'}}/>
                        <SummaryCard title={`ค่าน้ำมันปี ${selectedYear + 543}`} value={formatPrice(comparisonData.currentYearTotal)} unit="บาท" icon={<Icons name="balance"/>} color={{bg:'bg-green-100', border:'border-green-500'}}/>
                        <SummaryCard title="ผลต่างค่าน้ำมัน" value={formatPrice(Math.abs(comparisonData.totalDifference))} unit={comparisonData.totalDifference >= 0 ? "บาท (เพิ่ม)" : "บาท (ลด)"} icon={<Icons name="balance"/>} color={{bg: comparisonData.totalDifference >= 0 ? 'bg-red-100' : 'bg-yellow-100', border: comparisonData.totalDifference >= 0 ? 'border-red-500' : 'border-yellow-500'}}/>
                        <SummaryCard title="เปลี่ยนแปลงต่อวัน" value={formatPrice(Math.abs(comparisonData.avgDailyDifference))} unit={comparisonData.avgDailyDifference >= 0 ? "บาท (เพิ่ม)" : "บาท (ลด)"} icon={<Icons name="balance"/>} color={{bg: comparisonData.avgDailyDifference >= 0 ? 'bg-red-100' : 'bg-yellow-100', border: comparisonData.avgDailyDifference >= 0 ? 'border-red-500' : 'border-yellow-500'}}/>
                        <SummaryCard title="การลดคาร์บอนตลอดทั้งปี" value={formatCarbonReduction(calculateCarbonReductionFromCostSavings(Math.abs(comparisonData.totalDifference)))} unit="CO₂" icon={<Icons name="leaf"/>} color={{bg:'bg-emerald-100', border:'border-emerald-500'}}/>
                        <SummaryCard 
                            title="% ประหยัดน้ำมันต่อปี" 
                            value={comparisonData.yearlyFuelSavingsPercentage >= 0 ? comparisonData.yearlyFuelSavingsPercentage.toFixed(2) : '0.00'} 
                            unit={comparisonData.yearlyFuelSavingsPercentage >= 0 ? '% (ประหยัด)' : '% (เพิ่มขึ้น)'} 
                            icon={<span className="text-lg">⛽</span>} 
                            color={{bg: comparisonData.yearlyFuelSavingsPercentage >= 0 ? 'bg-green-100' : 'bg-red-100', border: comparisonData.yearlyFuelSavingsPercentage >= 0 ? 'border-green-500' : 'border-red-500'}} 
                            footer={`เปรียบเทียบกับปี ${selectedYear - 1 + 543}`}
                        />
                    </div>
                    
                    <MonthlyComparisonLineChart data={comparisonData.monthlyChartData} currentYear={selectedYear} previousYear={selectedYear - 1} />
                </div>
            );
        };
        
        // ##################################################################
        // ### BREAKEVEN APP (START) ###
        // ##################################################################
        const BreakevenApp = ({ repairData, fuelData, evData }) => {
            // --- CONFIGURATIONS ---
            const EV_CONFIG = {
              'TT-19': { name: 'TT-19', price: 533930 },
              'TT-20': { name: 'TT-20', price: 1660000 },
              'TT-21': { name: 'TT-21', price: 1660000 },
              'TT-22': { name: 'TT-22', price: 1660000 },
              'TT-23': { name: 'TT-23', price: 1660000 },
            };
            const ICE_VEHICLES_FOR_COMPARISON = ['TT-02', 'TT-03', 'TT-06', 'TT-07', 'TT-08', 'TT-09', 'TT-10', 'TT-11', 'TT-12', 'TT-13', 'TT-15', 'TT-16', 'TT-17', 'TT-18'];

            // --- CALCULATIONS ---
            const iceBenchmarkCosts = useMemo(() => {
                if (!repairData || !fuelData?.supply) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const relevantRepairData = repairData.filter(item => ICE_VEHICLES_FOR_COMPARISON.includes(item['เบอร์รถ']));
                const relevantFuelData = fuelData.supply.filter(item => ICE_VEHICLES_FOR_COMPARISON.includes(item['เบอร์รถ']));

                const allData = [...relevantRepairData.map(i => i['วันที่แจ้งซ่อม(APP)']), ...relevantFuelData.map(i => i['วันที่'])];
                const validDates = allData.map(d => parseDate(d)).filter(Boolean);
                
                if (validDates.length < 2) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const minDate = new Date(Math.min.apply(null, validDates));
                const maxDate = new Date(Math.max.apply(null, validDates));
                const durationYears = (maxDate - minDate) / (1000 * 60 * 60 * 24 * 365.25);

                if (durationYears <= 0) return { totalRepairCost: 0, totalFuelCost: 0, avgAnnualCostPerVehicle: 0, durationYears: 0 };

                const totalRepairCost = relevantRepairData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                const totalFuelCost = relevantFuelData.reduce((sum, item) => sum + (Number(item['ราคาน้ำมัน']) || 0), 0);
                
                const totalFleetCost = totalRepairCost + totalFuelCost;
                const avgAnnualCostForFleet = totalFleetCost / durationYears;
                const avgAnnualCostPerVehicle = avgAnnualCostForFleet / ICE_VEHICLES_FOR_COMPARISON.length;

                return { totalRepairCost, totalFuelCost, avgAnnualCostPerVehicle, durationYears };
            }, [repairData, fuelData]);

            const evAnnualCosts = useMemo(() => {
                if (!repairData || !evData) return {};
                const EV_START_DATE = new Date('2025-08-01');
                const today = new Date(); // Use current date for calculation
                
                // Ensure we don't divide by zero or a tiny number if the app is run on the start date
                const timeDiff = today - EV_START_DATE;
                if (timeDiff <= 0) return {};
                
                const durationYears = timeDiff / (1000 * 60 * 60 * 24 * 365.25);

                const costs = {};
                Object.keys(EV_CONFIG).forEach(evPlate => {
                    const evRepairData = repairData.filter(item => item['เบอร์รถ'] === evPlate && parseDate(item['วันที่แจ้งซ่อม(APP)']) >= EV_START_DATE);
                    const totalRepairCost = evRepairData.reduce((sum, item) => sum + calculateTotalCost(item), 0);
                    
                    const evChargeData = evData.filter(item => item.licensePlate === evPlate);
                    const totalChargeCost = evChargeData.reduce((sum, item) => sum + (Number(item.electricityCost) || 0), 0);

                    const totalCost = totalRepairCost + totalChargeCost;
                    const annualCost = totalCost / durationYears;
                    costs[evPlate] = annualCost;
                });
                return costs;
            }, [repairData, evData]);

            const breakevenPoints = useMemo(() => {
                return Object.values(EV_CONFIG).map(ev => {
                    const initialCost = ev.price;
                    const evAnnualCost = evAnnualCosts[ev.name] || 0;
                    const iceAnnualCost = iceBenchmarkCosts.avgAnnualCostPerVehicle;
                    const annualSavings = iceAnnualCost - evAnnualCost;

                    if (annualSavings <= 0) {
                        return { ...ev, evAnnualCost, annualSavings, yearsToBreakeven: Infinity };
                    }
                    const yearsToBreakeven = initialCost / annualSavings;
                    return { ...ev, initialCost, evAnnualCost, annualSavings, yearsToBreakeven };
                });
            }, [EV_CONFIG, iceBenchmarkCosts, evAnnualCosts]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6 space-y-6">
                    <h2 className="text-xl font-bold text-gray-800">วิเคราะห์จุดคุ้มทุนรถยนต์ไฟฟ้า (EV Break-Even Analysis)</h2>
                    
                    {/* Costs Summary Section */}
                     <div className="p-4 border rounded-lg bg-blue-50">
                        <h3 className="font-semibold text-lg text-blue-800">ค่าใช้จ่ายเฉลี่ยของรถสันดาป (Benchmark)</h3>
                        <p className="text-sm text-blue-600 mb-2">
                            คำนวณจากค่าซ่อมและค่าเชื้อเพลิงย้อนหลัง {formatNumber(iceBenchmarkCosts.durationYears, 1)} ปี ของรถ {ICE_VEHICLES_FOR_COMPARISON.length} คัน
                        </p>
                        <div className="text-3xl font-bold text-blue-900">{formatPrice(iceBenchmarkCosts.avgAnnualCostPerVehicle)}</div>
                        <div className="text-md text-blue-700">บาท/คัน/ปี</div>
                    </div>

                    {/* Results Table */}
                    <div className="overflow-x-auto">
                        <h3 className="font-semibold text-lg text-slate-800 mb-2">ผลการวิเคราะห์จุดคุ้มทุน</h3>
                        <p className="text-sm text-slate-600 mb-3">
                            ตารางนี้แสดงระยะเวลาที่ส่วนต่างของค่าใช้จ่ายรายปี จะคุ้มทุนกับราคารถ EV ที่ลงทุนไป
                        </p>
                        <table className="w-full text-sm text-left text-gray-700 border-collapse">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th className="px-4 py-3 border">เบอร์รถ EV</th>
                                    <th className="px-4 py-3 border text-right">ราคารถ EV (บาท)</th>
                                    <th className="px-4 py-3 border text-right">ค่าใช้จ่าย EV ต่อปี (บาท)</th>
                                    <th className="px-4 py-3 border text-right">ประหยัดได้ต่อปี (บาท)</th>
                                    <th className="px-4 py-3 border text-right">ระยะเวลาคุ้มทุน (ปี)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {breakevenPoints.map(ev => (
                                    <tr key={ev.name} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-4 py-3 border font-medium">{ev.name}</td>
                                        <td className="px-4 py-3 border text-right">{formatPrice(ev.price)}</td>
                                        <td className="px-4 py-3 border text-right text-red-600">{formatPrice(ev.evAnnualCost)}</td>
                                        <td className={`px-4 py-3 border text-right font-semibold ${ev.annualSavings > 0 ? 'text-green-700' : 'text-red-700'}`}>{formatPrice(ev.annualSavings)}</td>
                                        <td className="px-4 py-3 border text-right font-bold text-indigo-700">
                                            {isFinite(ev.yearsToBreakeven) ? formatNumber(ev.yearsToBreakeven, 1) : 'ไม่คุ้มทุน'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        // ### BREAKEVEN APP (END) ###


        // ##################################################################
        // ### MAIN APP COMPONENT (คอมโพเนนต์หลัก) ###
        // ##################################################################
        const App = () => {
            const [activeApp, setActiveApp] = useState('repair'); // 'repair', 'fuel', 'ev', 'energy', 'ev_impact', 'breakeven', 'overview'
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const fetchDataFromScript = async () => {
                if (SCRIPT_URL === 'YOUR_CONSOLIDATED_WEB_APP_URL_HERE') {
                    setError('กรุณาตั้งค่า URL ของ Google Apps Script ในโค้ดก่อน');
                    setLoading(false);
                    return;
                }
                setLoading(true);
                setError(null);
                try {
                    // Initialize Firebase
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const auth = window.firebase.getAuth(app);
                    const db = window.firebase.getFirestore(app);

                    // Authenticate anonymously first
                    console.log('Attempting anonymous authentication...');
                    const userCredential = await window.firebase.signInAnonymously(auth);
                    console.log('Authentication successful:', userCredential.user.uid);

                    // Fetch from Google Sheet and Firebase in parallel
                    console.log('Fetching data from Google Sheet and Firestore...');
                    const [sheetResponse, historySnapshot] = await Promise.all([
                        fetch(SCRIPT_URL),
                        window.firebase.getDocs(window.firebase.query(
                            window.firebase.collection(db, `artifacts/tmtev-2025/history`),
                            window.firebase.orderBy("date", "desc")
                        )).catch(error => {
                            console.error('Firestore error:', error);
                            throw error;
                        })
                    ]);

                    if (!sheetResponse.ok) {
                        throw new Error(`Google Script fetch failed with status ${sheetResponse.status}`);
                    }
                    const sheetJson = await sheetResponse.json();
                    if (sheetJson.error) throw new Error(sheetJson.error);

                    const historyList = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    setData({
                        repairData: sheetJson.repairData,
                        fuelData: sheetJson.fuelData,
                        evData: historyList
                    });

                } catch (err) {
                    console.error("Error fetching data:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchDataFromScript();
            }, []);

            const renderActiveApp = () => {
                if (loading) return <Loader text="กำลังโหลดข้อมูลทั้งหมด..." />;
                if (error) return <div className="text-center p-8 text-red-600 bg-red-100 rounded-lg m-4"><strong>เกิดข้อผิดพลาด:</strong> {error}</div>;
                if (!data) return <div className="text-center p-8">ไม่พบข้อมูล</div>;

                switch (activeApp) {
                    case 'repair':
                        return <RepairApp data={data.repairData} isMobile={isMobile} />;
                    case 'fuel':
                        return <FuelApp data={data.fuelData} />;
                    case 'ev':
                        return <EVChargingApp data={data.evData} />;
                    case 'energy':
                        return <EnergyComparisonApp fuelData={data.fuelData} evData={data.evData} />;
                    case 'ev_impact':
                        return <EVImpactApp fuelData={data.fuelData} evData={data.evData} />;
                    case 'breakeven':
                        return <BreakevenApp repairData={data.repairData} fuelData={data.fuelData} evData={data.evData} />;
                    case 'overview':
                        return <OverviewApp repairData={data.repairData} fuelData={data.fuelData} evData={data.evData} />;
                    default:
                        return null;
                }
            };

            return (
                <div className="container mx-auto p-4 sm:p-6">
                    <header className="mb-6">
                        <div className="header-container flex flex-col items-center">
                            <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 text-center">รายงานค่าใช้จ่าย Material handling</h1>
                             <button type="button" className="refresh-button" onClick={fetchDataFromScript} disabled={loading}>
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                fill="currentColor"
                                className="bi bi-arrow-repeat"
                                viewBox="0 0 16 16"
                              >
                                <path
                                  d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                                ></path>
                                <path
                                  fillRule="evenodd"
                                  d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                                ></path>
                              </svg>
                              <span className="refresh-text">Refresh</span>
                            </button>
                        </div>
                        <nav className="main-nav-container mt-6 flex justify-center">
                            <div className="button-container">
                                <button title="แจ้งซ่อม" className={`nav-button ${activeApp === 'repair' ? 'active' : ''}`} onClick={() => setActiveApp('repair')}>
                                    <Icons name="toolbox" className="w-6 h-6" />
                                    <span className="nav-text">แจ้งซ่อม</span>
                                </button>
                                <button title="น้ำมัน" className={`nav-button ${activeApp === 'fuel' ? 'active' : ''}`} onClick={() => setActiveApp('fuel')}>
                                    <img src="https://img.icons8.com/?size=80&id=93a3SInn9e4L&format=png" alt="น้ำมัน" className="w-6 h-6" />
                                    <span className="nav-text">น้ำมัน</span>
                                </button>
                                <button title="ชาร์จไฟEV" className={`nav-button ${activeApp === 'ev' ? 'active' : ''}`} onClick={() => setActiveApp('ev')}>
                                    <Icons name="bolt" className="w-6 h-6" />
                                    <span className="nav-text">ชาร์จไฟEV</span>
                                </button>
                                <button title="เปรียบเทียบการใช้น้ำมัน" className={`nav-button ${activeApp === 'energy' ? 'active' : ''}`} onClick={() => setActiveApp('energy')}>
                                    <Icons name="balance" className="w-6 h-6" />
                                    <span className="nav-text">เปรียบเทียบ</span>
                                </button>
                                <button title="ผลการประหยัด EV" className={`nav-button ${activeApp === 'ev_impact' ? 'active' : ''}`} onClick={() => setActiveApp('ev_impact')}>
                                     <dotlottie-wc src="https://lottie.host/ddc40909-2718-4242-927f-e3fda3ac77ca/L8DWV25LrA.lottie" style={{width: '24px', height: '24px'}} speed="1" autoplay loop></dotlottie-wc>
                                    <span className="nav-text">แนวโน้มการใช้น้ำมัน</span>
                                </button>
                                <button title="จุดคุ้มทุน EV" className={`nav-button ${activeApp === 'breakeven' ? 'active' : ''}`} onClick={() => setActiveApp('breakeven')}>
                                     <Icons name="calculator" className="w-6 h-6" />
                                    <span className="nav-text">จุดคุ้มทุน EV</span>
                                </button>
                                <button title="ภาพรวม" className={`nav-button ${activeApp === 'overview' ? 'active' : ''}`} onClick={() => setActiveApp('overview')}>
                                    <Icons name="grid" className="w-6 h-6" />
                                    <span className="nav-text">ภาพรวม</span>
                                </button>
                            </div>
                        </nav>
                    </header>
                    <main>
                        {renderActiveApp()}
                    </main>
                </div>
            );
        };

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
